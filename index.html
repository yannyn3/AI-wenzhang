<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI文章创作室</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/dompurify@3.0.5/dist/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/turndown@7.1.2/dist/turndown.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        apple: {
                            blue: '#0071e3',
                            darkblue: '#0077ED',
                            gray: '#f5f5f7',
                            darkgray: '#1d1d1f',
                            midgray: '#86868b',
                            lightgray: '#f2f2f2'
                        }
                    },
                    fontFamily: {
                        apple: ['-apple-system', 'BlinkMacSystemFont', 'San Francisco', 'Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif']
                    },
                    borderRadius: {
                        'xl': '1rem',
                        '2xl': '1.5rem',
                    },
                    boxShadow: {
                        'apple': '0 4px 16px rgba(0, 0, 0, 0.12)',
                        'apple-dark': '0 4px 16px rgba(255, 255, 255, 0.08)'
                    },
                    backdropBlur: {
                        'apple': '20px'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        /* 基础样式 */
        body {
            font-family: 'Inter', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            scroll-behavior: smooth;
        }
        
        /* 苹果风格磨砂玻璃效果 */
        .apple-glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        .dark .apple-glass {
            background: rgba(30, 30, 32, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        /* 加载动画 */
        .apple-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(0, 113, 227, 0.3);
            border-radius: 50%;
            border-top-color: #0071e3;
            animation: spin 1s ease-in-out infinite;
        }
        
        .dark .apple-spinner {
            border: 2px solid rgba(0, 113, 227, 0.2);
            border-top-color: #0077ED;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 文章主题样式 */
        /* 现代简约风 */
        .theme-modern {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            line-height: 1.7;
            color: #333;
            letter-spacing: 0.01em;
            --accent-color: #0071e3;
            --accent-color-dark: #0077ED;
            --bg-light: #f8f9fa;
            --bg-dark: #1f1f1f;
        }
        
        .theme-modern h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            line-height: 1.3;
            letter-spacing: -0.01em;
            color: #222;
        }
        
        .theme-modern h2 {
            font-size: 1.6rem;
            font-weight: 600;
            margin-top: 2rem;
            margin-bottom: 1rem;
            color: var(--accent-color);
            letter-spacing: -0.01em;
        }
        
        .theme-modern p {
            margin-bottom: 1.2rem;
            font-size: 1rem;
            line-height: 1.8;
        }
        
        .theme-modern img {
            border-radius: 8px;
            margin: 1.5rem auto;
            display: block;
            max-width: 100%;
            height: auto;
        }
        
        .theme-modern blockquote {
            border-left: 4px solid var(--accent-color);
            padding: 1rem 1.2rem;
            background-color: var(--bg-light);
            margin: 1.8rem 0;
            border-radius: 0 8px 8px 0;
            font-size: 1.05rem;
        }
        
        .dark .theme-modern blockquote {
            background-color: var(--bg-dark);
            border-left-color: var(--accent-color-dark);
        }
        
        .theme-modern ul, .theme-modern ol {
            margin-bottom: 1.4rem;
            padding-left: 1.2rem;
        }
        
        .theme-modern ul li, .theme-modern ol li {
            margin-bottom: 0.6rem;
        }
        
        .theme-modern code {
            background-color: var(--bg-light);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'SF Mono', Menlo, monospace;
            font-size: 0.9em;
            color: var(--accent-color);
        }
        
        .dark .theme-modern code {
            background-color: var(--bg-dark);
            color: var(--accent-color-dark);
        }
        
        /* 杂志风格 */
        .theme-magazine {
            font-family: "Noto Serif SC", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Georgia, serif;
            line-height: 1.6;
            color: #222;
            --accent-color: #333;
            --accent-light: #666;
            --bg-light: #f7f7f7;
            --bg-dark: #2a2a2a;
        }
        
        .theme-magazine h1 {
            font-size: 2.4rem;
            font-weight: 800;
            margin-bottom: 1.5rem;
            line-height: 1.3;
            font-family: "Noto Sans SC", sans-serif;
            letter-spacing: -0.02em;
            text-align: center;
            position: relative;
            padding-bottom: 1rem;
        }
        
        .theme-magazine h1:after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background-color: var(--accent-color);
        }
        
        .dark .theme-magazine h1:after {
            background-color: #f0f0f0;
        }
        
        .theme-magazine h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 2.5rem;
            margin-bottom: 1.2rem;
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 0.5rem;
        }
        
        .dark .theme-magazine h2 {
            border-bottom-color: #666;
        }
        
        .theme-magazine h3 {
            font-size: 1.6rem;
            font-weight: 600;
            margin-top: 2rem;
            margin-bottom: 1.2rem;
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            color: var(--accent-light);
        }
        
        .dark .theme-magazine h3 {
            color: #aaa;
        }
        
        .theme-magazine p {
            margin-bottom: 1.5rem;
            font-size: 1.15rem;
            line-height: 1.9;
        }
        
        .theme-magazine p:first-of-type::first-letter {
            font-size: 3.5rem;
            float: left;
            line-height: 0.8;
            margin-right: 0.5rem;
            font-weight: bold;
            color: var(--accent-color);
        }
        
        .dark .theme-magazine p:first-of-type::first-letter {
            color: #f0f0f0;
        }
        
        .theme-magazine img {
            margin: 2.5rem 0;
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
            width: 100%;
            border-radius: 4px;
            transition: transform 0.3s ease;
        }
        
        .theme-magazine img:hover {
            transform: scale(1.02);
        }
        
        .dark .theme-magazine img {
            box-shadow: 0 12px 30px rgba(0,0,0,0.4);
        }
        
        .theme-magazine blockquote {
            font-style: italic;
            padding: 1.5rem 2rem;
            background-color: var(--bg-light);
            margin: 2rem 0;
            border-radius: 8px;
            position: relative;
            font-size: 1.2rem;
            line-height: 1.8;
        }
        
        .dark .theme-magazine blockquote {
            background-color: var(--bg-dark);
        }
        
        .theme-magazine blockquote::before {
            content: """;
            font-size: 5rem;
            position: absolute;
            left: 10px;
            top: -20px;
            color: var(--accent-light);
            font-family: Georgia, serif;
        }
        
        .theme-magazine ul, .theme-magazine ol {
            margin-bottom: 1.5rem;
            padding-left: 1.5rem;
        }
        
        .theme-magazine ul li, .theme-magazine ol li {
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
        }
        
        /* 科技风格 */
        .theme-tech {
            font-family: 'SF Pro Display', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.7;
            color: #333;
            --primary: #0071e3;
            --primary-dark: #0077ED;
            --secondary: #00c6fb;
            --bg-light: rgba(0,113,227,0.05);
            --bg-dark: rgba(0,119,237,0.15);
            --text-dark: #333;
            --text-light: #e0e0e0;
        }
        
        .dark .theme-tech {
            color: var(--text-light);
        }
        
        .theme-tech h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1.8rem;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.3;
            letter-spacing: -0.02em;
        }
        
        .theme-tech h2 {
            font-size: 1.9rem;
            font-weight: 600;
            margin-top: 2.2rem;
            margin-bottom: 1.2rem;
            color: var(--primary);
            letter-spacing: -0.01em;
            position: relative;
            padding-left: 1rem;
        }
        
        .theme-tech h2::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0.2rem;
            height: 80%;
            width: 4px;
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
            border-radius: 2px;
        }
        
        .dark .theme-tech h2 {
            color: var(--primary-dark);
        }
        
        .theme-tech h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 1.8rem;
            margin-bottom: 1.2rem;
            color: #444;
            letter-spacing: -0.01em;
        }
        
        .dark .theme-tech h3 {
            color: #ccc;
        }
        
        .theme-tech p {
            margin-bottom: 1.4rem;
            font-size: 1.05rem;
            line-height: 1.8;
        }
        
        .theme-tech img {
            border-radius: 12px;
            margin: 2rem 0;
            box-shadow: 0 10px 30px rgba(0,113,227,0.2);
            border: 1px solid rgba(0,0,0,0.1);
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .theme-tech img:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,113,227,0.3);
        }
        
        .dark .theme-tech img {
            box-shadow: 0 10px 30px rgba(0,119,237,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .theme-tech blockquote {
            border-left: 4px solid var(--primary);
            padding: 1.2rem 1.5rem;
            background-color: var(--bg-light);
            margin: 1.8rem 0;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .theme-tech blockquote::after {
            content: "";
            position: absolute;
            right: -20px;
            bottom: -20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), transparent);
            opacity: 0.2;
            border-radius: 50%;
        }
        
        .dark .theme-tech blockquote {
            background-color: var(--bg-dark);
            border-left-color: var(--primary-dark);
        }
        
        .theme-tech code {
            background-color: #f0f0f0;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'SF Mono', Menlo, monospace;
            font-size: 0.9em;
            color: var(--primary);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .dark .theme-tech code {
            background-color: #2a2a2a;
            color: var(--primary-dark);
            border-color: rgba(255,255,255,0.1);
        }
        
        .theme-tech ul, .theme-tech ol {
            margin-bottom: 1.4rem;
            padding-left: 1.2rem;
        }
        
        .theme-tech ul li, .theme-tech ol li {
            margin-bottom: 0.7rem;
            position: relative;
        }
        
        /* 优雅商务风 */
        .theme-business {
            font-family: 'Georgia', 'Noto Sans SC', serif;
            line-height: 1.6;
            color: #333;
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --border-light: #eee;
            --border-dark: #555;
            --bg-light: rgba(0,0,0,0.02);
            --bg-dark: rgba(255,255,255,0.05);
        }
        
        .dark .theme-business {
            color: #e0e0e0;
        }
        
        .theme-business h1 {
            font-size: 2.6rem;
            font-weight: 700;
            margin-bottom: 1.8rem;
            color: var(--primary);
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 0.8rem;
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            letter-spacing: -0.01em;
        }
        
        .dark .theme-business h1 {
            color: #e0e0e0;
            border-bottom-color: var(--border-dark);
        }
        
        .theme-business h2 {
            font-size: 1.9rem;
            font-weight: 600;
            margin-top: 2.2rem;
            margin-bottom: 1.2rem;
            color: var(--primary);
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            position: relative;
            padding-bottom: 0.5rem;
        }
        
        .theme-business h2:after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 2px;
            background-color: var(--accent);
        }
        
        .dark .theme-business h2 {
            color: #e0e0e0;
        }
        
        .theme-business h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 1.8rem;
            margin-bottom: 1.2rem;
            color: var(--secondary);
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
        }
        
        .dark .theme-business h3 {
            color: #ccc;
        }
        
        .theme-business p {
            margin-bottom: 1.4rem;
            font-size: 1.1rem;
            line-height: 1.9;
        }
        
        .theme-business img {
            border-radius: 6px;
            margin: 2rem 0;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .theme-business img:hover {
            box-shadow: 0 12px 25px rgba(0,0,0,0.15);
        }
        
        .dark .theme-business img {
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .theme-business blockquote {
            border-left: 3px solid var(--accent);
            padding: 1.2rem 1.5rem;
            background-color: var(--bg-light);
            margin: 1.8rem 0;
            font-style: italic;
            border-radius: 0 6px 6px 0;
        }
        
        .dark .theme-business blockquote {
            background-color: var(--bg-dark);
        }
        
        .theme-business ul, .theme-business ol {
            margin-bottom: 1.5rem;
            padding-left: 1.5rem;
        }
        
        .theme-business ul li, .theme-business ol li {
            margin-bottom: 0.8rem;
            line-height: 1.7;
        }
        
        .theme-business table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
            font-size: 1rem;
        }
        
        .theme-business th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            text-align: left;
            padding: 0.8rem 1rem;
        }
        
        .theme-business td {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid var(--border-light);
        }
        
        .dark .theme-business td {
            border-bottom-color: var(--border-dark);
        }
        
        .theme-business tr:nth-child(even) {
            background-color: var(--bg-light);
        }
        
        .dark .theme-business tr:nth-child(even) {
            background-color: var(--bg-dark);
        }
        
        /* 创意设计风 */
        .theme-creative {
            font-family: 'Montserrat', 'Avenir Next', 'Noto Sans SC', sans-serif;
            line-height: 1.7;
            color: #333;
            --primary: #ff3366;
            --primary-dark: #ff4d7d;
            --bg-light: rgba(255,51,102,0.05);
            --bg-dark: rgba(255,77,125,0.1);
            --accent-light: rgba(255,51,102,0.3);
            --accent-dark: rgba(255,77,125,0.3);
        }
        
        .dark .theme-creative {
            color: #f0f0f0;
        }
        
        .theme-creative h1 {
            font-size: 2.8rem;
            font-weight: 800;
            margin-bottom: 2rem;
            color: var(--primary);
            line-height: 1.2;
            letter-spacing: -0.02em;
            position: relative;
            display: inline-block;
        }
        
        .theme-creative h1:after {
            content: "";
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, var(--primary), transparent);
            border-radius: 3px;
        }
        
        .dark .theme-creative h1 {
            color: var(--primary-dark);
        }
        
        .dark .theme-creative h1:after {
            background: linear-gradient(90deg, var(--primary-dark), transparent);
        }
        
        .theme-creative h2 {
            font-size: 2.1rem;
            font-weight: 700;
            margin-top: 2.8rem;
            margin-bottom: 1.5rem;
            color: var(--primary);
            border-bottom: 2px dashed var(--accent-light);
            padding-bottom: 0.5rem;
            display: inline-block;
        }
        
        .dark .theme-creative h2 {
            color: var(--primary-dark);
            border-bottom-color: var(--accent-dark);
        }
        
        .theme-creative h3 {
            font-size: 1.6rem;
            font-weight: 600;
            margin-top: 2rem;
            margin-bottom: 1.2rem;
            color: #555;
            position: relative;
            padding-left: 1.2rem;
        }
        
        .theme-creative h3:before {
            content: "●";
            position: absolute;
            left: 0;
            color: var(--primary);
            font-size: 0.8em;
        }
        
        .dark .theme-creative h3 {
            color: #ddd;
        }
        
        .dark .theme-creative h3:before {
            color: var(--primary-dark);
        }
        
        .theme-creative p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            line-height: 1.9;
        }
        
        .theme-creative img {
            border-radius: 20px;
            margin: 2.5rem auto;
            display: block;
            box-shadow: 0 15px 35px rgba(255,51,102,0.2);
            border: 3px solid white;
            width: 100%;
            transition: all 0.4s ease;
        }
        
        .theme-creative img:hover {
            transform: translateY(-8px) scale(1.01);
            box-shadow: 0 20px 40px rgba(255,51,102,0.25);
        }
        
        .dark .theme-creative img {
            box-shadow: 0 15px 35px rgba(255,77,125,0.25);
            border-color: #333;
        }
        
        .theme-creative blockquote {
            border: none;
            padding: 2rem;
            background-color: var(--bg-light);
            margin: 2rem 0;
            border-radius: 15px;
            position: relative;
            font-size: 1.1rem;
            line-height: 1.8;
        }
        
        .dark .theme-creative blockquote {
            background-color: var(--bg-dark);
        }
        
        .theme-creative blockquote::before {
            content: """;
            font-size: 5rem;
            position: absolute;
            left: 10px;
            top: -20px;
            color: var(--accent-light);
            font-family: Georgia, serif;
        }
        
        .dark .theme-creative blockquote::before {
            color: var(--accent-dark);
        }
        
        .theme-creative ul, .theme-creative ol {
            margin-bottom: 1.5rem;
            padding-left: 1.5rem;
        }
        
        .theme-creative ul li, .theme-creative ol li {
            margin-bottom: 0.8rem;
            position: relative;
            padding-left: 0.5rem;
        }
        
        .theme-creative ul li::marker {
            color: var(--primary);
            font-size: 1.2em;
        }
        
        .dark .theme-creative ul li::marker {
            color: var(--primary-dark);
        }
        
        /* 学术论文风 */
        .theme-academic {
            font-family: 'Times New Roman', Times, 'Noto Sans SC', serif;
            line-height: 1.6;
            color: #222;
            --primary: #333;
            --primary-dark: #eee;
            --secondary: #444;
            --secondary-dark: #ccc;
            --border-light: #ddd;
            --border-dark: #555;
            --bg-light: rgba(0,0,0,0.03);
            --bg-dark: rgba(255,255,255,0.03);
        }
        
        .dark .theme-academic {
            color: var(--primary-dark);
        }
        
        .theme-academic h1 {
            font-size: 2.4rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: center;
            font-family: 'Palatino Linotype', 'Book Antiqua', 'Noto Sans SC', serif;
            letter-spacing: -0.01em;
        }
        
        .theme-academic h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-top: 2.2rem;
            margin-bottom: 1.2rem;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 0.5rem;
            counter-increment: h2counter;
        }
        
        .theme-academic h2::before {
            content: counter(h2counter) ". ";
            color: var(--secondary);
        }
        
        .dark .theme-academic h2 {
            border-bottom-color: var(--border-dark);
        }
        
        .dark .theme-academic h2::before {
            color: var(--secondary-dark);
        }
        
        .theme-academic h3 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-top: 1.8rem;
            margin-bottom: 1rem;
            font-style: italic;
            counter-increment: h3counter;
        }
        
        .theme-academic h3::before {
            content: counter(h2counter) "." counter(h3counter) " ";
            color: var(--secondary);
            font-style: normal;
        }
        
        .dark .theme-academic h3::before {
            color: var(--secondary-dark);
        }
        
        .theme-academic p {
            margin-bottom: 1.2rem;
            font-size: 1.1rem;
            text-align: justify;
            text-indent: 2em;
            line-height: 1.8;
        }
        
        .theme-academic p:first-of-type {
            text-indent: 0;
        }
        
        .theme-academic img {
            margin: 2rem auto;
            display: block;
            max-width: 90%;
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }
        
        .theme-academic img:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .dark .theme-academic img {
            border-color: var(--border-dark);
        }
        
        .dark .theme-academic img:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .theme-academic blockquote {
            border-left: 3px solid var(--secondary);
            padding: 1rem 1.2rem;
            background-color: var(--bg-light);
            margin: 1.8rem 0;
            font-size: 1rem;
            line-height: 1.7;
            font-style: italic;
        }
        
        .dark .theme-academic blockquote {
            background-color: var(--bg-dark);
            border-left-color: var(--secondary-dark);
        }
        
        .theme-academic table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
            font-size: 1rem;
            border: 1px solid var(--border-light);
        }
        
        .theme-academic th {
            background-color: var(--bg-light);
            font-weight: 700;
            text-align: left;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-light);
        }
        
        .theme-academic td {
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-light);
        }
        
        .dark .theme-academic th,
        .dark .theme-academic td {
            border-color: var(--border-dark);
        }
        
        .dark .theme-academic th {
            background-color: var(--bg-dark);
        }
        
        .theme-academic figcaption {
            text-align: center;
            font-size: 0.9rem;
            font-style: italic;
            margin-top: 0.5rem;
            color: var(--secondary);
        }
        
        .dark .theme-academic figcaption {
            color: var(--secondary-dark);
        }
        
        /* 自媒体风格 */
        .theme-media {
            font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Noto Sans SC', sans-serif;
            line-height: 1.8;
            color: #333;
            letter-spacing: 0.5px;
            --primary: #07C160;
            --primary-dark: #07C160;
            --secondary: #333;
            --secondary-dark: #fff;
            --bg-light: #f2f7f2;
            --bg-dark: #2a3a2a;
            --border-light: #e0e0e0;
            --border-dark: #444;
        }
        
        .dark .theme-media {
            color: #eee;
        }
        
        .theme-media h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1.2rem;
            text-align: center;
            line-height: 1.4;
            color: var(--secondary);
            position: relative;
            padding-bottom: 1rem;
        }
        
        .theme-media h1:after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background-color: var(--primary);
            border-radius: 2px;
        }
        
        .dark .theme-media h1 {
            color: var(--secondary-dark);
        }
        
        .theme-media h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 2.2rem 0 1.2rem;
            padding-left: 1rem;
            border-left: 4px solid var(--primary);
            line-height: 1.4;
            position: relative;
            background-color: rgba(7,193,96,0.05);
            padding: 0.8rem 1rem;
            border-radius: 0 4px 4px 0;
        }
        
        .dark .theme-media h2 {
            border-left-color: var(--primary-dark);
            background-color: rgba(7,193,96,0.1);
        }
        
        .theme-media h3 {
            font-size: 1.4rem;
            font-weight: 600;
            margin: 1.8rem 0 1.2rem;
            color: var(--primary);
            display: inline-block;
            position: relative;
        }
        
        .theme-media h3:after {
            content: "";
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 100%;
            height: 1px;
            background-color: var(--primary);
            opacity: 0.3;
        }
        
        .dark .theme-media h3 {
            color: var(--primary-dark);
        }
        
        .theme-media p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            line-height: 1.9;
            letter-spacing: 0.01em;
        }
        
        .theme-media img {
            border-radius: 12px;
            margin: 2rem auto;
            display: block;
            width: 100%;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .theme-media img:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.15);
        }
        
        .dark .theme-media img {
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        .theme-media blockquote {
            margin: 2rem 0;
            padding: 1.2rem 1.5rem;
            background-color: var(--bg-light);
            border-radius: 8px;
            font-size: 1.05rem;
            color: #555;
            line-height: 1.8;
            border-left: 4px solid var(--primary);
            position: relative;
        }
        
        .theme-media blockquote:before {
            content: '💡';
            position: absolute;
            left: -12px;
            top: -12px;
            background: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        .dark .theme-media blockquote {
            background-color: var(--bg-dark);
            color: #ccc;
        }
        
        .dark .theme-media blockquote:before {
            background: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .theme-media ul, .theme-media ol {
            margin-bottom: 1.5rem;
            padding-left: 1.5rem;
        }
        
        .theme-media ul li, .theme-media ol li {
            margin-bottom: 0.8rem;
            position: relative;
        }
        
        .theme-media ul li::marker {
            color: var(--primary);
        }
        
        .theme-media strong {
            color: var(--primary);
            font-weight: 600;
            padding: 0 2px;
        }
        
        .dark .theme-media strong {
            color: var(--primary-dark);
        }
        
        .theme-media .highlight {
            background-color: rgba(7,193,96,0.1);
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .theme-media .card {
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            background-color: white;
        }
        
        .dark .theme-media .card {
            border-color: var(--border-dark);
            background-color: #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* 娱乐风格 */
        .theme-entertainment {
            font-family: 'Comic Sans MS', 'Noto Sans SC', sans-serif;
            line-height: 1.7;
            color: #333;
            letter-spacing: 0.5px;
        }
        
        .dark .theme-entertainment {
            color: #f0f0f0;
        }
        
        .theme-entertainment h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1.2rem;
            color: #FF6B6B;
            text-align: center;
            text-shadow: 2px 2px 0px rgba(255,107,107,0.2);
        }
        
        .dark .theme-entertainment h1 {
            color: #FF8585;
            text-shadow: 2px 2px 0px rgba(255,133,133,0.3);
        }
        
        .theme-entertainment h2 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-top: 2rem;
            margin-bottom: 1rem;
            color: #FF6B6B;
            border-bottom: 2px dotted #FFD166;
            padding-bottom: 0.3rem;
            display: inline-block;
        }
        
        .dark .theme-entertainment h2 {
            color: #FF8585;
            border-bottom-color: #FFE066;
        }
        
        .theme-entertainment h3 {
            font-size: 1.4rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            color: #4ECDC4;
        }
        
        .dark .theme-entertainment h3 {
            color: #6EE7DF;
        }
        
        .theme-entertainment p {
            margin-bottom: 1.2rem;
            font-size: 1.1rem;
            line-height: 1.8;
        }
        
        .theme-entertainment img {
            border-radius: 15px;
            margin: 1.5rem auto;
            display: block;
            max-width: 100%;
            box-shadow: 0 8px 20px rgba(255,107,107,0.2);
            border: 3px solid #FFD166;
            transform: rotate(-1deg);
        }
        
        .dark .theme-entertainment img {
            box-shadow: 0 8px 20px rgba(255,133,133,0.3);
            border-color: #FFE066;
        }
        
        .theme-entertainment blockquote {
            margin: 1.5rem 0;
            padding: 1.2rem;
            background-color: #FFF5E6;
            border-radius: 12px;
            font-size: 1.05rem;
            color: #555;
            line-height: 1.7;
            border-left: 4px solid #FFD166;
        }
        
        .dark .theme-entertainment blockquote {
            background-color: #3A3530;
            color: #ddd;
            border-left-color: #FFE066;
        }
        
        .theme-entertainment ul, .theme-entertainment ol {
            margin-bottom: 1.2rem;
            padding-left: 2rem;
        }
        
        .theme-entertainment ul li, .theme-entertainment ol li {
            margin-bottom: 0.5rem;
            position: relative;
        }
        
        .theme-entertainment ul li::before {
            content: "✨";
            position: absolute;
            left: -1.5rem;
        }
        
        .theme-entertainment strong {
            color: #FF6B6B;
            font-weight: 600;
        }
        
        .dark .theme-entertainment strong {
            color: #FF8585;
        }
        
        /* 热点风格 */
        .theme-trending {
            font-family: 'PingFang SC', 'Helvetica Neue', 'Noto Sans SC', sans-serif;
            line-height: 1.7;
            color: #333;
        }
        
        .dark .theme-trending {
            color: #f0f0f0;
        }
        
        .theme-trending h1 {
            font-size: 2.4rem;
            font-weight: 800;
            margin-bottom: 1rem;
            color: #E63946;
            line-height: 1.3;
            border-bottom: 3px solid #E63946;
            padding-bottom: 0.5rem;
        }
        
        .dark .theme-trending h1 {
            color: #F94759;
            border-bottom-color: #F94759;
        }
        
        .theme-trending h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-top: 2rem;
            margin-bottom: 1rem;
            color: #E63946;
            background-color: #F1FAEE;
            padding: 0.5rem 1rem;
            border-radius: 4px;
        }
        
        .dark .theme-trending h2 {
            color: #F94759;
            background-color: #2A3A2F;
        }
        
        .theme-trending h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            color: #1D3557;
            border-left: 4px solid #E63946;
            padding-left: 0.8rem;
        }
        
        .dark .theme-trending h3 {
            color: #A8DADC;
            border-left-color: #F94759;
        }
        
        .theme-trending p {
            margin-bottom: 1.2rem;
            font-size: 1.1rem;
            line-height: 1.8;
        }
        
        .theme-trending img {
            border-radius: 8px;
            margin: 1.5rem auto;
            display: block;
            max-width: 100%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .dark .theme-trending img {
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .theme-trending blockquote {
            margin: 1.5rem 0;
            padding: 1rem 1.2rem;
            background-color: #F1FAEE;
            border-left: 5px solid #E63946;
            border-radius: 4px;
            font-size: 1.05rem;
            color: #1D3557;
            line-height: 1.7;
        }
        
        .dark .theme-trending blockquote {
            background-color: #2A3A2F;
            color: #A8DADC;
            border-left-color: #F94759;
        }
        
        .theme-trending ul, .theme-trending ol {
            margin-bottom: 1.2rem;
            padding-left: 1.5rem;
        }
        
        .theme-trending ul li, .theme-trending ol li {
            margin-bottom: 0.8rem;
            padding-left: 0.5rem;
        }
        
        .theme-trending strong {
            color: #E63946;
            font-weight: 700;
            background-color: rgba(230, 57, 70, 0.1);
            padding: 0 0.3rem;
            border-radius: 3px;
        }
        
        .dark .theme-trending strong {
            color: #F94759;
            background-color: rgba(249, 71, 89, 0.2);
        }
        
        /* 代码科技风格 */
        .theme-code-tech {
            font-family: 'JetBrains Mono', 'Fira Code', 'Noto Sans SC', monospace;
            line-height: 1.6;
            color: #2E3440;
            background-color: #ECEFF4;
            padding: 1rem;
            border-radius: 8px;
        }
        
        .dark .theme-code-tech {
            color: #ECEFF4;
            background-color: #2E3440;
        }
        
        .theme-code-tech h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #81A1C1;
            border-bottom: 2px solid #81A1C1;
            padding-bottom: 0.5rem;
        }
        
        .dark .theme-code-tech h1 {
            color: #88C0D0;
            border-bottom-color: #88C0D0;
        }
        
        .theme-code-tech h2 {
            font-size: 1.7rem;
            font-weight: 600;
            margin-top: 2rem;
            margin-bottom: 1rem;
            color: #5E81AC;
            padding-left: 1rem;
            border-left: 3px solid #5E81AC;
        }
        
        .dark .theme-code-tech h2 {
            color: #81A1C1;
            border-left-color: #81A1C1;
        }
        
        .theme-code-tech h3 {
            font-size: 1.4rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            color: #B48EAD;
        }
        
        .dark .theme-code-tech h3 {
            color: #B48EAD;
        }
        
        .theme-code-tech p {
            margin-bottom: 1.2rem;
            font-size: 1rem;
            line-height: 1.7;
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
        }
        
        .theme-code-tech img {
            border-radius: 4px;
            margin: 1.5rem auto;
            display: block;
            max-width: 100%;
            border: 1px solid #D8DEE9;
        }
        
        .dark .theme-code-tech img {
            border-color: #4C566A;
        }
        
        .theme-code-tech blockquote {
            margin: 1.5rem 0;
            padding: 1rem 1.2rem;
            background-color: #E5E9F0;
            border-left: 3px solid #5E81AC;
            border-radius: 4px;
            font-size: 0.95rem;
            color: #434C5E;
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
        }
        
        .dark .theme-code-tech blockquote {
            background-color: #3B4252;
            color: #D8DEE9;
            border-left-color: #81A1C1;
        }
        
        .theme-code-tech code {
            background-color: #D8DEE9;
            color: #BF616A;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.9em;
        }
        
        .dark .theme-code-tech code {
            background-color: #3B4252;
            color: #BF616A;
        }
        
        .theme-code-tech pre {
            background-color: #D8DEE9;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            margin: 1.5rem 0;
        }
        
        .dark .theme-code-tech pre {
            background-color: #3B4252;
        }
        
        .theme-code-tech pre code {
            background-color: transparent;
            padding: 0;
            color: #2E3440;
        }
        
        .dark .theme-code-tech pre code {
            color: #ECEFF4;
        }
        
        .theme-code-tech ul, .theme-code-tech ol {
            margin-bottom: 1.2rem;
            padding-left: 1.5rem;
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
        }
        
        .theme-code-tech ul li, .theme-code-tech ol li {
            margin-bottom: 0.5rem;
        }
        
        .theme-code-tech strong {
            color: #5E81AC;
            font-weight: 600;
        }
        
        .dark .theme-code-tech strong {
            color: #88C0D0;
        }
        
        /* 微信公众号特定样式 */
        .wechat-compatible {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            color: #333;
            line-height: 1.7;
            letter-spacing: 0.01em;
        }
        
        .wechat-compatible h1 {
            font-size: 24px;
            font-weight: bold;
            color: #222;
            margin: 20px 0 15px;
            line-height: 1.4;
        }
        
        .wechat-compatible h2 {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin: 15px 0 10px;
            line-height: 1.4;
        }
        
        .wechat-compatible h3 {
            font-size: 18px;
            font-weight: bold;
            color: #444;
            margin: 15px 0 10px;
            line-height: 1.4;
        }
        
        .wechat-compatible p {
            font-size: 16px;
            line-height: 1.8;
            margin: 10px 0;
            color: #333;
        }
        
        .wechat-compatible img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 15px auto;
            border-radius: 4px;
        }
        
        .wechat-compatible blockquote {
            padding: 10px 15px;
            border-left: 4px solid #eee;
            background-color: #f9f9f9;
            margin: 10px 0;
            color: #666;
            font-size: 15px;
            line-height: 1.7;
        }
        
        .wechat-compatible ul, .wechat-compatible ol {
            padding-left: 20px;
            margin: 10px 0;
        }
        
        .wechat-compatible li {
            font-size: 16px;
            line-height: 1.8;
            margin: 5px 0;
            color: #333;
        }

        /* 微信公众号专用模板 */
        .theme-wechat {
            /* 删除此部分 */
        }
    </style>
</head>
<body class="min-h-screen bg-apple-gray dark:bg-apple-darkgray text-black dark:text-white font-apple transition-colors duration-300">
    <div class="container mx-auto p-4 max-w-6xl">
        <!-- 标题区 -->
        <header class="text-center py-8 mb-8">
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-apple-blue to-purple-500 inline-block text-transparent bg-clip-text">
                AI 文章创作室
            </h1>
            <p class="text-apple-midgray dark:text-gray-400 text-lg">使用先进AI技术，创造专业精美的内容</p>
        </header>

        <!-- 主内容区 -->
        <main class="space-y-8">
            <!-- 标签式导航 -->
            <div id="app-tabs" class="flex justify-center mb-6">
                <nav class="flex space-x-2 bg-white dark:bg-apple-darkgray rounded-xl p-1 shadow-sm">
                    <button class="tab-button active px-4 py-2 rounded-lg text-sm font-medium" data-tab="content">
                        <i class="fas fa-pen-fancy mr-2"></i>内容创作
                    </button>
                    <button class="tab-button px-4 py-2 rounded-lg text-sm font-medium" data-tab="api">
                        <i class="fas fa-cog mr-2"></i>API配置
                    </button>
                    <button class="tab-button px-4 py-2 rounded-lg text-sm font-medium" data-tab="preview">
                        <i class="fas fa-eye mr-2"></i>预览排版
                    </button>
                    <button class="tab-button px-4 py-2 rounded-lg text-sm font-medium" data-tab="history">
                        <i class="fas fa-history mr-2"></i>历史文章
                    </button>
                </nav>
            </div>

            <!-- 内容创作面板 -->
            <div id="content-tab" class="tab-content">
                <section class="bg-white dark:bg-gray-900 rounded-2xl shadow-apple dark:shadow-apple-dark p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-file-alt mr-2 text-apple-blue dark:text-apple-darkblue"></i>
                        文章信息
                    </h2>
                    
                    <div class="mb-4">
                        <label for="articleTitle" class="block mb-2 font-medium text-gray-700 dark:text-gray-300">文章标题</label>
                        <input type="text" id="articleTitle" placeholder="输入引人注目的标题..." 
                            class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                    </div>
                    
                    <div class="mb-4">
                        <label for="articlePrompt" class="block mb-2 font-medium text-gray-700 dark:text-gray-300">文章提示词</label>
                        <textarea id="articlePrompt" rows="3" placeholder="描述您希望生成的文章风格、内容、结构等..." 
                            class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block mb-2 font-medium text-gray-700 dark:text-gray-300">文章长度</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="inline-flex items-center px-3 py-2 bg-apple-lightgray dark:bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                                    <input type="radio" name="articleLength" value="short" class="hidden peer" checked>
                                    <div class="w-4 h-4 mr-2 rounded-full border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center peer-checked:border-apple-blue dark:peer-checked:border-apple-darkblue">
                                        <div class="w-2 h-2 rounded-full bg-apple-blue dark:bg-apple-darkblue hidden peer-checked:block"></div>
                                    </div>
                                    <span>短文 (800-1200字)</span>
                                </label>
                                <label class="inline-flex items-center px-3 py-2 bg-apple-lightgray dark:bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                                    <input type="radio" name="articleLength" value="medium" class="hidden peer">
                                    <div class="w-4 h-4 mr-2 rounded-full border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center peer-checked:border-apple-blue dark:peer-checked:border-apple-darkblue">
                                        <div class="w-2 h-2 rounded-full bg-apple-blue dark:bg-apple-darkblue hidden peer-checked:block"></div>
                                    </div>
                                    <span>中等 (1500-2500字)</span>
                                </label>
                                <label class="inline-flex items-center px-3 py-2 bg-apple-lightgray dark:bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                                    <input type="radio" name="articleLength" value="long" class="hidden peer">
                                    <div class="w-4 h-4 mr-2 rounded-full border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center peer-checked:border-apple-blue dark:peer-checked:border-apple-darkblue">
                                        <div class="w-2 h-2 rounded-full bg-apple-blue dark:bg-apple-darkblue hidden peer-checked:block"></div>
                                    </div>
                                    <span>长文 (3000字以上)</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block mb-2 font-medium text-gray-700 dark:text-gray-300">排版主题</label>
                            <select id="articleTheme" class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                <option value="wechat">微信公众号专用</option>
                                <option value="modern">现代简约风</option>
                                <option value="magazine">杂志排版风</option>
                                <option value="tech">科技风格</option>
                                <option value="business">优雅商务风</option>
                                <option value="creative">创意设计风</option>
                                <option value="academic">学术论文风</option>
                                <option value="media">自媒体风格</option>
                                <option value="entertainment">娱乐风格</option>
                                <option value="trending">热点风格</option>
                                <option value="code-tech">代码科技风格</option>
                            </select>
                        </div>
                    </div>
                </section>

                <section class="bg-white dark:bg-gray-900 rounded-2xl shadow-apple dark:shadow-apple-dark p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-book mr-2 text-apple-blue dark:text-apple-darkblue"></i>
                        参考资料
                    </h2>
                    
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label for="referenceLinks" class="font-medium text-gray-700 dark:text-gray-300">参考链接 (每行一个)</label>
                            <button id="validateLinksBtn" class="text-xs text-apple-blue dark:text-apple-darkblue hover:underline flex items-center">
                                <i class="fas fa-check-circle mr-1"></i>验证链接
                            </button>
                        </div>
                        <textarea id="referenceLinks" rows="2" placeholder="https://example.com/article1&#10;https://example.com/article2" 
                            class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition"></textarea>
                        <div id="linkValidationResult" class="mt-1 hidden"></div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="referenceText" class="block mb-2 font-medium text-gray-700 dark:text-gray-300">参考文本</label>
                        <textarea id="referenceText" rows="4" placeholder="粘贴参考文章文本..." 
                            class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition"></textarea>
                    </div>

                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="font-medium text-gray-700 dark:text-gray-300">网页导入工具</label>
                            <div class="flex gap-2">
                                <button id="fetchContentBtn" class="text-xs text-apple-blue dark:text-apple-darkblue hover:underline flex items-center">
                                    <i class="fas fa-download mr-1"></i>抓取内容
                                </button>
                                <span class="text-gray-400">|</span>
                                <button id="clearResultsBtn" class="text-xs text-red-500 hover:underline flex items-center">
                                    <i class="fas fa-trash mr-1"></i>清空结果
                                </button>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="scrapeUrl" placeholder="输入要抓取的网页URL" 
                                class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                        </div>
                        <div id="scrapeResult" class="mt-2 hidden p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 max-h-40 overflow-auto"></div>
                    </div>
                    
                    <div class="mb-2">
                        <label class="block mb-2 font-medium text-gray-700 dark:text-gray-300">参考文件</label>
                        <label for="referenceFiles" class="w-full flex items-center justify-center p-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl cursor-pointer hover:bg-apple-lightgray dark:hover:bg-gray-800 transition">
                            <div class="text-center">
                                <i class="fas fa-cloud-upload-alt text-xl text-apple-blue dark:text-apple-darkblue mb-2"></i>
                                <p class="text-sm text-gray-600 dark:text-gray-400">点击上传文件或拖拽文件到此处</p>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">支持 .txt, .docx, .pdf 等文本文件</p>
                            </div>
                            <input id="referenceFiles" type="file" multiple class="hidden">
                        </label>
                        <div id="uploadedFiles" class="mt-2 space-y-1 text-sm"></div>
                    </div>
                </section>

                <section class="bg-white dark:bg-gray-900 rounded-2xl shadow-apple dark:shadow-apple-dark p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-image mr-2 text-apple-blue dark:text-apple-darkblue"></i>
                        图片设置
                    </h2>
                    
                    <div class="mb-4">
                        <label class="block mb-2 font-medium text-gray-700 dark:text-gray-300">图片设置</label>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">您可以上传多张图片作为文章配图</p>
                    </div>
                    
                    <div id="imageUploadSettings" class="mb-4">
                        <div class="mb-4">
                            <label class="block mb-2 font-medium text-gray-700 dark:text-gray-300">图片上传</label>
                            <div id="imageDropArea" class="w-full flex flex-col items-center justify-center p-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl cursor-pointer hover:bg-apple-lightgray dark:hover:bg-gray-800 transition mb-2">
                                <div class="text-center">
                                    <i class="fas fa-cloud-upload-alt text-xl text-apple-blue dark:text-apple-darkblue mb-2"></i>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">点击上传图片或拖拽图片到此处</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">支持从剪贴板粘贴图片 (Ctrl+V)</p>
                                </div>
                                <input id="imageUpload" type="file" multiple accept="image/*" class="hidden">
                            </div>
                            <div class="flex justify-between items-center">
                                <p class="text-xs text-gray-500 dark:text-gray-400">支持JPG、PNG、GIF等常见图片格式，可上传多张图片</p>
                                <button id="optimizeImagesBtn" class="px-4 py-2 bg-apple-blue hover:bg-blue-600 dark:bg-apple-darkblue dark:hover:bg-blue-700 text-white rounded-xl transition-colors flex items-center justify-center whitespace-nowrap">
                                    <i class="fas fa-magic mr-1"></i>高清优化
                                </button>
                            </div>
                        </div>
                        <div id="uploadedImages" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mt-2 hidden"></div>
                        
                        <label class="block mb-2 font-medium text-gray-700 dark:text-gray-300">图片插入方式</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="inline-flex items-center px-3 py-2 bg-apple-lightgray dark:bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                                <input type="radio" name="imageInsertMode" value="even" class="hidden peer" checked>
                                <div class="w-4 h-4 mr-2 rounded-full border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center peer-checked:border-apple-blue dark:peer-checked:border-apple-darkblue">
                                    <div class="w-2 h-2 rounded-full bg-apple-blue dark:bg-apple-darkblue hidden peer-checked:block"></div>
                                </div>
                                <span>均匀分布</span>
                            </label>
                            <label class="inline-flex items-center px-3 py-2 bg-apple-lightgray dark:bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                                <input type="radio" name="imageInsertMode" value="random" class="hidden peer">
                                <div class="w-4 h-4 mr-2 rounded-full border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center peer-checked:border-apple-blue dark:peer-checked:border-apple-darkblue">
                                    <div class="w-2 h-2 rounded-full bg-apple-blue dark:bg-apple-darkblue hidden peer-checked:block"></div>
                                </div>
                                <span>随机分布</span>
                            </label>
                        </div>
                    </div>
                    

                    

                    

                </section>

                <!-- 行动按钮 -->
                <div class="flex justify-center">
                    <button id="generateBtn" class="py-3 px-8 bg-apple-blue hover:bg-blue-600 dark:bg-apple-darkblue dark:hover:bg-blue-700 text-white rounded-full font-medium text-lg transition-colors shadow-md hover:shadow-lg flex items-center">
                        <i class="fas fa-magic mr-2"></i>
                        创作精彩文章
                    </button>
                </div>
            </div>

            <!-- API配置面板 -->
            <div id="api-tab" class="tab-content hidden">
                <section class="bg-white dark:bg-gray-900 rounded-2xl shadow-apple dark:shadow-apple-dark p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-plug mr-2 text-apple-blue dark:text-apple-darkblue"></i>
                        API配置
                    </h2>
                    
                    <!-- 说明信息 -->
                    <div class="bg-yellow-50 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-300 rounded-xl p-4 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle mt-1 mr-3 text-lg"></i>
                            <div>
                                <p class="mb-2">配置API密钥后，本应用可以在您的网站上独立工作，无需依赖第三方服务。</p>
                                <p>所有API密钥仅存储在您的浏览器中，不会传输到任何服务器。</p>
                            </div>
                        </div>
                    </div>

                    <!-- API 服务商选择 -->
                    <div class="mb-6">
                        <h3 class="font-medium text-gray-700 dark:text-gray-300 mb-3">选择API服务商</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">

                            
                            <div class="api-provider-card">
                                <label class="relative p-4 border border-gray-200 dark:border-gray-700 rounded-xl cursor-pointer hover:border-apple-blue dark:hover:border-apple-darkblue transition-all hover:shadow-md flex flex-col h-full">
                                    <input type="radio" name="apiProvider" value="anthropic" class="hidden">
                                    <div class="absolute top-3 right-3 w-4 h-4 rounded-full border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center provider-radio">
                                        <div class="w-2 h-2 rounded-full bg-apple-blue dark:bg-apple-darkblue hidden provider-radio-dot"></div>
                                    </div>
                                    <h4 class="font-medium mb-1">Anthropic</h4>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Claude系列模型</p>
                                    <div class="mt-auto pt-2 border-t border-gray-100 dark:border-gray-800">
                                        <a href="https://console.anthropic.com/account/keys" target="_blank" class="text-xs text-apple-blue dark:text-apple-darkblue hover:underline">
                                            获取API密钥 <i class="fas fa-external-link-alt ml-1"></i>
                                        </a>
                                    </div>
                                </label>
                            </div>
                            


                            <div class="api-provider-card">
                                <label class="relative p-4 border border-gray-200 dark:border-gray-700 rounded-xl cursor-pointer hover:border-apple-blue dark:hover:border-apple-darkblue transition-all hover:shadow-md flex flex-col h-full">
                                    <input type="radio" name="apiProvider" value="deepseek" class="hidden">
                                    <div class="absolute top-3 right-3 w-4 h-4 rounded-full border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center provider-radio">
                                        <div class="w-2 h-2 rounded-full bg-apple-blue dark:bg-apple-darkblue hidden provider-radio-dot"></div>
                                    </div>
                                    <h4 class="font-medium mb-1">DeepSeek</h4>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">深度求索中文大模型</p>
                                    <div class="mt-auto pt-2 border-t border-gray-100 dark:border-gray-800">
                                        <a href="https://platform.deepseek.com/" target="_blank" class="text-xs text-apple-blue dark:text-apple-darkblue hover:underline">
                                            获取API密钥 <i class="fas fa-external-link-alt ml-1"></i>
                                        </a>
                                    </div>
                                </label>
                            </div>

                            <div class="api-provider-card">
                                <label class="relative p-4 border border-gray-200 dark:border-gray-700 rounded-xl cursor-pointer hover:border-apple-blue dark:hover:border-apple-darkblue transition-all hover:shadow-md flex flex-col h-full">
                                    <input type="radio" name="apiProvider" value="oneapi" class="hidden">
                                    <div class="absolute top-3 right-3 w-4 h-4 rounded-full border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center provider-radio">
                                        <div class="w-2 h-2 rounded-full bg-apple-blue dark:bg-apple-darkblue hidden provider-radio-dot"></div>
                                    </div>
                                    <h4 class="font-medium mb-1">One API</h4>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">API中转服务</p>
                                    <div class="mt-auto pt-2 border-t border-gray-100 dark:border-gray-800">
                                        <a href="https://github.com/songquanpeng/one-api" target="_blank" class="text-xs text-apple-blue dark:text-apple-darkblue hover:underline">
                                            获取API密钥 <i class="fas fa-external-link-alt ml-1"></i>
                                        </a>
                                    </div>
                                </label>
                            </div>



                            <div class="api-provider-card">
                                <label class="relative p-4 border border-gray-200 dark:border-gray-700 rounded-xl cursor-pointer hover:border-apple-blue dark:hover:border-apple-darkblue transition-all hover:shadow-md flex flex-col h-full">
                                    <input type="radio" name="apiProvider"  class="hidden">
                                    <div class="absolute top-3 right-3 w-4 h-4 rounded-full border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center provider-radio">
                                        <div class="w-2 h-2 rounded-full bg-apple-blue dark:bg-apple-darkblue hidden provider-radio-dot"></div>
                                    </div>
                                  
                                
                                    <div class="mt-auto pt-2 border-t border-gray-100 dark:border-gray-800">
                      
                                          
                                        </a>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                    

                    
                    <!-- Anthropic API设置 -->
                    <div id="anthropic-settings" class="api-settings mb-6 hidden">
                        <h3 class="font-medium text-gray-700 dark:text-gray-300 mb-3">Anthropic设置</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">API密钥</label>
                                <input type="password" id="anthropic-api-key" placeholder="sk-ant-..." 
                                    class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                    
                    <!-- Extract API设置 -->
                    <div id="extract-settings" class="api-settings mb-6">
                        <h3 class="font-medium text-gray-700 dark:text-gray-300 mb-3">Extract API设置</h3>
                        <div class="space-y-4">
                            <div class="bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 rounded-xl p-4 mb-4">
                                <div class="flex items-start">
                                    <i class="fas fa-info-circle mt-1 mr-3 text-lg"></i>
                                    <div>
                                        <p class="mb-2">Extract API用于从网页中提取高质量图片，支持多种图片格式和尺寸。</p>
                                        <p>配置完成后，您可以直接从网页URL中提取图片用于文章创作。</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">API密钥</label>
                                <input type="password" id="extract-api-key" placeholder="输入Extract API密钥" 
                                    class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                            </div>
                            
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">API端点</label>
                                <input type="text" id="extract-api-endpoint" placeholder="https://api.example.com/extract" 
                                    class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                <p class="text-xs text-gray-500 mt-1">输入Extract API服务的完整URL地址</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">最大提取图片数</label>
                                    <input type="number" id="extract-max-images" min="1" max="20" value="10" 
                                        class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                    <p class="text-xs text-gray-500 mt-1">从单个网页提取的最大图片数量</p>
                                </div>
                                
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">图片质量要求</label>
                                    <select id="extract-image-quality" class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                        <option value="high">高质量</option>
                                        <option value="medium" selected>中等质量</option>
                                        <option value="low">低质量</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">更高质量的图片可能会增加加载时间</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">图片最小尺寸</label>
                                    <div class="flex space-x-2">
                                        <input type="number" id="extract-min-width" min="100" max="2000" value="400" 
                                            class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition" placeholder="宽度">
                                        <input type="number" id="extract-min-height" min="100" max="2000" value="400" 
                                            class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition" placeholder="高度">
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">小于此尺寸的图片将被忽略</p>
                                </div>
                                
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">图片格式</label>
                                    <select id="extract-image-format" class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                        <option value="all" selected>所有格式</option>
                                        <option value="jpg">仅JPG/JPEG</option>
                                        <option value="png">仅PNG</option>
                                        <option value="webp">仅WebP</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">超时设置 (秒)</label>
                                <input type="number" id="extract-timeout" min="5" max="60" value="30" 
                                    class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                <p class="text-xs text-gray-500 mt-1">提取操作的最大等待时间</p>
                            </div>
                            
                            <div class="pt-2">
                                <button id="test-extract-api" class="px-4 py-2 bg-apple-blue hover:bg-blue-600 dark:bg-apple-darkblue dark:hover:bg-blue-700 text-white rounded-xl transition-colors flex items-center justify-center">
                                    <i class="fas fa-vial mr-2"></i> 测试API连接
                                </button>
                            </div>
                        </div>
                    </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">模型</label>
                                    <select id="anthropic-model" class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                        <option value="claude-3-5-sonnet-20240620">Claude 3.5 Sonnet (推荐)</option>
                                        <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                                        <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                                        <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">API代理 (可选)</label>
                                    <input type="text" id="anthropic-api-proxy" placeholder="https://your-proxy-url.com" 
                                        class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Temperature</label>
                                    <input type="number" id="anthropic-temperature" min="0" max="1" step="0.1" value="0.7" 
                                        class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                </div>
                                
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Max Tokens</label>
                                    <input type="number" id="anthropic-max-tokens" min="100" max="100000" step="100" value="4000" 
                                        class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                </div>
                                
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Top P</label>
                                    <input type="number" id="anthropic-top-p" min="0" max="1" step="0.05" value="0.95" 
                                        class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                </div>
                            </div>
                        </div>
                    </div>
                    


                    <!-- DeepSeek API设置 -->
                    <div id="deepseek-settings" class="api-settings mb-6 hidden">
                        <h3 class="font-medium text-gray-700 dark:text-gray-300 mb-3">DeepSeek设置</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">API密钥</label>
                                <input type="password" id="deepseek-api-key" placeholder="sk-..." 
                                    class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">模型</label>
                                    <select id="deepseek-model" class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                        <option value="deepseek-chat">DeepSeek Chat (推荐)</option>
                                        <option value="deepseek-coder">DeepSeek Coder</option>
                                        <option value="deepseek-lite">DeepSeek Lite</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">API代理 (可选)</label>
                                    <input type="text" id="deepseek-api-proxy" placeholder="https://your-proxy-url.com" 
                                        class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Temperature</label>
                                    <input type="number" id="deepseek-temperature" min="0" max="1" step="0.1" value="0.7" 
                                        class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                </div>
                                
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Max Tokens</label>
                                    <input type="number" id="deepseek-max-tokens" min="100" max="8192" step="100" value="4000" 
                                        class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                </div>
                                
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Top P</label>
                                    <input type="number" id="deepseek-top-p" min="0" max="1" step="0.05" value="0.9" 
                                        class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- One API设置 -->
                    <div id="oneapi-settings" class="api-settings mb-6 hidden">
                        <h3 class="font-medium text-gray-700 dark:text-gray-300 mb-3">One API设置</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">API密钥</label>
                                <input type="password" id="oneapi-api-key" placeholder="sk-..." 
                                    class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">API基础URL</label>
                                    <input type="text" id="oneapi-base-url" placeholder="https://your-oneapi-url.com" 
                                        class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                </div>
                                

                                
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">模型</label>
                                    <input type="text" id="oneapi-model" placeholder="输入模型名称" list="oneapi-model-list"
                                        class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                    <datalist id="oneapi-model-list">
                                        <option value="gpt-4-turbo">GPT-4 Turbo (推荐)</option>
                                        <option value="gpt-4">GPT-4</option>
                                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                        <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                                        <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                                        <option value="qwen-turbo">通义千问 Turbo</option>
                                        <option value="moonshot-v1-8k">月之暗面 v1</option>
                                    </datalist>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Temperature</label>
                                    <input type="number" id="oneapi-temperature" min="0" max="1" step="0.1" value="0.7" 
                                        class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                </div>
                                
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Max Tokens</label>
                                    <input type="number" id="oneapi-max-tokens" min="100" max="8192" step="100" value="4000" 
                                        class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                </div>
                                
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Top P</label>
                                    <input type="number" id="oneapi-top-p" min="0" max="1" step="0.05" value="0.9" 
                                        class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition">
                                </div>
                            </div>
                            
                            <div class="p-3 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 rounded-xl">
                                <div class="flex">
                                    <i class="fas fa-info-circle mt-1 mr-2"></i>
                                    <div>
                                        <p class="text-sm mb-2">One API是一个API中转服务，可以统一管理多个AI服务商的API：</p>
                                        <ol class="text-sm list-decimal ml-4 space-y-1">
                                            <li>部署或使用已有的One API服务</li>
                                            <li>在One API平台创建API密钥</li>
                                            <li>填入API密钥和One API服务的基础URL</li>
                                            <li>选择您想使用的模型</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    
                    <!-- 自部署说明 -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-4 mb-6">
                        <h3 class="font-medium text-gray-700 dark:text-gray-300 mb-3 flex items-center">
                            <i class="fas fa-server mr-2 text-apple-blue dark:text-apple-darkblue"></i>
                            网站部署说明
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">本应用可以轻松部署到您自己的网站上：</p>
                        <ol class="text-sm text-gray-600 dark:text-gray-400 space-y-2 pl-5 list-decimal">
                            <li>复制本页面全部HTML代码</li>
                            <li>创建一个新的HTML文件并粘贴代码</li>
                            <li>配置您的API密钥</li>
                            <li>上传到您的网站服务器或静态托管服务</li>
                        </ol>
                    </div>
                    
                    <div class="flex justify-center">
                        <button id="saveApiSettingsBtn" class="py-2 px-6 bg-apple-blue hover:bg-blue-600 dark:bg-apple-darkblue dark:hover:bg-blue-700 text-white rounded-full font-medium transition-colors shadow-md hover:shadow-lg">
                            保存API配置
                        </button>
                    </div>

                    <!-- API测试状态 -->
                    <div id="apiTestResult" class="mt-4 hidden"></div>
                </section>
            </div>

            <!-- 预览排版面板 -->
            <div id="preview-tab" class="tab-content hidden">
                <!-- 生成状态 -->
                <div id="generationStatus" class="py-4 px-6 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 rounded-xl text-center mb-6 hidden">
                    <div class="flex items-center justify-center space-x-3">
                        <div class="apple-spinner"></div>
                        <span id="statusText">正在创作精彩内容...</span>
                    </div>
                </div>

                <!-- 排版主题展示 -->
                <div id="themeShowcase" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="theme-card bg-white dark:bg-gray-900 rounded-2xl shadow-apple dark:shadow-apple-dark overflow-hidden cursor-pointer hover:ring-2 ring-apple-blue dark:ring-apple-darkblue transition-shadow theme-card-selected" data-theme="modern">
                        <div class="p-4 border-b border-gray-100 dark:border-gray-800 font-medium">现代简约风</div>
                        <div class="p-4 h-48 overflow-hidden">
                            <div class="theme-modern scale-[0.6] origin-top-left">
                                <h1>现代简约风格标题</h1>
                                <p>这是一款专为现代数字体验设计的排版风格，特点是清晰的层次结构和优雅的视觉表现。</p>
                                <h2>小标题展示</h2>
                                <p>简洁的段落文字与优雅的间距搭配，让阅读体验更加舒适。适合各类专业文章和技术内容。</p>
                            </div>
                        </div>
                    </div>
                    <div class="theme-card bg-white dark:bg-gray-900 rounded-2xl shadow-apple dark:shadow-apple-dark overflow-hidden cursor-pointer hover:ring-2 ring-apple-blue dark:ring-apple-darkblue transition-shadow" data-theme="magazine">
                        <div class="p-4 border-b border-gray-100 dark:border-gray-800 font-medium">杂志排版风</div>
                        <div class="p-4 h-48 overflow-hidden">
                            <div class="theme-magazine scale-[0.6] origin-top-left">
                                <h1>杂志风格大标题</h1>
                                <p>杂志风格的排版设计灵感来源于印刷媒体，强调优雅的文字处理和精致的细节。</p>
                                <h2>精致的小标题</h2>
                                <p>这种风格特别适合长篇故事和深度报道，首字下沉效果增添了专业感和阅读趣味。</p>
                            </div>
                        </div>
                    </div>
                    <div class="theme-card bg-white dark:bg-gray-900 rounded-2xl shadow-apple dark:shadow-apple-dark overflow-hidden cursor-pointer hover:ring-2 ring-apple-blue dark:ring-apple-darkblue transition-shadow" data-theme="tech">
                        <div class="p-4 border-b border-gray-100 dark:border-gray-800 font-medium">科技风格</div>
                        <div class="p-4 h-48 overflow-hidden">
                            <div class="theme-tech scale-[0.6] origin-top-left">
                                <h1>科技风格醒目标题</h1>
                                <p>科技风格采用现代感十足的渐变色彩和清晰的字体层次，展现前沿科技的视觉效果。</p>
                                <h2>功能性小标题</h2>
                                <p>特别适合科技博客、产品介绍和技术文档，内置代码样式和专业的引用框设计。</p>
                            </div>
                        </div>
                    </div>
                    <div class="theme-card bg-white dark:bg-gray-900 rounded-2xl shadow-apple dark:shadow-apple-dark overflow-hidden cursor-pointer hover:ring-2 ring-apple-blue dark:ring-apple-darkblue transition-shadow" data-theme="business">
                        <div class="p-4 border-b border-gray-100 dark:border-gray-800 font-medium">优雅商务风</div>
                        <div class="p-4 h-48 overflow-hidden">
                            <div class="theme-business scale-[0.6] origin-top-left">
                                <h1>优雅商务风格标题</h1>
                                <p>商务风格采用沉稳专业的排版，适合正式场合的商业内容和专业报告。</p>
                                <h2>业务部分标题</h2>
                                <p>结构清晰，重点突出，为读者提供专业且易于理解的阅读体验，尤其适合公司白皮书和商业分析。</p>
                            </div>
                        </div>
                    </div>
                    <div class="theme-card bg-white dark:bg-gray-900 rounded-2xl shadow-apple dark:shadow-apple-dark overflow-hidden cursor-pointer hover:ring-2 ring-apple-blue dark:ring-apple-darkblue transition-shadow" data-theme="creative">
                        <div class="p-4 border-b border-gray-100 dark:border-gray-800 font-medium">创意设计风</div>
                        <div class="p-4 h-48 overflow-hidden">
                            <div class="theme-creative scale-[0.6] origin-top-left">
                                <h1>创意风格大标题</h1>
                                <p>创意设计风格活泼生动，色彩丰富，让内容具有艺术感和吸引力。</p>
                                <h2>灵感部分</h2>
                                <p>独特的排版和装饰元素让文章充满设计感，特别适合创意行业、艺术评论和时尚内容。</p>
                            </div>
                        </div>
                    </div>
                    <div class="theme-card bg-white dark:bg-gray-900 rounded-2xl shadow-apple dark:shadow-apple-dark overflow-hidden cursor-pointer hover:ring-2 ring-apple-blue dark:ring-apple-darkblue transition-shadow" data-theme="academic">
                        <div class="p-4 border-b border-gray-100 dark:border-gray-800 font-medium">学术论文风</div>
                        <div class="p-4 h-48 overflow-hidden">
                            <div class="theme-academic scale-[0.6] origin-top-left">
                                <h1>学术研究标题</h1>
                                <p>学术风格注重内容的严谨性和结构化表达，遵循学术规范的排版原则。</p>
                                <h2>研究方法</h2>
                                <p>首行缩进和引用格式符合学术要求，特别适合研究报告、学术论文和教育内容的呈现。</p>
                            </div>
                        </div>
                    </div>
                    <div class="theme-card bg-white dark:bg-gray-900 rounded-2xl shadow-apple dark:shadow-apple-dark overflow-hidden cursor-pointer hover:ring-2 ring-apple-blue dark:ring-apple-darkblue transition-shadow" data-theme="media">
                        <div class="p-4 border-b border-gray-100 dark:border-gray-800 font-medium">自媒体风格</div>
                        <div class="p-4 h-48 overflow-hidden">
                            <div class="theme-media scale-[0.6] origin-top-left">
                                <h1>自媒体文章标题</h1>
                                <p>自媒体风格注重视觉吸引力和易读性，适合在各大平台发布的内容。</p>
                                <h2>引人入胜的小标题</h2>
                                <p>醒目的标题、清晰的层级和强调的重点，让读者快速获取信息，适合微信公众号和其他自媒体平台。</p>
                            </div>
                        </div>
                    </div>
                    <div class="theme-card bg-white dark:bg-gray-900 rounded-2xl shadow-apple dark:shadow-apple-dark overflow-hidden cursor-pointer hover:ring-2 ring-apple-blue dark:ring-apple-darkblue transition-shadow" data-theme="entertainment">
                        <div class="p-4 border-b border-gray-100 dark:border-gray-800 font-medium">娱乐风格</div>
                        <div class="p-4 h-48 overflow-hidden">
                            <div class="theme-entertainment scale-[0.6] origin-top-left">
                                <h1>娱乐风格大标题</h1>
                                <p>娱乐风格活泼有趣，色彩丰富，让内容充满活力和趣味性。</p>
                                <h2>有趣的小标题</h2>
                                <p>轻松愉快的排版风格，特别适合娱乐资讯、游戏评测和休闲类内容的呈现。</p>
                            </div>
                        </div>
                    </div>
                    <div class="theme-card bg-white dark:bg-gray-900 rounded-2xl shadow-apple dark:shadow-apple-dark overflow-hidden cursor-pointer hover:ring-2 ring-apple-blue dark:ring-apple-darkblue transition-shadow" data-theme="trending">
                        <div class="p-4 border-b border-gray-100 dark:border-gray-800 font-medium">热点风格</div>
                        <div class="p-4 h-48 overflow-hidden">
                            <div class="theme-trending scale-[0.6] origin-top-left">
                                <h1>热点新闻大标题</h1>
                                <p>热点风格醒目有力，强调重点内容，让读者快速获取关键信息。</p>
                                <h2>焦点内容小标题</h2>
                                <p>新闻感十足的排版，特别适合时事热点、社会话题和重要资讯的传递。</p>
                            </div>
                        </div>
                    </div>
                    <div class="theme-card bg-white dark:bg-gray-900 rounded-2xl shadow-apple dark:shadow-apple-dark overflow-hidden cursor-pointer hover:ring-2 ring-apple-blue dark:ring-apple-darkblue transition-shadow" data-theme="code-tech">
                        <div class="p-4 border-b border-gray-100 dark:border-gray-800 font-medium">代码科技风格</div>
                        <div class="p-4 h-48 overflow-hidden">
                            <div class="theme-code-tech scale-[0.6] origin-top-left">
                                <h1>代码科技风格标题</h1>
                                <p>代码科技风格模拟编程环境，采用等宽字体和代码高亮效果。</p>
                                <h2>技术模块标题</h2>
                                <p>专为程序员和技术爱好者设计，特别适合编程教程、技术文档和开发笔记。</p>
                                <code>console.log("Hello, World!");</code>
                            </div>
                        </div>
                    </div>
                    <!-- 删除微信公众号主题卡片 -->
                    <div class="theme-card bg-white dark:bg-gray-900 rounded-2xl shadow-apple dark:shadow-apple-dark overflow-hidden cursor-pointer hover:ring-2 ring-apple-blue dark:ring-apple-darkblue transition-shadow" data-theme="wechat">
                        <div class="p-4 border-b border-gray-100 dark:border-gray-800 font-medium">微信公众号专用</div>
                        <div class="p-4 h-48 overflow-hidden">
                            <div class="theme-wechat scale-[0.6] origin-top-left">
                                <h1>微信公众号专用标题</h1>
                                <p>微信公众号专用风格，适合在公众号中发布文章。</p>
                                <h2>公众号风格特点</h2>
                                <p>标题大而醒目，段落简洁明了，适合在公众号中阅读。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 输出预览 -->
                <section id="outputSection" class="bg-white dark:bg-gray-900 rounded-2xl shadow-apple dark:shadow-apple-dark p-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold flex items-center">
                            <i class="fas fa-newspaper mr-2 text-apple-blue dark:text-apple-darkblue"></i>
                            文章预览
                        </h2>
                        <div class="flex gap-2">
                            <button id="editArticleBtn" class="py-1.5 px-3 text-sm bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg transition-colors flex items-center">
                                <i class="fas fa-edit mr-1.5"></i>编辑
                            </button>
                            <button id="regenerateBtn" class="py-1.5 px-3 text-sm bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg transition-colors flex items-center">
                                <i class="fas fa-sync-alt mr-1.5"></i>重新生成
                            </button>
                            <button id="copyBtn" class="py-1.5 px-3 text-sm bg-apple-blue hover:bg-blue-600 dark:bg-apple-darkblue dark:hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center">
                                <i class="fas fa-copy mr-1.5"></i>复制文章
                            </button>
                            <button id="copyWechatBtn" class="py-1.5 px-3 text-sm bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors flex items-center">
                                <i class="fab fa-weixin mr-1.5"></i>复制到公众号
                            </button>
                        </div>
                    </div>
                    
                    <div id="articleOutput" class="theme-modern prose dark:prose-invert max-w-none border border-gray-100 dark:border-gray-800 p-6 rounded-xl bg-white dark:bg-gray-950 overflow-auto"></div>
                    
                    <!-- 生成的图片区域 -->
                    <div id="generatedImages" class="mt-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 hidden">
                        <h3 class="text-lg font-semibold col-span-full mb-2 flex items-center">
                            <i class="fas fa-images mr-2 text-apple-blue dark:text-apple-darkblue"></i>生成的图片
                        </h3>
                        <!-- 生成的图片将在这里显示 -->
                    </div>
                </section>
                
                <!-- 编辑文章对话框 -->
                <div id="editArticleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden backdrop-blur-sm">
                    <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-auto shadow-xl animate-fade-in">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">编辑文章内容</h3>
                            <button id="closeEditBtn" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                <i class="fas fa-times text-lg"></i>
                            </button>
                        </div>
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="font-medium text-gray-700 dark:text-gray-300">Markdown 编辑</label>
                                <div class="flex gap-2">
                                    <button id="formatBoldBtn" class="p-1.5 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 bg-gray-100 dark:bg-gray-800 rounded">
                                        <i class="fas fa-bold"></i>
                                    </button>
                                    <button id="formatItalicBtn" class="p-1.5 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 bg-gray-100 dark:bg-gray-800 rounded">
                                        <i class="fas fa-italic"></i>
                                    </button>
                                    <button id="formatLinkBtn" class="p-1.5 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 bg-gray-100 dark:bg-gray-800 rounded">
                                        <i class="fas fa-link"></i>
                                    </button>
                                    <button id="formatH2Btn" class="p-1.5 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 bg-gray-100 dark:bg-gray-800 rounded">
                                        <i class="fas fa-heading"></i>
                                    </button>
                                    <button id="formatQuoteBtn" class="p-1.5 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 bg-gray-100 dark:bg-gray-800 rounded">
                                        <i class="fas fa-quote-right"></i>
                                    </button>
                                </div>
                            </div>
                            <textarea id="articleEditArea" rows="20" class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-apple-lightgray dark:bg-gray-800 text-base focus:ring-2 focus:ring-apple-blue dark:focus:ring-apple-darkblue focus:border-transparent outline-none transition font-mono"></textarea>
                        </div>
                        <div class="flex justify-end gap-3">
                            <button id="cancelEditBtn" class="py-2 px-4 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg transition-colors">
                                取消
                            </button>
                            <button id="saveEditBtn" class="py-2 px-4 bg-apple-blue hover:bg-blue-600 dark:bg-apple-darkblue dark:hover:bg-blue-700 text-white rounded-lg transition-colors">
                                保存更改
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="mt-12 text-center text-apple-midgray dark:text-gray-500 text-sm py-4">
            <p>© 2024 AI文章创作室 - 使用先进AI技术创建专业内容</p>
        </footer>
    </div>

    <script>
        // 检测暗色模式
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // API配置持久化
        const API_CONFIG_KEY = 'ai_writer_api_config';
        
        // 加载保存的API配置
        function loadApiConfig() {
            const savedConfig = localStorage.getItem(API_CONFIG_KEY);
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    
                    // 设置选中的API提供商
                    const providerRadio = document.querySelector(`input[name="apiProvider"][value="${config.provider}"]`);
                    if (providerRadio) {
                        providerRadio.checked = true;
                        // 手动设置单选按钮的样式
                        updateProviderRadioStyle(providerRadio);
                        // 触发提供商切换事件
                        toggleApiSettings(config.provider);
                    }

                    // Extract API配置
                    if (config.extract) {
                        document.getElementById('extract-api-key').value = config.extract.apiKey || '';
                        document.getElementById('extract-api-endpoint').value = config.extract.apiEndpoint || '';
                        document.getElementById('extract-max-images').value = config.extract.maxImages || 10;
                        document.getElementById('extract-image-quality').value = config.extract.imageQuality || 'medium';
                        document.getElementById('extract-min-width').value = config.extract.minWidth || 400;
                        document.getElementById('extract-min-height').value = config.extract.minHeight || 400;
                        document.getElementById('extract-image-format').value = config.extract.imageFormat || 'all';
                        document.getElementById('extract-timeout').value = config.extract.timeout || 30;
                    }
                    
                    // OpenAI配置
                    if (config.openai) {
                        document.getElementById('openai-api-key').value = config.openai.apiKey || '';
                        document.getElementById('openai-text-model').value = config.openai.textModel || 'gpt-4';
                        document.getElementById('openai-image-model').value = config.openai.imageModel || 'dall-e-3';
                        document.getElementById('openai-temperature').value = config.openai.temperature || 0.7;
                        document.getElementById('openai-max-tokens').value = config.openai.maxTokens || 4000;
                        document.getElementById('openai-api-proxy').value = config.openai.apiProxy || '';
                    }
                    
                    // Anthropic配置
                    if (config.anthropic) {
                        document.getElementById('anthropic-api-key').value = config.anthropic.apiKey || '';
                        document.getElementById('anthropic-model').value = config.anthropic.model || 'claude-3-5-sonnet-20240620';
                        document.getElementById('anthropic-temperature').value = config.anthropic.temperature || 0.7;
                        document.getElementById('anthropic-max-tokens').value = config.anthropic.maxTokens || 4000;
                        document.getElementById('anthropic-top-p').value = config.anthropic.topP || 0.95;
                        document.getElementById('anthropic-api-proxy').value = config.anthropic.apiProxy || '';
                    }
                    
                    // Poe配置
                    if (config.poe) {
                        document.getElementById('poe-api-key').value = config.poe.apiKey || '';
                        document.getElementById('poe-text-model').value = config.poe.textModel || 'Claude-3.7-Sonnet';
                        document.getElementById('poe-image-model').value = config.poe.imageModel || 'FLUX-pro-1.1';
                    }
                    
                    // DeepSeek配置
                    if (config.deepseek) {
                        document.getElementById('deepseek-api-key').value = config.deepseek.apiKey || '';
                        document.getElementById('deepseek-model').value = config.deepseek.model || 'deepseek-chat';
                        document.getElementById('deepseek-temperature').value = config.deepseek.temperature || 0.7;
                        document.getElementById('deepseek-max-tokens').value = config.deepseek.maxTokens || 4000;
                        document.getElementById('deepseek-top-p').value = config.deepseek.topP || 0.9;
                        document.getElementById('deepseek-api-proxy').value = config.deepseek.apiProxy || '';
                    }
                    
                    // One API配置
                    if (config.oneapi) {
                        document.getElementById('oneapi-api-key').value = config.oneapi.apiKey || '';
                        document.getElementById('oneapi-base-url').value = config.oneapi.baseUrl || '';
                        document.getElementById('oneapi-provider-name').value = config.oneapi.providerName || '';
                        document.getElementById('oneapi-model').value = config.oneapi.model || 'gpt-4-turbo';
                        document.getElementById('oneapi-temperature').value = config.oneapi.temperature || 0.7;
                        document.getElementById('oneapi-max-tokens').value = config.oneapi.maxTokens || 4000;
                        document.getElementById('oneapi-top-p').value = config.oneapi.topP || 0.9;
                    }
                    
                    // 月之暗面配置
                    if (config.moonshot) {
                        document.getElementById('moonshot-api-key').value = config.moonshot.apiKey || '';
                        document.getElementById('moonshot-model').value = config.moonshot.model || 'moonshot-v1-8k';
                        document.getElementById('moonshot-temperature').value = config.moonshot.temperature || 0.7;
                        document.getElementById('moonshot-max-tokens').value = config.moonshot.maxTokens || 4000;
                        document.getElementById('moonshot-top-p').value = config.moonshot.topP || 0.95;
                        document.getElementById('moonshot-api-proxy').value = config.moonshot.apiProxy || '';
                    }
                } catch (error) {
                    console.error("加载API配置时出错:", error);
                }
            }
        }
        
        // 保存API配置
        function saveApiConfig() {
            const provider = document.querySelector('input[name="apiProvider"]:checked').value;
            
            const config = {
                provider,
                anthropic: {
                    apiKey: document.getElementById('anthropic-api-key').value,
                    model: document.getElementById('anthropic-model').value,
                    temperature: parseFloat(document.getElementById('anthropic-temperature').value),
                    maxTokens: parseInt(document.getElementById('anthropic-max-tokens').value),
                    topP: parseFloat(document.getElementById('anthropic-top-p').value),
                    apiProxy: document.getElementById('anthropic-api-proxy').value
                },
                deepseek: {
                    apiKey: document.getElementById('deepseek-api-key').value,
                    model: document.getElementById('deepseek-model').value,
                    temperature: parseFloat(document.getElementById('deepseek-temperature').value),
                    maxTokens: parseInt(document.getElementById('deepseek-max-tokens').value),
                    topP: parseFloat(document.getElementById('deepseek-top-p').value),
                    apiProxy: document.getElementById('deepseek-api-proxy').value
                },
                oneapi: {
                    apiKey: document.getElementById('oneapi-api-key').value,
                    baseUrl: document.getElementById('oneapi-base-url').value,
                    model: document.getElementById('oneapi-model').value,
                    temperature: parseFloat(document.getElementById('oneapi-temperature').value),
                    maxTokens: parseInt(document.getElementById('oneapi-max-tokens').value),
                    topP: parseFloat(document.getElementById('oneapi-top-p').value)
                },
                extract: {
                    apiKey: document.getElementById('extract-api-key').value,
                    apiEndpoint: document.getElementById('extract-api-endpoint').value,
                    maxImages: parseInt(document.getElementById('extract-max-images').value),
                    imageQuality: document.getElementById('extract-image-quality').value,
                    minWidth: parseInt(document.getElementById('extract-min-width').value),
                    minHeight: parseInt(document.getElementById('extract-min-height').value),
                    imageFormat: document.getElementById('extract-image-format').value,
                    timeout: parseInt(document.getElementById('extract-timeout').value)
                }
            };
            
            localStorage.setItem(API_CONFIG_KEY, JSON.stringify(config));
            return config;
        }
        
        // 测试API连接
        async function testApiConnection(provider) {
            const apiConfig = JSON.parse(localStorage.getItem(API_CONFIG_KEY) || '{}');
            
            try {
                if (provider === 'poe') {
                    const poeKey = apiConfig.poe?.apiKey;
                    if (!poeKey) {
                        throw new Error("未配置Poe API密钥");
                    }
                    
                    // 发送简单请求测试API连接
                    const response = await fetch('https://api.poe.com/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${poeKey}`
                        },
                        body: JSON.stringify({
                            model: "claude-3-opus-20240229",
                            messages: [
                                { role: "user", content: "Hello, just testing the API connection. Please respond with 'API connection successful'." }
                            ]
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`Poe API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    return true;
                }
                // 可以添加其他API提供商的测试实现
                else if (provider === 'openai') {
                    const openaiKey = apiConfig.openai?.apiKey;
                    if (!openaiKey) {
                        throw new Error("未配置OpenAI API密钥");
                    }
                    
                    // 根据是否设置了代理来确定API端点
                    const apiProxy = apiConfig.openai?.apiProxy;
                    const apiEndpoint = apiProxy ? apiProxy : 'https://api.openai.com/v1/chat/completions';
                    
                    // 发送简单请求测试API连接
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${openaiKey}`
                        },
                        body: JSON.stringify({
                            model: "gpt-3.5-turbo",
                            messages: [
                                { role: "user", content: "Hello, just testing the API connection. Please respond with 'API connection successful'." }
                            ],
                            max_tokens: 10
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`OpenAI API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    return true;
                }
                // One API测试实现
                else if (provider === 'oneapi') {
                    const oneapiKey = apiConfig.oneapi?.apiKey;
                    if (!oneapiKey) {
                        throw new Error("未配置One API密钥");
                    }
                    
                    // 获取基础URL
                    const baseUrl = apiConfig.oneapi?.baseUrl;
                    if (!baseUrl) {
                        throw new Error("未配置One API基础URL");
                    }
                    
                    // 获取用户配置的模型名称，如果未配置则使用默认值
                    const model = apiConfig.oneapi?.model || 'gpt-3.5-turbo';
                    
                    // 构建API端点
                    const apiEndpoint = `${baseUrl.replace(/\/$/, '')}/v1/chat/completions`;
                    
                    // 准备请求头，如果有自定义服务商名称，则添加到请求头中
                    const headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${oneapiKey}`
                    };
                    
                    const providerName = apiConfig.oneapi?.providerName || '';
                    if (providerName) {
                        headers['Provider'] = providerName;
                    }
                    
                    try {
                        // 发送简单请求测试API连接
                        const response = await fetch(apiEndpoint, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify({
                                model: model, // 使用用户配置的模型名称
                                messages: [
                                    { role: "user", content: "Hello, just testing the API connection. Please respond with 'API connection successful'." }
                                ],
                                max_tokens: 10
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            // 提供更详细的错误信息，包括可能的模型不存在错误
                            const errorMessage = errorData.error?.message || response.statusText || '未知错误';
                            if (errorMessage.includes("model") || errorMessage.includes("Model")) {
                                throw new Error(`One API错误: Model Not Exist - 模型"${model}"不存在或不可用，请检查模型名称是否正确`);
                            } else {
                                throw new Error(`One API错误: ${errorMessage}`);
                            }
                        }
                        
                        return true;
                    } catch (error) {
                        // 处理网络错误
                        if (error.message === 'Failed to fetch') {
                            throw new Error('Failed to fetch - 网络请求失败，请检查网络连接和API基础URL是否正确');
                        }
                        throw error;
                    }
                }
                // DeepSeek API测试实现
                else if (provider === 'deepseek') {
                    const deepseekKey = apiConfig.deepseek?.apiKey;
                    if (!deepseekKey) {
                        throw new Error("未配置DeepSeek API密钥");
                    }
                    
                    // 根据是否设置了代理来确定API端点
                    const apiProxy = apiConfig.deepseek?.apiProxy;
                    const apiEndpoint = apiProxy ? apiProxy : 'https://api.deepseek.com/v1/chat/completions';
                    
                    // 发送简单请求测试API连接
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${deepseekKey}`
                        },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: [
                                { role: "user", content: "Hello, just testing the API connection. Please respond with 'API connection successful'." }
                            ],
                            max_tokens: 10
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`DeepSeek API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    return true;
                }
                // Anthropic API测试实现
                else if (provider === 'anthropic') {
                    const anthropicKey = apiConfig.anthropic?.apiKey;
                    if (!anthropicKey) {
                        throw new Error("未配置Anthropic API密钥");
                    }
                    
                    // 根据是否设置了代理来确定API端点
                    const apiProxy = apiConfig.anthropic?.apiProxy;
                    const apiEndpoint = apiProxy ? apiProxy : 'https://api.anthropic.com/v1/messages';
                    
                    // 发送简单请求测试API连接
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': anthropicKey,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: "claude-3-haiku-20240307",
                            messages: [
                                { role: "user", content: "Hello, just testing the API connection. Please respond with 'API connection successful'." }
                            ],
                            max_tokens: 10
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`Anthropic API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    return true;
                }
                // 月之暗面API测试实现
                else if (provider === 'moonshot') {
                    const moonshotKey = apiConfig.moonshot?.apiKey;
                    if (!moonshotKey) {
                        throw new Error("未配置月之暗面API密钥");
                    }
                    
                    // 根据是否设置了代理来确定API端点
                    const apiProxy = apiConfig.moonshot?.apiProxy;
                    const apiEndpoint = apiProxy ? apiProxy : 'https://api.moonshot.cn/v1/chat/completions';
                    
                    // 发送简单请求测试API连接
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${moonshotKey}`
                        },
                        body: JSON.stringify({
                            model: "moonshot-v1-8k",
                            messages: [
                                { role: "user", content: "Hello, just testing the API connection. Please respond with 'API connection successful'." }
                            ],
                            max_tokens: 10
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`月之暗面API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    return true;
                }
                // One API实现
                else if (provider === 'oneapi') {
                    const oneapiKey = apiConfig.oneapi?.apiKey;
                    if (!oneapiKey) {
                        throw new Error("未配置One API密钥");
                    }
                    
                    // 获取基础URL
                    const baseUrl = apiConfig.oneapi?.baseUrl;
                    if (!baseUrl) {
                        throw new Error("未配置One API基础URL");
                    }
                    
                    const providerName = apiConfig.oneapi?.providerName || '';
                    const model = apiConfig.oneapi?.model || 'gpt-4-turbo';
                    const temperature = apiConfig.oneapi?.temperature || 0.7;
                    const maxTokens = apiConfig.oneapi?.maxTokens || 4000;
                    const topP = apiConfig.oneapi?.topP || 0.9;
                    
                    // 构建API端点
                    const apiEndpoint = `${baseUrl.replace(/\/$/, '')}/v1/chat/completions`;
                    
                    // 准备请求头，如果有自定义服务商名称，则添加到请求头中
                    const headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${oneapiKey}`
                    };
                    
                    if (providerName) {
                        headers['Provider'] = providerName;
                    }
                    
                    // 调用One API
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: "user", content: fullPrompt }
                            ],
                            temperature: temperature,
                            max_tokens: maxTokens,
                            top_p: topP
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`One API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content || '';
                    
                    // 添加标题，如果还没有标题且用户提供了标题
                    if (title && !content.startsWith('# ')) {
                        return `# ${title}\n\n${content}`;
                    }
                    
                    return content;
                }
                // 月之暗面API实现
                else if (provider === 'moonshot') {
                    const moonshotKey = apiConfig.moonshot?.apiKey;
                    if (!moonshotKey) {
                        throw new Error("未配置月之暗面API密钥");
                    }
                    
                    const model = apiConfig.moonshot?.model || 'moonshot-v1-8k';
                    const temperature = apiConfig.moonshot?.temperature || 0.7;
                    const maxTokens = apiConfig.moonshot?.maxTokens || 4000;
                    const topP = apiConfig.moonshot?.topP || 0.95;
                    
                    // 根据是否设置了代理来确定API端点
                    const apiProxy = apiConfig.moonshot?.apiProxy;
                    const apiEndpoint = apiProxy ? apiProxy : 'https://api.moonshot.cn/v1/chat/completions';
                    
                    // 调用月之暗面API
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${moonshotKey}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: "user", content: fullPrompt }
                            ],
                            temperature: temperature,
                            max_tokens: maxTokens,
                            top_p: topP
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`月之暗面API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content || '';
                    
                    // 添加标题，如果还没有标题且用户提供了标题
                    if (title && !content.startsWith('# ')) {
                        return `# ${title}\n\n${content}`;
                    }
                    
                    return content;
                }
                else {
                    throw new Error(`不支持的API提供商: ${provider}`);
                }
            } catch (error) {
                console.error(`${provider} API连接测试失败:`, error);
                throw error;
            }
        }

        // 标签页切换
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                // 移除所有active类
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active', 'bg-white', 'dark:bg-gray-800', 'shadow-sm');
                    btn.classList.add('text-gray-500', 'dark:text-gray-400');
                });
                
                // 隐藏所有内容
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // 激活当前标签
                button.classList.add('active', 'bg-white', 'dark:bg-gray-800', 'shadow-sm');
                button.classList.remove('text-gray-500', 'dark:text-gray-400');
                
                // 显示当前内容
                const tabId = button.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.remove('hidden');
            });
        });
        
        // 设置API提供商卡片样式
        function updateProviderRadioStyle(radio) {
            // 获取所有提供商卡片
            document.querySelectorAll('.api-provider-card').forEach(card => {
                const cardRadio = card.querySelector('input[type="radio"]');
                const radioOutline = card.querySelector('.provider-radio');
                const radioDot = card.querySelector('.provider-radio-dot');
                
                // 重置样式
                radioOutline.classList.remove('border-apple-blue', 'dark:border-apple-darkblue');
                radioOutline.classList.add('border-gray-300', 'dark:border-gray-600');
                radioDot.classList.add('hidden');
                card.querySelector('label').classList.remove('border-apple-blue', 'dark:border-apple-darkblue');
            });
            
            // 设置选中的提供商卡片样式
            const card = radio.closest('.api-provider-card');
            const radioOutline = card.querySelector('.provider-radio');
            const radioDot = card.querySelector('.provider-radio-dot');
            
            radioOutline.classList.remove('border-gray-300', 'dark:border-gray-600');
            radioOutline.classList.add('border-apple-blue', 'dark:border-apple-darkblue');
            radioDot.classList.remove('hidden');
            card.querySelector('label').classList.add('border-apple-blue', 'dark:border-apple-darkblue');
        }
        
        // API提供商选择切换
        document.querySelectorAll('.api-provider-card input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', function() {
                // 更新单选按钮样式
                updateProviderRadioStyle(this);
                
                // 切换API设置面板
                const provider = this.value;
                toggleApiSettings(provider);
                
                // 隐藏测试结果
                document.getElementById('apiTestResult').classList.add('hidden');
            });
        });
        
        function toggleApiSettings(provider) {
            // 隐藏所有API设置
            document.querySelectorAll('.api-settings').forEach(setting => {
                setting.classList.add('hidden');
            });
            
            // 显示选中的API设置
            const settingsElement = document.getElementById(`${provider}-settings`);
            if (settingsElement) {
                settingsElement.classList.remove('hidden');
            } else {
                console.warn(`Settings panel for provider ${provider} not found`);
            }
        }
        
        // 主题卡片选择
        document.querySelectorAll('.theme-card').forEach(card => {
            card.addEventListener('click', function() {
                // 取消所有卡片选择
                document.querySelectorAll('.theme-card').forEach(c => {
                    c.classList.remove('theme-card-selected', 'ring-2');
                });
                
                // 选中当前卡片
                this.classList.add('theme-card-selected', 'ring-2');
                
                // 更新主题选择下拉框
                const themeValue = this.getAttribute('data-theme');
                document.getElementById('articleTheme').value = themeValue;
                
                // 更新文章预览区域的主题
                if (document.getElementById('articleOutput')) {
                    document.getElementById('articleOutput').className = '';
                    document.getElementById('articleOutput').classList.add(
                        `theme-${themeValue}`, 
                        'prose', 'dark:prose-invert', 'max-w-none', 
                        'border', 'border-gray-100', 'dark:border-gray-800', 
                        'p-6', 'rounded-xl', 'bg-white', 'dark:bg-gray-950', 
                        'overflow-auto'
                    );
                }
            });
        });
        
        // 下拉框主题选择与卡片联动
        document.getElementById('articleTheme').addEventListener('change', function() {
            const selectedTheme = this.value;
            
            // 更新主题卡片选择
            document.querySelectorAll('.theme-card').forEach(card => {
                if (card.getAttribute('data-theme') === selectedTheme) {
                    card.click();
                }
            });
        });

        // 参考链接验证
        document.getElementById('validateLinksBtn').addEventListener('click', async function() {
            const links = document.getElementById('referenceLinks').value;
            const resultDiv = document.getElementById('linkValidationResult');
            
            if (!links.trim()) {
                resultDiv.innerHTML = `
                    <div class="text-yellow-600 dark:text-yellow-400 text-sm flex items-center">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        <span>请输入至少一个网址进行验证</span>
                    </div>
                `;
                resultDiv.classList.remove('hidden');
                return;
            }
            
            // 显示加载状态
            resultDiv.innerHTML = `
                <div class="text-blue-600 dark:text-blue-400 text-sm flex items-center">
                    <div class="apple-spinner mr-2"></div>
                    <span>正在验证链接可访问性...</span>
                </div>
            `;
            resultDiv.classList.remove('hidden');
            
            const linkList = links.split('\n').filter(link => link.trim());
            const results = [];
            
            for (const link of linkList) {
                if (!link.trim()) continue;
                
                try {
                    // 简单验证URL格式
                    let isValid = link.startsWith('http://') || link.startsWith('https://');
                    let hasImages = false;
                    let error = isValid ? null : "无效的URL格式";
                    
                    // 如果URL格式有效，尝试发送请求
                    if (isValid) {
                        try {
                            // 使用API代理或直接fetch检查链接是否可访问
                            const apiConfig = JSON.parse(localStorage.getItem(API_CONFIG_KEY) || '{}');
                            const provider = apiConfig.provider || 'poe';
                            
                            if (provider === 'poe' && apiConfig.poe?.apiKey) {
                                const poeKey = apiConfig.poe.apiKey;
                                const model = apiConfig.poe.textModel || 'Claude-3.7-Sonnet';
                                
                                // 使用Poe API检查链接
                                const checkPrompt = `检查以下URL是否可访问，并判断是否包含图片。只返回一个JSON格式的结果，格式为{"isAccessible": true/false, "hasImages": true/false, "error": "错误信息或null"}。\n\nURL: ${link}`;
                                
                                const response = await fetch('https://api.poe.com/chat/completions', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${poeKey}`
                                    },
                                    body: JSON.stringify({
                                        model: model,
                                        messages: [
                                            { role: "user", content: checkPrompt }
                                        ]
                                    })
                                });
                                
                                if (response.ok) {
                                    const data = await response.json();
                                    const content = data.choices?.[0]?.message?.content || '';
                                    
                                    try {
                                        // 尝试解析返回的JSON
                                        const result = JSON.parse(content.replace(/```json|```/g, '').trim());
                                        isValid = result.isAccessible;
                                        hasImages = result.hasImages;
                                        error = result.error;
                                    } catch (e) {
                                        // JSON解析失败，使用默认值
                                        isValid = true;
                                        hasImages = Math.random() > 0.3;
                                        error = null;
                                    }
                                } else {
                                    // API调用失败，使用默认值
                                    isValid = true;
                                    hasImages = Math.random() > 0.3;
                                    error = null;
                                }
                            } else {
                                // 没有配置API，模拟验证
                                await new Promise(resolve => setTimeout(resolve, 500));
                                hasImages = Math.random() > 0.3;
                            }
                        } catch (e) {
                            // 请求出错，链接可能不可访问
                            isValid = false;
                            error = e.message || "链接不可访问";
                        }
                    }
                    
                    results.push({
                        link,
                        isValid,
                        hasImages,
                        error
                    });
                } catch (error) {
                    results.push({
                        link,
                        isValid: false,
                        hasImages: false,
                        error: error.message
                    });
                }
            }
            
            // 显示结果
            resultDiv.innerHTML = `
                <div class="text-sm mt-2">
                    <h4 class="font-medium mb-1">验证结果:</h4>
                    <ul class="space-y-1">
                        ${results.map(result => `
                            <li class="flex items-center">
                                <span class="${result.isValid ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                                    <i class="fas fa-${result.isValid ? 'check-circle' : 'times-circle'} mr-1"></i>
                                </span>
                                <span class="truncate" title="${result.link}">${result.link}</span>
                                ${result.isValid ? 
                                    `<span class="ml-2 ${result.hasImages ? 'text-green-600 dark:text-green-400' : 'text-yellow-600 dark:text-yellow-400'} text-xs">
                                        ${result.hasImages ? '含图片' : '未检测到图片'}
                                    </span>` : 
                                    `<span class="ml-2 text-red-600 dark:text-red-400 text-xs">${result.error}</span>`
                                }
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        });

        // 网页内容抓取功能
        document.getElementById('fetchContentBtn')?.addEventListener('click', async function() {
            const scrapeUrl = document.getElementById('scrapeUrl').value.trim();
            const scrapeResult = document.getElementById('scrapeResult');
            
            if (!scrapeUrl) {
                alert('请输入要抓取的网页URL');
                return;
            }
            
            // 支持多个链接，按行分割
            const urls = scrapeUrl.split(/[\n,]/).map(url => url.trim()).filter(url => url);
            
            if (urls.length === 0) {
                alert('请输入有效的URL');
                return;
            }
            
            // 显示加载状态
            scrapeResult.innerHTML = `
                <div class="flex items-center justify-center p-4">
                    <div class="apple-spinner mr-2"></div>
                    <span>正在抓取内容，请稍候...</span>
                </div>
            `;
            scrapeResult.classList.remove('hidden');
            
            try {
                let allContent = '';
                
                for (const url of urls) {
                    // 使用代理服务避免跨域问题
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    
                    const response = await fetch(proxyUrl);
                    if (!response.ok) {
                        throw new Error(`抓取失败: ${response.statusText}`);
                    }
                    
                    const html = await response.text();
                    
                    // 使用DOMParser解析HTML
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // 提取标题
                    const title = doc.querySelector('title')?.textContent || '无标题';
                    
                    // 提取正文内容 - 尝试多种选择器以适应不同网站
                    let content = '';
                    
                    // 尝试常见的文章内容容器
                    const contentSelectors = [
                        'article', '.article', '.post', '.content', '.entry-content', 
                        '.post-content', '.article-content', 'main', '#content', '#main'
                    ];
                    
                    for (const selector of contentSelectors) {
                        const element = doc.querySelector(selector);
                        if (element) {
                            // 只获取段落、标题等文本内容
                            const textElements = element.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li');
                            content = Array.from(textElements)
                                .map(el => el.textContent.trim())
                                .filter(text => text.length > 20) // 过滤掉太短的文本
                                .join('\n\n');
                            
                            if (content) break;
                        }
                    }
                    
                    // 如果上面的方法没有提取到内容，尝试获取所有段落
                    if (!content) {
                        const paragraphs = doc.querySelectorAll('p');
                        content = Array.from(paragraphs)
                            .map(p => p.textContent.trim())
                            .filter(text => text.length > 20)
                            .join('\n\n');
                    }
                    
                    // 添加到总内容中
                    allContent += `## ${title}\n\n${content}\n\n---\n\n`;
                }
                
                // 显示结果
                scrapeResult.innerHTML = `
                    <div class="p-3 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 rounded-xl mb-2">
                        <i class="fas fa-check-circle mr-2"></i>抓取成功，已提取文章内容
                    </div>
                    <div class="max-h-60 overflow-auto p-3 bg-gray-50 dark:bg-gray-800 rounded-xl text-sm">
                        <pre class="whitespace-pre-wrap">${allContent}</pre>
                    </div>
                    <div class="mt-2 flex justify-end">
                        <button id="useAsReferenceBtn" class="px-3 py-1.5 bg-apple-blue hover:bg-blue-600 dark:bg-apple-darkblue dark:hover:bg-blue-700 text-white rounded-lg text-sm">
                            <i class="fas fa-plus-circle mr-1"></i>添加为参考文本
                        </button>
                    </div>
                `;
                
                // 添加为参考文本的按钮事件
                document.getElementById('useAsReferenceBtn')?.addEventListener('click', function() {
                    const referenceText = document.getElementById('referenceText');
                    referenceText.value += (referenceText.value ? '\n\n' : '') + allContent;
                    alert('已添加到参考文本！');
                });
                
            } catch (error) {
                console.error('抓取内容错误:', error);
                scrapeResult.innerHTML = `
                    <div class="p-3 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 rounded-xl">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-circle mt-1 mr-2"></i>
                            <div>
                                <p class="font-medium">抓取失败</p>
                                <p class="text-sm mt-1">${error.message}</p>
                                <p class="text-sm mt-2">可能原因：</p>
                                <ul class="text-sm list-disc pl-5 mt-1">
                                    <li>网站禁止抓取或需要登录</li>
                                    <li>网络连接问题</li>
                                    <li>URL格式不正确</li>
                                    <li>网站结构复杂，无法提取内容</li>
                                </ul>
                                <p class="text-sm mt-2">建议尝试：</p>
                                <ul class="text-sm list-disc pl-5 mt-1">
                                    <li>直接复制网页内容到参考文本框</li>
                                    <li>使用其他浏览器插件抓取内容</li>
                                    <li>尝试其他网站</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
        });

        // 清空结果按钮
        document.getElementById('clearResultsBtn')?.addEventListener('click', function() {
            document.getElementById('scrapeResult').classList.add('hidden');
            document.getElementById('scrapeUrl').value = '';
        });

        // 文件上传处理
        document.getElementById('referenceFiles').addEventListener('change', function(e) {
            const uploadedFilesDiv = document.getElementById('uploadedFiles');
            uploadedFilesDiv.innerHTML = '';
            
            Array.from(this.files).forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between py-1.5 px-3 bg-apple-lightgray dark:bg-gray-800 rounded-lg';
                fileItem.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-file-alt text-apple-blue dark:text-apple-darkblue mr-2"></i>
                        <span class="text-sm truncate max-w-[200px]">${file.name}</span>
                        <span class="text-xs text-gray-500 ml-2">(${(file.size / 1024).toFixed(1)} KB)</span>
                    </div>
                    <button class="remove-file text-gray-400 hover:text-red-500">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                uploadedFilesDiv.appendChild(fileItem);
            });
            
            // 为移除按钮添加事件
            document.querySelectorAll('.remove-file').forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('div').remove();
                });
            });
        });

        // 初始化图片设置
        const imageUploadSettings = document.getElementById('imageUploadSettings');
        // 显示图片上传设置
        imageUploadSettings.classList.remove('hidden');

        // Markdown编辑工具栏功能
        function wrapSelectedText(textarea, beforeText, afterText) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const replacement = beforeText + selectedText + afterText;
            
            textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
            
            // 恢复选择区域
            textarea.focus();
            textarea.setSelectionRange(start + beforeText.length, start + beforeText.length + selectedText.length);
        }
        
        document.getElementById('formatBoldBtn')?.addEventListener('click', function() {
            const textarea = document.getElementById('articleEditArea');
            wrapSelectedText(textarea, '**', '**');
        });
        
        document.getElementById('formatItalicBtn')?.addEventListener('click', function() {
            const textarea = document.getElementById('articleEditArea');
            wrapSelectedText(textarea, '*', '*');
        });
        
        document.getElementById('formatLinkBtn')?.addEventListener('click', function() {
            const textarea = document.getElementById('articleEditArea');
            wrapSelectedText(textarea, '[', '](https://example.com)');
        });
        
        document.getElementById('formatH2Btn')?.addEventListener('click', function() {
            const textarea = document.getElementById('articleEditArea');
            const start = textarea.selectionStart;
            const lineStart = textarea.value.lastIndexOf('\n', start - 1) + 1;
            const beforeText = textarea.value.substring(0, lineStart);
            const afterText = textarea.value.substring(lineStart);
            
            textarea.value = beforeText + '## ' + afterText;
            textarea.focus();
            textarea.setSelectionRange(lineStart + 3, lineStart + 3);
        });
        
        document.getElementById('formatQuoteBtn')?.addEventListener('click', function() {
            const textarea = document.getElementById('articleEditArea');
            const start = textarea.selectionStart;
            const lineStart = textarea.value.lastIndexOf('\n', start - 1) + 1;
            const beforeText = textarea.value.substring(0, lineStart);
            const afterText = textarea.value.substring(lineStart);
            
            textarea.value = beforeText + '> ' + afterText;
            textarea.focus();
            textarea.setSelectionRange(lineStart + 2, lineStart + 2);
        });

        // 从参考链接提取图片
        async function extractImagesFromLinks(links, count) {
            const statusText = document.getElementById('statusText');
            statusText.textContent = '正在从参考链接提取图片...';
            
            try {
                // 获取API配置
                const apiConfig = JSON.parse(localStorage.getItem(API_CONFIG_KEY) || '{}');
                
                // 优先使用Extract API提取图片，如果配置了Extract API
                const extractKey = apiConfig.extract?.apiKey;
                const extractEndpoint = apiConfig.extract?.apiEndpoint;
                
                if (extractKey && extractEndpoint) {
                    // Extract API实现
                    const maxImages = apiConfig.extract?.maxImages || 10;
                    const imageQuality = apiConfig.extract?.imageQuality || 'medium';
                    
                    if (!extractKey || !extractEndpoint) {
                        throw new Error("未配置Extract API密钥或端点");
                    }
                    
                    // 添加重试机制
                    const maxRetries = 3;
                    let retryCount = 0;
                    let lastError = null;
                    
                    while (retryCount < maxRetries) {
                        try {
                            // 调用Extract API
                            const response = await fetch(extractEndpoint, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${extractKey}`
                                },
                                body: JSON.stringify({
                                    url: links,
                                    max_images: Math.min(count, maxImages),
                                    quality: imageQuality
                                }),
                                // 添加超时设置
                                timeout: 30000 // 30秒超时
                            });
                            
                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({}));
                                throw new Error(`Extract API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                            }
                            
                            const data = await response.json();
                            const urls = data.images || [];
                            
                            if (urls.length === 0) {
                                throw new Error("未从链接中提取到任何图片");
                            }
                            
                            // 验证图片URL是否可访问
                            const validUrls = [];
                            for (const url of urls) {
                                try {
                                    const imgResponse = await fetch(url, { method: 'HEAD', timeout: 5000 });
                                    if (imgResponse.ok) {
                                        validUrls.push(url);
                                    }
                                } catch (e) {
                                    console.warn(`图片URL验证失败: ${url}`, e);
                                    // 继续处理下一个URL
                                }
                            }
                            
                            if (validUrls.length === 0) {
                                throw new Error("提取的图片URL无法访问");
                            }
                            
                            return validUrls.slice(0, count);
                        } catch (error) {
                            lastError = error;
                            retryCount++;
                            if (retryCount < maxRetries) {
                                console.log(`图片提取失败，正在重试 (${retryCount}/${maxRetries})...`);
                                await new Promise(resolve => setTimeout(resolve, 1000 * retryCount)); // 递增延迟
                            }
                        }
                    }
                    
                    // 所有重试都失败了
                    throw lastError || new Error("图片提取失败，请稍后重试");
                }
                else if (provider === 'poe') {
                    // Poe API实现
                    const poeKey = apiConfig.poe?.apiKey;
                    if (!poeKey) {
                        throw new Error("未配置Poe API密钥");
                    }
                    
                    const model = apiConfig.poe?.textModel || 'claude-3-opus-20240229';
                    const prompt = `请从以下链接中提取${count}张图片的URL地址，只返回图片URL列表，每行一个URL，不要有任何解释或其他输出：\n\n${links}\n\n注意：只提供原始图片URL，每个URL独占一行，不要有多余文字，不要有编号，不要有Markdown格式。`;
                    
                    // 调用Poe API
                    const response = await fetch('https://api.poe.com/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${poeKey}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: "user", content: prompt }
                            ]
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`Poe API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content || '';
                    
                    // 解析图片URL
                    const urls = content.split('\n')
                        .map(url => url.trim())
                        .filter(url => url.startsWith('http') && 
                            (url.includes('.jpg') || url.includes('.jpeg') || 
                             url.includes('.png') || url.includes('.gif') || 
                             url.includes('.webp')));
                    
                    if (urls.length === 0) {
                        throw new Error("未从参考链接中找到可用的图片");
                    }
                    
                    return urls.slice(0, count);
                }
                // 这里可以添加其他API提供商的实现
                else if (provider === 'openai') {
                    // OpenAI API实现
                    const openaiKey = apiConfig.openai?.apiKey;
                    if (!openaiKey) {
                        throw new Error("未配置OpenAI API密钥");
                    }
                    
                    const model = apiConfig.openai?.textModel || 'gpt-4';
                    const prompt = `请从以下链接中提取${count}张图片的URL地址，只返回图片URL列表，每行一个URL，不要有任何解释或其他输出：\n\n${links}\n\n注意：只提供原始图片URL，每个URL独占一行，不要有多余文字，不要有编号，不要有Markdown格式。`;
                    
                    // 根据是否设置了代理来确定API端点
                    const apiProxy = apiConfig.openai?.apiProxy;
                    const apiEndpoint = apiProxy ? apiProxy : 'https://api.openai.com/v1/chat/completions';
                    
                    // 调用OpenAI API
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${openaiKey}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: "user", content: prompt }
                            ]
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`OpenAI API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content || '';
                    
                    // 解析图片URL
                    const urls = content.split('\n')
                        .map(url => url.trim())
                        .filter(url => url.startsWith('http') && 
                            (url.includes('.jpg') || url.includes('.jpeg') || 
                             url.includes('.png') || url.includes('.gif') || 
                             url.includes('.webp')));
                    
                    if (urls.length === 0) {
                        throw new Error("未从参考链接中找到可用的图片");
                    }
                    
                    return urls.slice(0, count);
                }
                // 月之暗面API测试实现
                else if (provider === 'moonshot') {
                    const moonshotKey = apiConfig.moonshot?.apiKey;
                    if (!moonshotKey) {
                        throw new Error("未配置月之暗面API密钥");
                    }
                    
                    // 根据是否设置了代理来确定API端点
                    const apiProxy = apiConfig.moonshot?.apiProxy;
                    const apiEndpoint = apiProxy ? apiProxy : 'https://api.moonshot.cn/v1/chat/completions';
                    
                    // 发送简单请求测试API连接
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${moonshotKey}`
                        },
                        body: JSON.stringify({
                            model: "moonshot-v1-8k",
                            messages: [
                                { role: "user", content: "Hello, just testing the API connection. Please respond with 'API connection successful'." }
                            ],
                            max_tokens: 10
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`月之暗面API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    return true;
                }
                // One API实现
                else if (provider === 'oneapi') {
                    const oneapiKey = apiConfig.oneapi?.apiKey;
                    if (!oneapiKey) {
                        throw new Error("未配置One API密钥");
                    }
                    
                    // 获取基础URL
                    const baseUrl = apiConfig.oneapi?.baseUrl;
                    if (!baseUrl) {
                        throw new Error("未配置One API基础URL");
                    }
                    
                    const providerName = apiConfig.oneapi?.providerName || '';
                    const model = apiConfig.oneapi?.model || 'gpt-4-turbo';
                    const temperature = apiConfig.oneapi?.temperature || 0.7;
                    const maxTokens = apiConfig.oneapi?.maxTokens || 4000;
                    const topP = apiConfig.oneapi?.topP || 0.9;
                    
                    // 构建API端点
                    const apiEndpoint = `${baseUrl.replace(/\/$/, '')}/v1/chat/completions`;
                    
                    // 准备请求头，如果有自定义服务商名称，则添加到请求头中
                    const headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${oneapiKey}`
                    };
                    
                    if (providerName) {
                        headers['Provider'] = providerName;
                    }
                    
                    // 调用One API
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: "user", content: fullPrompt }
                            ],
                            temperature: temperature,
                            max_tokens: maxTokens,
                            top_p: topP
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`One API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content || '';
                    
                    // 添加标题，如果还没有标题且用户提供了标题
                    if (title && !content.startsWith('# ')) {
                        return `# ${title}\n\n${content}`;
                    }
                    
                    return content;
                }
                // 月之暗面API实现
                else if (provider === 'moonshot') {
                    const moonshotKey = apiConfig.moonshot?.apiKey;
                    if (!moonshotKey) {
                        throw new Error("未配置月之暗面API密钥");
                    }
                    
                    const model = apiConfig.moonshot?.model || 'moonshot-v1-8k';
                    const temperature = apiConfig.moonshot?.temperature || 0.7;
                    const maxTokens = apiConfig.moonshot?.maxTokens || 4000;
                    const topP = apiConfig.moonshot?.topP || 0.95;
                    
                    // 根据是否设置了代理来确定API端点
                    const apiProxy = apiConfig.moonshot?.apiProxy;
                    const apiEndpoint = apiProxy ? apiProxy : 'https://api.moonshot.cn/v1/chat/completions';
                    
                    // 调用月之暗面API
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${moonshotKey}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: "user", content: fullPrompt }
                            ],
                            temperature: temperature,
                            max_tokens: maxTokens,
                            top_p: topP
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`月之暗面API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content || '';
                    
                    // 添加标题，如果还没有标题且用户提供了标题
                    if (title && !content.startsWith('# ')) {
                        return `# ${title}\n\n${content}`;
                    }
                    
                    return content;
                }
                else {
                    throw new Error(`不支持的API提供商: ${provider}`);
                }
            } catch (error) {
                console.error("提取图片错误:", error);
                document.getElementById('generationStatus').classList.add('hidden');
                
                // 显示详细错误提示
                const alertDiv = document.createElement('div');
                alertDiv.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';
                alertDiv.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl max-w-lg w-full shadow-xl">
                        <h3 class="text-xl font-semibold mb-4 flex items-center text-red-600 dark:text-red-400">
                            <i class="fas fa-exclamation-circle mr-2"></i>链接图片提取失败
                        </h3>
                        <p class="mb-4">错误详情: ${error.message}</p>
                        <p class="mb-4">可能的原因：</p>
                        <ul class="list-disc pl-5 mb-4">
                            <li>API密钥无效或已过期</li>
                            <li>链接不可访问或已失效</li>
                            <li>链接中不包含可提取的图片</li>
                            <li>链接网站限制了图片访问</li>
                        </ul>
                        <p class="mb-4">建议尝试：</p>
                        <ul class="list-disc pl-5 mb-6">
                            <li>检查API配置并重试</li>
                            <li>使用"验证链接"功能检查链接可访问性</li>
                            <li>尝试其他包含图片的链接</li>
                            <li>切换到AI生成图片模式</li>
                        </ul>
                        <div class="flex justify-end">
                            <button id="closeAlertBtn" class="px-4 py-2 bg-apple-blue text-white rounded-lg">
                                我知道了
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(alertDiv);
                
                // 添加关闭按钮事件
                document.getElementById('closeAlertBtn').addEventListener('click', () => {
                    document.body.removeChild(alertDiv);
                });
                
                return [];
            }
        }

        // 将图片插入到文章中
        function insertImagesIntoArticle(images, insertMode) {
            const articleOutput = document.getElementById('articleOutput');
            const paragraphs = articleOutput.querySelectorAll('p, h2, h3');
            
            if (paragraphs.length === 0 || images.length === 0) return;
            
            // 处理上传的图片数组
            const imageUrls = Array.isArray(images) ? images : [images];
            
            if (insertMode === 'even') {
                // 均匀分布插入
                const step = Math.floor(paragraphs.length / (imageUrls.length + 1));
                let positions = [];
                
                for (let i = 1; i <= imageUrls.length; i++) {
                    let pos = i * step;
                    if (pos >= paragraphs.length) pos = paragraphs.length - 1;
                    positions.push(pos);
                }
                
                // 插入图片
                positions.forEach((position, index) => {
                    if (index < imageUrls.length && position < paragraphs.length) {
                        const imgElement = document.createElement('img');
                        imgElement.src = imageUrls[index];
                        imgElement.alt = '文章配图';
                        imgElement.className = 'mx-auto my-4 max-w-full h-auto';
                        
                        paragraphs[position].parentNode.insertBefore(imgElement, paragraphs[position].nextSibling);
                    }
                });
            } else {
                // 随机分布插入
                let availablePositions = [...Array(paragraphs.length).keys()];
                let positions = [];
                
                // 随机选择位置
                for (let i = 0; i < imageUrls.length; i++) {
                    if (availablePositions.length === 0) break;
                    
                    const randomIndex = Math.floor(Math.random() * availablePositions.length);
                    positions.push(availablePositions[randomIndex]);
                    availablePositions.splice(randomIndex, 1);
                }
                
                // 排序位置，从后往前插入，避免位置变化
                positions.sort((a, b) => b - a);
                
                // 插入图片
                positions.forEach((position, index) => {
                    if (index < imageUrls.length && position < paragraphs.length) {
                        const imgElement = document.createElement('img');
                        imgElement.src = imageUrls[index];
                        imgElement.alt = '文章配图';
                        imgElement.className = 'mx-auto my-4 max-w-full h-auto';
                        
                        paragraphs[position].parentNode.insertBefore(imgElement, paragraphs[position].nextSibling);
                    }
                });
            }
        }

        // 生成文章 - 真实API实现
        async function generateArticle(title, prompt, length, referenceLinks, referenceText) {
            // 获取API配置
            const apiConfig = JSON.parse(localStorage.getItem(API_CONFIG_KEY) || '{}');
            const provider = apiConfig.provider || 'poe';
            
            // 构建提示词
            let fullPrompt = `我需要你帮我写一篇专业的文章`;
            
            if (title) {
                fullPrompt += `，标题是：${title}`;
            }
            
            fullPrompt += `\n\n我希望这篇文章是`;
            switch (length) {
                case 'short': fullPrompt += '短文（800-1200字）'; break;
                case 'medium': fullPrompt += '中等长度（1500-2500字）'; break;
                case 'long': fullPrompt += '长文（3000字以上）'; break;
            }
            
            if (prompt) {
                fullPrompt += `\n\n文章需求：${prompt}`;
            }
            
            if (referenceLinks || referenceText) {
                fullPrompt += '\n\n以下是参考资料：\n';
                
                if (referenceLinks) {
                    fullPrompt += `\n参考链接：\n${referenceLinks}\n`;
                }
                
                if (referenceText) {
                    fullPrompt += `\n参考文本：\n${referenceText}\n`;
                }
            }
            
            fullPrompt += `\n请按照以下要求输出：
1. 用markdown格式生成一篇这样风格的文章,严格按照给出的标题创作文章,直接给出文章内容即可,不需要给出任何解释说明
2. 正文内容包含引人入胜的开头、清晰的论点和总结
3. 全文二级标题保持2-5个，禁止太多二级标题，每个二级标题下面要包含2-4个自然段，段落内容详实，有价值，加入小标题和分段，使文章结构清晰
4. 适当加入引用、列表等元素增加可读性,信息量要大，内容充实有价值，重要的观点或内容进行加粗。
5. 保持文章原创度，确保独特性，禁止一切形式的抄袭和直接翻译
6. 不需要顶部标题，我会单独处理`;
            
            try {
                if (provider === 'poe') {
                    // Poe API实现
                    const poeKey = apiConfig.poe?.apiKey;
                    if (!poeKey) {
                        throw new Error("未配置Poe API密钥");
                    }
                    
                    const model = apiConfig.poe?.textModel || 'claude-3-opus-20240229';
                    
                    // 调用Poe API
                    const response = await fetch('https://api.poe.com/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${poeKey}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: "user", content: fullPrompt }
                            ]
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`Poe API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content || '';
                    
                    // 添加标题，如果还没有标题且用户提供了标题
                    if (title && !content.startsWith('# ')) {
                        return `# ${title}\n\n${content}`;
                    }
                    
                    return content;
                }
                // Anthropic API实现
                else if (provider === 'anthropic') {
                    const anthropicKey = apiConfig.anthropic?.apiKey;
                    if (!anthropicKey) {
                        throw new Error("未配置Anthropic API密钥");
                    }
                    
                    const model = apiConfig.anthropic?.model || 'claude-3-opus-20240229';
                    
                    // 根据是否设置了代理来确定API端点
                    const apiProxy = apiConfig.anthropic?.apiProxy;
                    const apiEndpoint = apiProxy ? apiProxy : 'https://api.anthropic.com/v1/messages';
                    
                    // 调用Anthropic API
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': anthropicKey,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: "user", content: fullPrompt }
                            ],
                            max_tokens: 4000
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`Anthropic API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    const data = await response.json();
                    const content = data.content?.[0]?.text || '';
                    
                    // 添加标题，如果还没有标题且用户提供了标题
                    if (title && !content.startsWith('# ')) {
                        return `# ${title}\n\n${content}`;
                    }
                    
                    return content;
                }
                // Anthropic API图像生成实现
                else if (provider === 'anthropic') {
                    const anthropicKey = apiConfig.anthropic?.apiKey;
                    if (!anthropicKey) {
                        throw new Error("未配置Anthropic API密钥");
                    }
                    
                    const model = apiConfig.anthropic?.model || 'claude-3-opus-20240229';
                    const generatedUrls = [];
                    
                    // 为每个图片发送请求
                    for (let i = 0; i < count; i++) {
                        // 调用Anthropic API生成图片
                        const response = await fetch('https://api.anthropic.com/v1/messages', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-api-key': anthropicKey,
                                'anthropic-version': '2023-06-01'
                            },
                            body: JSON.stringify({
                                model: model,
                                messages: [
                                    { role: "user", content: `请生成一张符合以下描述的图片：${prompt}。请使用Markdown格式返回图片链接。` }
                                ],
                                max_tokens: 1000
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(`Anthropic API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                        }
                        
                        const data = await response.json();
                        const content = data.content?.[0]?.text || '';
                        
                        // 从响应内容中提取图片URL
                        const markdownImageMatch = content.match(/!\[.*?\]\((https?:\/\/[^\s"')]+\.(jpg|jpeg|png|gif|webp|avif))\)/i);
                        const urlMatch = content.match(/https?:\/\/[^\s"')]+\.(jpg|jpeg|png|gif|webp|avif)/gi);
                        
                        if (markdownImageMatch && markdownImageMatch[1]) {
                            generatedUrls.push(markdownImageMatch[1]);
                        } else if (urlMatch && urlMatch.length > 0) {
                            generatedUrls.push(urlMatch[0]);
                        } else {
                            console.warn("无法从Anthropic响应中提取图片URL");
                        }
                    }
                    
                    return generatedUrls;
                }
                // OpenAI API图像生成实现
                else if (provider === 'openai') {
                    // OpenAI API实现
                    const openaiKey = apiConfig.openai?.apiKey;
                    if (!openaiKey) {
                        throw new Error("未配置OpenAI API密钥");
                    }
                    
                    const model = apiConfig.openai?.textModel || 'gpt-4';
                    const temperature = apiConfig.openai?.temperature || 0.7;
                    const maxTokens = apiConfig.openai?.maxTokens || 4000;
                    
                    // 根据是否设置了代理来确定API端点
                    const apiProxy = apiConfig.openai?.apiProxy;
                    const apiEndpoint = apiProxy ? apiProxy : 'https://api.openai.com/v1/chat/completions';
                    
                    // 调用OpenAI API
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${openaiKey}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: "user", content: fullPrompt }
                            ],
                            temperature: temperature,
                            max_tokens: maxTokens
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`OpenAI API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content || '';
                    
                    // 添加标题，如果还没有标题且用户提供了标题
                    if (title && !content.startsWith('# ')) {
                        return `# ${title}\n\n${content}`;
                    }
                    
                    return content;
                }
                // DeepSeek API实现
                else if (provider === 'deepseek') {
                    const deepseekKey = apiConfig.deepseek?.apiKey;
                    if (!deepseekKey) {
                        throw new Error("未配置DeepSeek API密钥");
                    }
                    
                    const model = apiConfig.deepseek?.model || 'deepseek-chat';
                    const temperature = apiConfig.deepseek?.temperature || 0.7;
                    const maxTokens = apiConfig.deepseek?.maxTokens || 4000;
                    const topP = apiConfig.deepseek?.topP || 0.9;
                    
                    // 根据是否设置了代理来确定API端点
                    const apiProxy = apiConfig.deepseek?.apiProxy;
                    const apiEndpoint = apiProxy ? apiProxy : 'https://api.deepseek.com/v1/chat/completions';
                    
                    // 调用DeepSeek API
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${deepseekKey}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: "user", content: fullPrompt }
                            ],
                            temperature: temperature,
                            max_tokens: maxTokens,
                            top_p: topP
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`DeepSeek API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content || '';
                    
                    // 添加标题，如果还没有标题且用户提供了标题
                    if (title && !content.startsWith('# ')) {
                        return `# ${title}\n\n${content}`;
                    }
                    
                    return content;
                }
                // 月之暗面API测试实现
                else if (provider === 'moonshot') {
                    const moonshotKey = apiConfig.moonshot?.apiKey;
                    if (!moonshotKey) {
                        throw new Error("未配置月之暗面API密钥");
                    }
                    
                    // 根据是否设置了代理来确定API端点
                    const apiProxy = apiConfig.moonshot?.apiProxy;
                    const apiEndpoint = apiProxy ? apiProxy : 'https://api.moonshot.cn/v1/chat/completions';
                    
                    // 发送简单请求测试API连接
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${moonshotKey}`
                        },
                        body: JSON.stringify({
                            model: "moonshot-v1-8k",
                            messages: [
                                { role: "user", content: "Hello, just testing the API connection. Please respond with 'API connection successful'." }
                            ],
                            max_tokens: 10
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`月之暗面API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    return true;
                }
                // One API实现
                else if (provider === 'oneapi') {
                    const oneapiKey = apiConfig.oneapi?.apiKey;
                    if (!oneapiKey) {
                        throw new Error("未配置One API密钥");
                    }
                    
                    // 获取基础URL
                    const baseUrl = apiConfig.oneapi?.baseUrl;
                    if (!baseUrl) {
                        throw new Error("未配置One API基础URL");
                    }
                    
                    const providerName = apiConfig.oneapi?.providerName || '';
                    const model = apiConfig.oneapi?.model || 'gpt-4-turbo';
                    const temperature = apiConfig.oneapi?.temperature || 0.7;
                    const maxTokens = apiConfig.oneapi?.maxTokens || 4000;
                    const topP = apiConfig.oneapi?.topP || 0.9;
                    
                    // 构建API端点
                    const apiEndpoint = `${baseUrl.replace(/\/$/, '')}/v1/chat/completions`;
                    
                    // 准备请求头，如果有自定义服务商名称，则添加到请求头中
                    const headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${oneapiKey}`
                    };
                    
                    if (providerName) {
                        headers['Provider'] = providerName;
                    }
                    
                    // 调用One API
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: "user", content: fullPrompt }
                            ],
                            temperature: temperature,
                            max_tokens: maxTokens,
                            top_p: topP
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`One API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content || '';
                    
                    // 添加标题，如果还没有标题且用户提供了标题
                    if (title && !content.startsWith('# ')) {
                        return `# ${title}\n\n${content}`;
                    }
                    
                    return content;
                }
                // 月之暗面API实现
                else if (provider === 'moonshot') {
                    const moonshotKey = apiConfig.moonshot?.apiKey;
                    if (!moonshotKey) {
                        throw new Error("未配置月之暗面API密钥");
                    }
                    
                    const model = apiConfig.moonshot?.model || 'moonshot-v1-8k';
                    const temperature = apiConfig.moonshot?.temperature || 0.7;
                    const maxTokens = apiConfig.moonshot?.maxTokens || 4000;
                    const topP = apiConfig.moonshot?.topP || 0.95;
                    
                    // 根据是否设置了代理来确定API端点
                    const apiProxy = apiConfig.moonshot?.apiProxy;
                    const apiEndpoint = apiProxy ? apiProxy : 'https://api.moonshot.cn/v1/chat/completions';
                    
                    // 调用月之暗面API
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${moonshotKey}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: "user", content: fullPrompt }
                            ],
                            temperature: temperature,
                            max_tokens: maxTokens,
                            top_p: topP
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`月之暗面API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content || '';
                    
                    // 添加标题，如果还没有标题且用户提供了标题
                    if (title && !content.startsWith('# ')) {
                        return `# ${title}\n\n${content}`;
                    }
                    
                    return content;
                }
                else {
                    throw new Error(`不支持的API提供商: ${provider}`);
                }
            } catch (error) {
                console.error("生成文章错误:", error);
                throw error;
            }
        }

        // 生成图片 - 真实API实现
        async function generateAIImages(prompt, count, aspectRatio) {
            // 获取API配置
            const apiConfig = JSON.parse(localStorage.getItem(API_CONFIG_KEY) || '{}');
            const provider = apiConfig.provider || 'poe';
            
            try {
                if (provider === 'poe') {
                    // Poe API实现
                    const poeKey = apiConfig.poe?.apiKey;
                    if (!poeKey) {
                        throw new Error("未配置Poe API密钥");
                    }
                    
                    const imageModel = apiConfig.poe?.imageModel || 'claude-3-opus-20240229';
                    const generatedUrls = [];
                    
                    // 为每个图片发送请求
                    for (let i = 0; i < count; i++) {
                        const finalPrompt = `${prompt} --aspect ${aspectRatio}`;
                        
                        // 调用Poe API生成图片
                        const response = await fetch('https://api.poe.com/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${poeKey}`
                            },
                            body: JSON.stringify({
                                model: imageModel,
                                messages: [
                                    { role: "user", content: finalPrompt }
                                ]
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(`Poe API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                        }
                        
                        const data = await response.json();
                        const content = data.choices?.[0]?.message?.content || '';
                        
                        // 从响应内容中提取图片URL
                        // 使用更健壮的正则表达式来匹配图片URL
                        const imageUrlMatches = content.match(/https?:\/\/[^\s"']+\.(jpg|jpeg|png|gif|webp|avif)/gi);
                        
                        if (imageUrlMatches && imageUrlMatches.length > 0) {
                            generatedUrls.push(imageUrlMatches[0]);
                        } else {
                            // 尝试查找Markdown图片格式
                            const markdownImageMatch = content.match(/!\[.*?\]\((https?:\/\/[^\s"')]+\.(jpg|jpeg|png|gif|webp|avif))\)/i);
                            if (markdownImageMatch && markdownImageMatch[1]) {
                                generatedUrls.push(markdownImageMatch[1]);
                            } else {
                                console.warn("无法从响应中提取图片URL");
                            }
                        }
                    }
                    
                    return generatedUrls;
                }
                // Anthropic API实现
                else if (provider === 'anthropic') {
                    const anthropicKey = apiConfig.anthropic?.apiKey;
                    if (!anthropicKey) {
                        throw new Error("未配置Anthropic API密钥");
                    }
                    
                    const model = apiConfig.anthropic?.model || 'claude-3-opus-20240229';
                    
                    // 根据是否设置了代理来确定API端点
                    const apiProxy = apiConfig.anthropic?.apiProxy;
                    const apiEndpoint = apiProxy ? apiProxy : 'https://api.anthropic.com/v1/messages';
                    
                    // 调用Anthropic API
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': anthropicKey,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: "user", content: fullPrompt }
                            ],
                            max_tokens: 4000
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`Anthropic API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    const data = await response.json();
                    const content = data.content?.[0]?.text || '';
                    
                    // 添加标题，如果还没有标题且用户提供了标题
                    if (title && !content.startsWith('# ')) {
                        return `# ${title}\n\n${content}`;
                    }
                    
                    return content;
                }
                // Anthropic API图像生成实现
                else if (provider === 'anthropic') {
                    const anthropicKey = apiConfig.anthropic?.apiKey;
                    if (!anthropicKey) {
                        throw new Error("未配置Anthropic API密钥");
                    }
                    
                    const model = apiConfig.anthropic?.model || 'claude-3-opus-20240229';
                    const generatedUrls = [];
                    
                    // 为每个图片发送请求
                    for (let i = 0; i < count; i++) {
                        // 调用Anthropic API生成图片
                        const response = await fetch('https://api.anthropic.com/v1/messages', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-api-key': anthropicKey,
                                'anthropic-version': '2023-06-01'
                            },
                            body: JSON.stringify({
                                model: model,
                                messages: [
                                    { role: "user", content: `请生成一张符合以下描述的图片：${prompt}。请使用Markdown格式返回图片链接。` }
                                ],
                                max_tokens: 1000
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(`Anthropic API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                        }
                        
                        const data = await response.json();
                        const content = data.content?.[0]?.text || '';
                        
                        // 从响应内容中提取图片URL
                        const markdownImageMatch = content.match(/!\[.*?\]\((https?:\/\/[^\s"')]+\.(jpg|jpeg|png|gif|webp|avif))\)/i);
                        const urlMatch = content.match(/https?:\/\/[^\s"')]+\.(jpg|jpeg|png|gif|webp|avif)/gi);
                        
                        if (markdownImageMatch && markdownImageMatch[1]) {
                            generatedUrls.push(markdownImageMatch[1]);
                        } else if (urlMatch && urlMatch.length > 0) {
                            generatedUrls.push(urlMatch[0]);
                        } else {
                            console.warn("无法从Anthropic响应中提取图片URL");
                        }
                    }
                    
                    return generatedUrls;
                }
                // OpenAI API图像生成实现
                else if (provider === 'openai') {
                    // OpenAI API图像生成实现
                    const openaiKey = apiConfig.openai?.apiKey;
                    if (!openaiKey) {
                        throw new Error("未配置OpenAI API密钥");
                    }
                    
                    const imageModel = apiConfig.openai?.imageModel || 'dall-e-3';
                    
                    // 转换纵横比
                    let size = '1024x1024'; // 默认大小
                    if (aspectRatio === '16:9') {
                        size = '1792x1024';
                    } else if (aspectRatio === '4:3') {
                        size = '1024x768';
                    } else if (aspectRatio === '1:1') {
                        size = '1024x1024';
                    } else if (aspectRatio === '3:4') {
                        size = '768x1024';
                    } else if (aspectRatio === '9:16') {
                        size = '1024x1792';
                    }
                    
                    // 根据是否设置了代理来确定API端点
                    const apiProxy = apiConfig.openai?.apiProxy;
                    const apiEndpoint = apiProxy ? apiProxy : 'https://api.openai.com/v1/images/generations';
                    
                    const generatedUrls = [];
                    
                    // 为每个图片发送请求
                    for (let i = 0; i < count; i++) {
                        // 调用OpenAI API生成图片
                        const response = await fetch(apiEndpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${openaiKey}`
                            },
                            body: JSON.stringify({
                                model: imageModel,
                                prompt: prompt,
                                n: 1,
                                size: size,
                                response_format: 'url'
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(`OpenAI API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                        }
                        
                        const data = await response.json();
                        if (data.data && data.data.length > 0) {
                            generatedUrls.push(data.data[0].url);
                        }
                    }
                    
                    return generatedUrls;
                }
                // DeepSeek API图像生成实现
                else if (provider === 'deepseek') {
                    const deepseekKey = apiConfig.deepseek?.apiKey;
                    if (!deepseekKey) {
                        throw new Error("未配置DeepSeek API密钥");
                    }
                    
                    const model = apiConfig.deepseek?.model || 'deepseek-chat';
                    const generatedUrls = [];
                    
                    // 根据是否设置了代理来确定API端点
                    const apiProxy = apiConfig.deepseek?.apiProxy;
                    const apiEndpoint = apiProxy ? apiProxy : 'https://api.deepseek.com/v1/chat/completions';
                    
                    // 为每个图片发送请求
                    for (let i = 0; i < count; i++) {
                        const finalPrompt = `请生成一张符合以下描述的图片：${prompt}。图片比例为${aspectRatio}。请使用Markdown格式返回图片链接。`;
                        
                        // 调用DeepSeek API生成图片
                        const response = await fetch(apiEndpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${deepseekKey}`
                            },
                            body: JSON.stringify({
                                model: model,
                                messages: [
                                    { role: "user", content: finalPrompt }
                                ],
                                max_tokens: 1000
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(`DeepSeek API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                        }
                        
                        const data = await response.json();
                        const content = data.choices?.[0]?.message?.content || '';
                        
                        // 从响应内容中提取图片URL
                        const markdownImageMatch = content.match(/!\[.*?\]\((https?:\/\/[^\s"')]+\.(jpg|jpeg|png|gif|webp|avif))\)/i);
                        const urlMatch = content.match(/https?:\/\/[^\s"')]+\.(jpg|jpeg|png|gif|webp|avif)/gi);
                        
                        if (markdownImageMatch && markdownImageMatch[1]) {
                            generatedUrls.push(markdownImageMatch[1]);
                        } else if (urlMatch && urlMatch.length > 0) {
                            generatedUrls.push(urlMatch[0]);
                        } else {
                            console.warn("无法从DeepSeek响应中提取图片URL");
                        }
                    }
                    
                    return generatedUrls;
                }
                // 月之暗面API测试实现
                else if (provider === 'moonshot') {
                    const moonshotKey = apiConfig.moonshot?.apiKey;
                    if (!moonshotKey) {
                        throw new Error("未配置月之暗面API密钥");
                    }
                    
                    // 根据是否设置了代理来确定API端点
                    const apiProxy = apiConfig.moonshot?.apiProxy;
                    const apiEndpoint = apiProxy ? apiProxy : 'https://api.moonshot.cn/v1/chat/completions';
                    
                    // 发送简单请求测试API连接
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${moonshotKey}`
                        },
                        body: JSON.stringify({
                            model: "moonshot-v1-8k",
                            messages: [
                                { role: "user", content: "Hello, just testing the API connection. Please respond with 'API connection successful'." }
                            ],
                            max_tokens: 10
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`月之暗面API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    return true;
                }
                // One API实现
                else if (provider === 'oneapi') {
                    const oneapiKey = apiConfig.oneapi?.apiKey;
                    if (!oneapiKey) {
                        throw new Error("未配置One API密钥");
                    }
                    
                    // 获取基础URL
                    const baseUrl = apiConfig.oneapi?.baseUrl;
                    if (!baseUrl) {
                        throw new Error("未配置One API基础URL");
                    }
                    
                    const providerName = apiConfig.oneapi?.providerName || '';
                    const model = apiConfig.oneapi?.model || 'gpt-4-turbo';
                    const temperature = apiConfig.oneapi?.temperature || 0.7;
                    const maxTokens = apiConfig.oneapi?.maxTokens || 4000;
                    const topP = apiConfig.oneapi?.topP || 0.9;
                    
                    // 构建API端点
                    const apiEndpoint = `${baseUrl.replace(/\/$/, '')}/v1/chat/completions`;
                    
                    // 准备请求头，如果有自定义服务商名称，则添加到请求头中
                    const headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${oneapiKey}`
                    };
                    
                    if (providerName) {
                        headers['Provider'] = providerName;
                    }
                    
                    // 调用One API
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: "user", content: fullPrompt }
                            ],
                            temperature: temperature,
                            max_tokens: maxTokens,
                            top_p: topP
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`One API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content || '';
                    
                    // 添加标题，如果还没有标题且用户提供了标题
                    if (title && !content.startsWith('# ')) {
                        return `# ${title}\n\n${content}`;
                    }
                    
                    return content;
                }
                // 月之暗面API实现
                else if (provider === 'moonshot') {
                    const moonshotKey = apiConfig.moonshot?.apiKey;
                    if (!moonshotKey) {
                        throw new Error("未配置月之暗面API密钥");
                    }
                    
                    const model = apiConfig.moonshot?.model || 'moonshot-v1-8k';
                    const temperature = apiConfig.moonshot?.temperature || 0.7;
                    const maxTokens = apiConfig.moonshot?.maxTokens || 4000;
                    const topP = apiConfig.moonshot?.topP || 0.95;
                    
                    // 根据是否设置了代理来确定API端点
                    const apiProxy = apiConfig.moonshot?.apiProxy;
                    const apiEndpoint = apiProxy ? apiProxy : 'https://api.moonshot.cn/v1/chat/completions';
                    
                    // 调用月之暗面API
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${moonshotKey}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: "user", content: fullPrompt }
                            ],
                            temperature: temperature,
                            max_tokens: maxTokens,
                            top_p: topP
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`月之暗面API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                    }
                    
                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content || '';
                    
                    // 添加标题，如果还没有标题且用户提供了标题
                    if (title && !content.startsWith('# ')) {
                        return `# ${title}\n\n${content}`;
                    }
                    
                    return content;
                }
                else {
                    throw new Error(`不支持的API提供商: ${provider}`);
                }
            } catch (error) {
                console.error("生成图片错误:", error);
                throw error;
            }
        }

        // 图片处理功能
        async function generateImages() {
            const statusText = document.getElementById('statusText');
            const generatedImages = document.getElementById('generatedImages');
            
            // 处理上传的图片
            if (uploadedImageFiles && uploadedImageFiles.length > 0) {
                // 显示上传的图片
                generatedImages.innerHTML = '<h3 class="text-lg font-semibold col-span-full mb-2 flex items-center"><i class="fas fa-images mr-2 text-apple-blue dark:text-apple-darkblue"></i>上传的图片</h3>';
                generatedImages.classList.remove('hidden');
                
                // 获取图片URL
                const imageUrls = Array.from(uploadedImageFiles).map(file => URL.createObjectURL(file));
                
                // 添加自动插入图片功能
                const insertMode = document.querySelector('input[name="imageInsertMode"]:checked').value;
                insertImagesIntoArticle(imageUrls, insertMode);
                
                document.getElementById('generationStatus').classList.add('hidden');
            } else {
                // AI生成图片
                const apiConfig = JSON.parse(localStorage.getItem(API_CONFIG_KEY) || '{}');
                const provider = apiConfig.provider || 'poe';
                
                // 根据不同的提供商获取图片模型
                let imageModel;
                
                switch (provider) {
                    case 'openai':
                        imageModel = apiConfig.openai?.imageModel || 'dall-e-3';
                        break;
                    case 'poe':
                        imageModel = apiConfig.poe?.imageModel || 'FLUX-pro-1.1';
                        break;
                    default:
                        imageModel = 'FLUX-pro-1.1'; // 默认
                }
                
                const imagePrompt = document.getElementById('imagePrompt').value || "适合文章的精美配图，高质量，专业，逼真";
                const aspectRatio = document.getElementById('imageAspectRatio').value;
                
                // 清空之前的图片
                generatedImages.innerHTML = '<h3 class="text-lg font-semibold col-span-full mb-2 flex items-center"><i class="fas fa-images mr-2 text-apple-blue dark:text-apple-darkblue"></i>生成的图片</h3>';
                generatedImages.classList.remove('hidden');
                
                // 显示生成状态
                document.getElementById('generationStatus').classList.remove('hidden');
                statusText.textContent = '正在创作精美图片...';
                
                // 创建占位符
                for (let i = 0; i < imageCount; i++) {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'bg-gray-100 dark:bg-gray-800 rounded-xl aspect-[4/3] animate-pulse flex items-center justify-center';
                    placeholder.id = `img-placeholder-${i}`;
                    placeholder.innerHTML = '<div class="text-gray-400 dark:text-gray-500 flex flex-col items-center"><i class="fas fa-image mb-2 text-xl"></i><span>生成中...</span></div>';
                    generatedImages.appendChild(placeholder);
                }
                
                // 生成图片
                try {
                    // 使用AI API生成图片
                    const generatedUrls = await generateAIImages(imagePrompt, imageCount, aspectRatio);
                    
                    // 处理生成的图片URL
                    generatedUrls.forEach((imageUrl, index) => {
                        const placeholder = document.getElementById(`img-placeholder-${index}`);
                        if (!placeholder) return;
                        
                        const container = document.createElement('div');
                        container.className = 'relative group overflow-hidden rounded-xl';
                        
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.className = 'w-full h-auto rounded-xl transition-all duration-300';
                        img.alt = `生成的图片 ${index + 1}`;
                        
                        const overlay = document.createElement('div');
                        overlay.className = 'absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 flex items-center justify-center transition-all duration-300';
                        
                        const btnContainer = document.createElement('div');
                        btnContainer.className = 'flex gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-2 group-hover:translate-y-0';
                        
                        const insertBtn = document.createElement('button');
                        insertBtn.className = 'bg-apple-blue hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium';
                        insertBtn.innerHTML = '<i class="fas fa-crop mr-1"></i>裁剪';
                        insertBtn.addEventListener('click', () => {
                            const img = container.querySelector('img');
                            if (img) {
                                showImageCropper(img);
                            }
                        });
                        
                        const downloadBtn = document.createElement('button');
                        downloadBtn.className = 'bg-white hover:bg-gray-100 text-gray-800 px-3 py-1.5 rounded-lg text-sm font-medium';
                        downloadBtn.innerHTML = '<i class="fas fa-download mr-1"></i>保存';
                        downloadBtn.addEventListener('click', () => {
                            // 提示用户如何保存图片
                            alert('请在图片上右键点击并选择"图片另存为..."以保存图片。');
                        });
                        
                        btnContainer.appendChild(insertBtn);
                        btnContainer.appendChild(downloadBtn);
                        overlay.appendChild(btnContainer);
                        container.appendChild(img);
                        container.appendChild(overlay);
                        
                        placeholder.replaceWith(container);
                    });
                    
                    // 添加自动插入图片功能
                    const insertMode = document.querySelector('input[name="imageInsertMode"]:checked').value;
                    insertImagesIntoArticle(generatedUrls, insertMode);
                    
                } catch (error) {
                    console.error("生成图片错误:", error);
                    // 显示错误提示
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';
                    alertDiv.innerHTML = `
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl max-w-lg w-full shadow-xl">
                            <h3 class="text-xl font-semibold mb-4 flex items-center text-red-600 dark:text-red-400">
                                <i class="fas fa-exclamation-circle mr-2"></i>图片生成失败
                            </h3>
                            <p class="mb-4">错误详情: ${error.message}</p>
                            <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg mb-4 overflow-auto max-h-32">
                                <code class="text-xs whitespace-pre-wrap break-all">${error.stack || '无详细错误信息'}</code>
                            </div>
                            <p class="mb-4">可能的原因：</p>
                            <ul class="list-disc pl-5 mb-4">
                                <li>API密钥配置错误或已过期</li>
                                <li>提示词包含不当内容</li>
                                <li>API服务暂时不可用</li>
                                <li>网络连接问题</li>
                            </ul>
                            <p class="mb-4">建议尝试：</p>
                            <ul class="list-disc pl-5 mb-6">
                                <li>检查API配置并重试</li>
                                <li>修改图片提示词</li>
                                <li>切换到参考链接提取图片模式</li>
                            </ul>
                            <div class="flex justify-end">
                                <button id="closeAlertBtn" class="px-4 py-2 bg-apple-blue text-white rounded-lg">
                                    我知道了
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(alertDiv);
                    
                    // 添加关闭按钮事件
                    document.getElementById('closeAlertBtn').addEventListener('click', () => {
                        document.body.removeChild(alertDiv);
                    });
                } finally {
                    document.getElementById('generationStatus').classList.add('hidden');
                    
                    // 移除任何剩余的占位符
                    document.querySelectorAll('[id^="img-placeholder-"]').forEach(placeholder => {
                        placeholder.remove();
                    });
                }
            }
        }

        // 生成文章功能
        document.getElementById('generateBtn')?.addEventListener('click', async function() {
            const generationStatus = document.getElementById('generationStatus');
            const statusText = document.getElementById('statusText');
            const outputSection = document.getElementById('outputSection');
            
            // 切换到预览标签页
            document.querySelector('[data-tab="preview"]').click();
            
            // 显示生成状态
            generationStatus.classList.remove('hidden');
            statusText.textContent = '正在收集创作素材...';
            outputSection.classList.add('hidden');
            
            this.disabled = true;
            this.innerHTML = '<div class="apple-spinner mr-2"></div>创作中...';
            
            try {
                // 收集表单数据
                const title = document.getElementById('articleTitle').value;
                const articlePrompt = document.getElementById('articlePrompt').value;
                const referenceLinks = document.getElementById('referenceLinks').value;
                const referenceText = document.getElementById('referenceText').value;
                const articleLength = document.querySelector('input[name="articleLength"]:checked').value;
                const articleTheme = document.getElementById('articleTheme').value;
                
                // 加载API配置
                const apiConfig = JSON.parse(localStorage.getItem(API_CONFIG_KEY) || '{}');
                const provider = apiConfig.provider || 'poe';
                
                // 验证API配置
                switch (provider) {
                    case 'openai':
                        if (!apiConfig.openai?.apiKey) {
                            throw new Error("请先配置OpenAI API密钥");
                        }
                        break;
                    case 'anthropic':
                        if (!apiConfig.anthropic?.apiKey) {
                            throw new Error("请先配置Anthropic API密钥");
                        }
                        break;
                    case 'poe':
                        if (!apiConfig.poe?.apiKey) {
                            throw new Error("请先配置Poe API密钥");
                        }
                        break;
                    case 'deepseek':
                        if (!apiConfig.deepseek?.apiKey) {
                            throw new Error("请先配置DeepSeek API密钥");
                        }
                        break;
                    case 'baidu':
                        if (!apiConfig.baidu?.apiKey || !apiConfig.baidu?.secretKey) {
                            throw new Error("请先配置百度文心一言API Key和Secret Key");
                        }
                        break;
                    case 'moonshot':
                        if (!apiConfig.moonshot?.apiKey) {
                            throw new Error("请先配置月之暗面API密钥");
                        }
                        break;
                }
                
                // 使用真实API生成文章
                statusText.textContent = '正在创作文章内容...';
                
                const articleContent = await generateArticle(title, articlePrompt, articleLength, referenceLinks, referenceText);
                
                // 显示文章内容
                const articleOutput = document.getElementById('articleOutput');
                articleOutput.innerHTML = DOMPurify.sanitize(marked.parse(articleContent));
                
                // 应用选中的主题
                articleOutput.className = '';
                articleOutput.classList.add(
                    `theme-${articleTheme}`, 
                    'prose', 'dark:prose-invert', 'max-w-none', 
                    'border', 'border-gray-100', 'dark:border-gray-800', 
                    'p-6', 'rounded-xl', 'bg-white', 'dark:bg-gray-950', 
                    'overflow-auto'
                );
                
                outputSection.classList.remove('hidden');
                
                // 处理图片生成或提取
                await generateImages();
                
                generationStatus.classList.add('hidden');
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-magic mr-2"></i>创作精彩文章';
                
                // 滚动到输出部分
                outputSection.scrollIntoView({ behavior: 'smooth' });
                
                // 保存文章到历史记录
                saveArticleToHistory(title, articleContent, articleTheme);
                
            } catch (error) {
                generationStatus.classList.add('hidden');
                
                // 显示详细错误提示
                const alertDiv = document.createElement('div');
                alertDiv.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';
                alertDiv.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl max-w-lg w-full shadow-xl">
                        <h3 class="text-xl font-semibold mb-4 flex items-center text-red-600 dark:text-red-400">
                            <i class="fas fa-exclamation-circle mr-2"></i>文章生成失败
                        </h3>
                        <p class="mb-4">错误详情: ${error.message}</p>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg mb-4 overflow-auto max-h-32">
                            <code class="text-xs whitespace-pre-wrap break-all">${error.stack || '无详细错误信息'}</code>
                        </div>
                        <p class="mb-4">可能的原因：</p>
                        <ul class="list-disc pl-5 mb-6">
                            <li>API密钥无效或已过期</li>
                            <li>API服务暂时不可用</li>
                            <li>网络连接问题</li>
                            <li>提示词太长或包含不当内容</li>
                        </ul>
                        <div class="flex justify-end">
                            <button id="closeAlertBtn" class="px-4 py-2 bg-apple-blue text-white rounded-lg">
                                我知道了
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(alertDiv);
                
                // 添加关闭按钮事件
                document.getElementById('closeAlertBtn').addEventListener('click', () => {
                    document.body.removeChild(alertDiv);
                });
                
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-magic mr-2"></i>创作精彩文章';
            }
        });

        // 复制按钮
        document.getElementById('copyBtn')?.addEventListener('click', function() {
            const articleOutput = document.getElementById('articleOutput');
            
            // 创建一个临时元素用于选择和复制
            const tempElement = document.createElement('div');
            
            // 使用克隆节点而不是innerHTML，保留样式和格式
            const clone = articleOutput.cloneNode(true);
            tempElement.appendChild(clone);
            
            // 处理特殊元素，确保公众号兼容性
            // 移除可能导致格式问题的属性
            const allElements = tempElement.querySelectorAll('*');
            allElements.forEach(el => {
                // 保留基本样式和结构，移除可能导致问题的类和ID
                el.removeAttribute('class');
                el.removeAttribute('id');
                el.removeAttribute('style');
            });
            
            document.body.appendChild(tempElement);
            tempElement.style.position = 'absolute';
            tempElement.style.left = '-9999px';
            tempElement.style.opacity = '0';
            
            // 选择并复制
            const range = document.createRange();
            range.selectNodeContents(tempElement.firstChild);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            document.execCommand('copy');
            
            // 清理
            selection.removeAllRanges();
            document.body.removeChild(tempElement);
            
            // 显示成功提示
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-check mr-1.5"></i>已复制!';
            setTimeout(() => {
                this.innerHTML = originalText;
            }, 2000);
        });
        
        // 公众号复制按钮
        document.getElementById('copyWechatBtn')?.addEventListener('click', function() {
            const articleOutput = document.getElementById('articleOutput');
            
            // 创建一个临时元素用于选择和复制
            const tempElement = document.createElement('div');
            tempElement.className = 'wechat-compatible';
            
            // 克隆节点以保留结构
            const clone = articleOutput.cloneNode(true);
            
            // 特殊处理图片，确保能在公众号中显示
            const images = clone.querySelectorAll('img');
            images.forEach(img => {
                // 创建新的图片元素，使用base64数据
                if (img.src.startsWith('data:')) {
                    // 已经是base64，保持不变
                } else if (img.src.startsWith('blob:')) {
                    // 对于blob URL，需要转换为canvas再导出为base64
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.naturalWidth || 800;
                        canvas.height = img.naturalHeight || 600;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        img.src = canvas.toDataURL('image/jpeg', 0.92);
                    } catch (e) {
                        console.error('转换图片失败:', e);
                    }
                } else {
                    // 对于远程URL，添加特殊属性帮助公众号识别
                    img.setAttribute('data-src', img.src);
                    img.setAttribute('data-type', 'jpeg');
                }
                
                // 添加公众号图片所需的特殊属性
                img.setAttribute('style', 'max-width:100%;height:auto;display:block;margin:15px auto;');
                img.setAttribute('data-w', '100%');
                img.setAttribute('data-ratio', '0.75');
                img.setAttribute('data-s', '300,700');
                img.setAttribute('data-type', 'jpeg');
                img.setAttribute('data-copyright', '0');
            });
            
            // 处理标题和段落，添加内联样式
            const allElements = clone.querySelectorAll('*');
            allElements.forEach(el => {
                // 移除可能导致问题的属性
                el.removeAttribute('class');
                el.removeAttribute('id');
                
                // 根据元素类型添加内联样式
                if (el.tagName === 'H1') {
                    el.setAttribute('style', 'font-size:24px;font-weight:bold;color:#222;margin:20px 0 15px;text-align:center;line-height:1.4;font-family:PingFang SC,Hiragino Sans GB,Microsoft YaHei,sans-serif;');
                } else if (el.tagName === 'H2') {
                    el.setAttribute('style', 'font-size:20px;font-weight:bold;color:#333;margin:15px 0 10px;padding-bottom:5px;border-bottom:1px solid #eee;font-family:PingFang SC,Hiragino Sans GB,Microsoft YaHei,sans-serif;');
                } else if (el.tagName === 'H3') {
                    el.setAttribute('style', 'font-size:18px;font-weight:bold;color:#444;margin:15px 0 10px;font-family:PingFang SC,Hiragino Sans GB,Microsoft YaHei,sans-serif;');
                } else if (el.tagName === 'P') {
                    el.setAttribute('style', 'font-size:16px;line-height:1.8;margin:10px 0;color:#333;font-family:PingFang SC,Hiragino Sans GB,Microsoft YaHei,sans-serif;');
                } else if (el.tagName === 'BLOCKQUOTE') {
                    el.setAttribute('style', 'padding:10px 15px;border-left:4px solid #eee;background-color:#f9f9f9;margin:10px 0;color:#666;font-size:15px;line-height:1.7;font-family:PingFang SC,Hiragino Sans GB,Microsoft YaHei,sans-serif;');
                } else if (el.tagName === 'UL' || el.tagName === 'OL') {
                    el.setAttribute('style', 'padding-left:20px;margin:10px 0;font-family:PingFang SC,Hiragino Sans GB,Microsoft YaHei,sans-serif;');
                } else if (el.tagName === 'LI') {
                    el.setAttribute('style', 'font-size:16px;line-height:1.8;margin:5px 0;color:#333;font-family:PingFang SC,Hiragino Sans GB,Microsoft YaHei,sans-serif;');
                } else if (el.tagName === 'STRONG' || el.tagName === 'B') {
                    el.setAttribute('style', 'font-weight:bold;color:#333;');
                } else if (el.tagName === 'A') {
                    el.setAttribute('style', 'color:#576b95;text-decoration:none;border-bottom:1px solid #576b95;');
                }
            });
            
            tempElement.appendChild(clone);
            document.body.appendChild(tempElement);
            tempElement.style.position = 'absolute';
            tempElement.style.left = '-9999px';
            
            // 选择并复制
            const range = document.createRange();
            range.selectNodeContents(tempElement);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            document.execCommand('copy');
            
            // 清理
            selection.removeAllRanges();
            document.body.removeChild(tempElement);
            
            // 显示成功提示
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in';
            toast.innerHTML = '<i class="fas fa-check-circle mr-2"></i>已复制到剪贴板，可直接粘贴到公众号编辑器';
            document.body.appendChild(toast);
            
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fab fa-weixin mr-1.5"></i>已复制!';
            
            setTimeout(() => {
                this.innerHTML = originalText;
                toast.remove();
            }, 3000);
        });
        
        // 编辑文章模态框
        const editModal = document.getElementById('editArticleModal');
        
        document.getElementById('editArticleBtn')?.addEventListener('click', function() {
            const articleOutput = document.getElementById('articleOutput');
            const turndownService = new TurndownService();
            const markdown = turndownService.turndown(articleOutput.innerHTML);
            
            document.getElementById('articleEditArea').value = markdown;
            editModal.classList.remove('hidden');
        });
        
        document.getElementById('closeEditBtn')?.addEventListener('click', () => {
            editModal.classList.add('hidden');
        });
        
        document.getElementById('cancelEditBtn')?.addEventListener('click', () => {
            editModal.classList.add('hidden');
        });
        
        document.getElementById('saveEditBtn')?.addEventListener('click', function() {
            const articleOutput = document.getElementById('articleOutput');
            const markdownContent = document.getElementById('articleEditArea').value;
            const editArticleId = document.getElementById('editArticleId')?.value;
            
            // 更新预览
            articleOutput.innerHTML = DOMPurify.sanitize(marked.parse(markdownContent));
            
            // 如果是编辑历史文章，则更新历史记录
            if (editArticleId) {
                const history = JSON.parse(localStorage.getItem(HISTORY_STORAGE_KEY) || '[]');
                const articleIndex = history.findIndex(item => item.id === editArticleId);
                
                if (articleIndex !== -1) {
                    history[articleIndex].content = markdownContent;
                    history[articleIndex].updatedAt = new Date().toISOString();
                    localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
                    
                    // 显示成功提示
                    const toast = document.createElement('div');
                    toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in';
                    toast.innerHTML = '<i class="fas fa-check-circle mr-2"></i>文章已更新并保存到历史记录';
                    document.body.appendChild(toast);
                    
                    setTimeout(() => {
                        toast.remove();
                    }, 3000);
                }
            }
            
            editModal.classList.add('hidden');
        });
        
        // 重新生成按钮
        document.getElementById('regenerateBtn')?.addEventListener('click', function() {
            // 切换到内容创作页面
            document.querySelector('[data-tab="content"]').click();
            // 点击生成按钮
            document.getElementById('generateBtn').click();
        });
        
        // 保存API设置按钮和测试API
        document.getElementById('saveApiSettingsBtn')?.addEventListener('click', async function() {
        // 保存API配置
            saveApiConfig();
            
            // 测试API连接
            const provider = document.querySelector('input[name="apiProvider"]:checked').value;
            const apiTestResult = document.getElementById('apiTestResult');
            
            apiTestResult.innerHTML = `
                <div class="p-3 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 rounded-xl flex items-center">
                    <div class="apple-spinner mr-2"></div>
                    <span>正在测试 ${provider} API 连接...</span>
                </div>
            `;
            apiTestResult.classList.remove('hidden');
            
            try {
                // 使用实际API测试
                await testApiConnection(provider);
                
                apiTestResult.innerHTML = `
                    <div class="p-3 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 rounded-xl flex items-center">
                        <i class="fas fa-check-circle mr-2"></i>
                        <span>${provider} API 连接测试成功！API密钥有效。</span>
                    </div>
                `;
            } catch (error) {
                apiTestResult.innerHTML = `
                    <div class="p-3 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 rounded-xl flex flex-col">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            <span>API连接测试失败</span>
                        </div>
                        <div class="text-sm">${error.message}</div>
                        <div class="mt-2 text-xs">请检查API密钥是否正确，并确保网络连接正常。</div>
                    </div>
                `;
            }
            
            // 显示成功提示
            const originalText = this.textContent;
            this.innerHTML = '<i class="fas fa-check mr-2"></i>设置已保存';
            this.classList.add('bg-green-600', 'dark:bg-green-700');
            
            setTimeout(() => {
                this.textContent = originalText;
                this.classList.remove('bg-green-600', 'dark:bg-green-700');
            }, 2000);
        });
        
        let cropper = null;
        let currentImageElement = null;

        function showImageCropper(imageElement) {
            currentImageElement = imageElement;
            const modal = document.getElementById('imageModal');
            const cropperImage = document.getElementById('cropperImage');
            
            modal.classList.remove('hidden');
            cropperImage.src = imageElement.src;
            
            cropper = new Cropper(cropperImage, {
                aspectRatio: NaN,
                viewMode: 2,
                background: false
            });
        }

        function cancelCrop() {
            const modal = document.getElementById('imageModal');
            modal.classList.add('hidden');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }

        function confirmCrop() {
            if (cropper && currentImageElement) {
                const croppedCanvas = cropper.getCroppedCanvas();
                currentImageElement.src = croppedCanvas.toDataURL();
                cancelCrop();
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始设置为第一个标签页激活
            document.querySelector('.tab-button').click();
            
            // 加载保存的API配置
            loadApiConfig();
            
            // 设置radio按钮选中状态
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                if (radio.checked) {
                    // 如果是API提供商单选按钮
                    if (radio.name === 'apiProvider') {
                        const card = radio.closest('.api-provider-card');
                        if (card) {
                            card.querySelector('.provider-radio').classList.remove('border-gray-300', 'dark:border-gray-600');
                            card.querySelector('.provider-radio').classList.add('border-apple-blue', 'dark:border-apple-darkblue');
                            card.querySelector('.provider-radio-dot').classList.remove('hidden');
                            card.querySelector('label').classList.add('border-apple-blue', 'dark:border-apple-darkblue');
                        }
                    } else {
                        // 其他单选按钮
                        const dot = radio.closest('label').querySelector('.w-2.h-2');
                        if (dot) dot.classList.remove('hidden');
                    }
                }
            });
            
            // 初始化图片上传功能
            initImageUpload();
        });
        
        // 存储上传的图片数据 - 全局变量
        const uploadedImageFiles = [];
        
        // 初始化图片上传功能
        function initImageUpload() {
            const imageDropArea = document.getElementById('imageDropArea');
            const imageUpload = document.getElementById('imageUpload');
            const optimizeImagesBtn = document.getElementById('optimizeImagesBtn');
            const uploadedImages = document.getElementById('uploadedImages');
            const generatedImages = document.getElementById('generatedImages');
            
            // 点击上传区域触发文件选择
            if (imageDropArea) {
                imageDropArea.addEventListener('click', () => {
                    imageUpload.click();
                });
            }
            
            // 文件选择处理
            if (imageUpload) {
                imageUpload.addEventListener('change', (e) => {
                    handleFiles(e.target.files);
                });
            }
            
            // 拖放处理
            if (imageDropArea) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    imageDropArea.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    imageDropArea.addEventListener(eventName, () => {
                        imageDropArea.classList.add('border-apple-blue', 'dark:border-apple-darkblue', 'bg-blue-50', 'dark:bg-blue-900/10');
                    });
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    imageDropArea.addEventListener(eventName, () => {
                        imageDropArea.classList.remove('border-apple-blue', 'dark:border-apple-darkblue', 'bg-blue-50', 'dark:bg-blue-900/10');
                    });
                });
                
                imageDropArea.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    handleFiles(files);
                });
            }
            
            // 剪贴板粘贴处理
            document.addEventListener('paste', (e) => {
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                const files = [];
                
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const file = items[i].getAsFile();
                        files.push(file);
                    }
                }
                
                if (files.length > 0) {
                    handleFiles(files);
                }
            });
            
            // 处理上传的文件
            function handleFiles(files) {
                if (!files || files.length === 0) return;
                
                // 显示上传图片区域
                uploadedImages.classList.remove('hidden');
                
                // 处理每个文件
                Array.from(files).forEach((file, index) => {
                    if (!file.type.match('image.*')) return;
                    
                    uploadedImageFiles.push(file);
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageUrl = e.target.result;
                        
                        // 创建图片预览
                        const container = document.createElement('div');
                        container.className = 'relative group overflow-hidden rounded-xl';
                        container.dataset.index = index;
                        
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.className = 'w-full h-auto rounded-xl transition-all duration-300';
                        img.alt = `上传的图片 ${index + 1}`;
                        
                        const overlay = document.createElement('div');
                        overlay.className = 'absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 flex items-center justify-center transition-all duration-300';
                        
                        const btnContainer = document.createElement('div');
                        btnContainer.className = 'flex gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-2 group-hover:translate-y-0';
                        
                        const insertBtn = document.createElement('button');
                        insertBtn.className = 'bg-apple-blue hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium';
                        insertBtn.innerHTML = '<i class="fas fa-crop mr-1"></i>裁剪';
                        insertBtn.addEventListener('click', () => {
                            const img = container.querySelector('img');
                            if (img) {
                                showImageCropper(img);
                            }
                        });
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium';
                        deleteBtn.innerHTML = '<i class="fas fa-trash mr-1"></i>删除';
                        deleteBtn.addEventListener('click', () => {
                            // 删除图片
                            container.remove();
                            uploadedImageFiles.splice(index, 1);
                            
                            // 如果没有图片了，隐藏容器
                            if (uploadedImageFiles.length === 0) {
                                uploadedImages.classList.add('hidden');
                            }
                        });
                        
                        btnContainer.appendChild(insertBtn);
                        btnContainer.appendChild(deleteBtn);
                        overlay.appendChild(btnContainer);
                        container.appendChild(img);
                        container.appendChild(overlay);
                        
                        uploadedImages.appendChild(container);
                    };
                    
                    reader.readAsDataURL(file);
                });
                
                // 显示在生成图片区域
                generatedImages.innerHTML = '<h3 class="text-lg font-semibold col-span-full mb-2 flex items-center"><i class="fas fa-images mr-2 text-apple-blue dark:text-apple-darkblue"></i>上传的图片</h3>';
                generatedImages.classList.remove('hidden');
                
                // 添加自动插入图片功能
                const imageUrls = Array.from(uploadedImageFiles).map(file => URL.createObjectURL(file));
                const insertMode = document.querySelector('input[name="imageInsertMode"]:checked').value;
                insertImagesIntoArticle(imageUrls, insertMode);
            }
            
            // 高清优化功能
            if (optimizeImagesBtn) {
                optimizeImagesBtn.addEventListener('click', async () => {
                    if (uploadedImageFiles.length === 0) {
                        alert('请先上传图片');
                        return;
                    }
                    
                    // 显示加载状态
                    const originalBtnText = optimizeImagesBtn.innerHTML;
                    optimizeImagesBtn.innerHTML = '<div class="apple-spinner mr-2"></div>优化中...';
                    optimizeImagesBtn.disabled = true;
                    
                    try {
                        // 创建离屏canvas进行图片优化
                        const optimizedImages = [];
                        
                        for (const file of uploadedImageFiles) {
                            // 创建图片元素并加载图片
                            const img = new Image();
                            const imageUrl = URL.createObjectURL(file);
                            
                            // 使用Promise等待图片加载完成
                            await new Promise((resolve, reject) => {
                                img.onload = resolve;
                                img.onerror = reject;
                                img.src = imageUrl;
                            });
                            
                            // 创建canvas并设置合适的尺寸
                            const canvas = document.createElement('canvas');
                            // 保持原始宽高比，但提高分辨率
                            const scale = 2.5; // 提高150%的分辨率
                            canvas.width = img.width * scale;
                            canvas.height = img.height * scale;
                            
                            // 获取绘图上下文
                            const ctx = canvas.getContext('2d');
                            
                            // 应用高质量绘图设置
                            ctx.imageSmoothingEnabled = true;
                            ctx.imageSmoothingQuality = 'high';
                            
                            // 使用双线性插值算法进行缩放
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            
                            // 应用高级图像增强
                            enhanceImage(ctx, canvas.width, canvas.height);
                            
                            // 转换为高质量的DataURL
                            const optimizedDataUrl = canvas.toDataURL('image/jpeg', 0.95); // 提高输出质量
                            optimizedImages.push(optimizedDataUrl);
                            
                            // 释放URL对象
                            URL.revokeObjectURL(imageUrl);
                        }
                        
                        // 更新预览区域
                        uploadedImages.innerHTML = '';
                        
                        // 更新存储的图片数据
                        uploadedImageFiles.length = 0;
                        
                        // 显示优化后的图片
                        optimizedImages.forEach((imageUrl, index) => {
                            // 将DataURL转换为Blob
                            const byteString = atob(imageUrl.split(',')[1]);
                            const mimeType = imageUrl.split(',')[0].split(':')[1].split(';')[0];
                            const ab = new ArrayBuffer(byteString.length);
                            const ia = new Uint8Array(ab);
                            for (let i = 0; i < byteString.length; i++) {
                                ia[i] = byteString.charCodeAt(i);
                            }
                            const blob = new Blob([ab], {type: mimeType});
                            
                            // 创建文件对象
                            const optimizedFile = new File([blob], `optimized-image-${index+1}.jpg`, {type: 'image/jpeg'});
                            uploadedImageFiles.push(optimizedFile);
                            
                            // 创建图片预览
                            const container = document.createElement('div');
                            container.className = 'relative group overflow-hidden rounded-xl';
                            container.dataset.index = index;
                            
                            const img = document.createElement('img');
                            img.src = imageUrl;
                            img.className = 'w-full h-auto rounded-xl transition-all duration-300';
                            img.alt = `优化后的图片 ${index + 1}`;
                            
                            const overlay = document.createElement('div');
                            overlay.className = 'absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 flex items-center justify-center transition-all duration-300';
                            
                            const btnContainer = document.createElement('div');
                            btnContainer.className = 'flex gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-2 group-hover:translate-y-0';
                            
                            const insertBtn = document.createElement('button');
                            insertBtn.className = 'bg-apple-blue hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium';
                            insertBtn.innerHTML = '<i class="fas fa-crop mr-1"></i>裁剪';
                            insertBtn.addEventListener('click', () => {
                                const img = container.querySelector('img');
                                if (img) {
                                    showImageCropper(img);
                                }
                            });
                            
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium';
                            deleteBtn.innerHTML = '<i class="fas fa-trash mr-1"></i>删除';
                            deleteBtn.addEventListener('click', () => {
                                // 删除图片
                                container.remove();
                                uploadedImageFiles.splice(index, 1);
                                
                                // 如果没有图片了，隐藏容器
                                if (uploadedImageFiles.length === 0) {
                                    uploadedImages.classList.add('hidden');
                                }
                            });
                            
                            btnContainer.appendChild(insertBtn);
                            btnContainer.appendChild(deleteBtn);
                            overlay.appendChild(btnContainer);
                            container.appendChild(img);
                            container.appendChild(overlay);
                            
                            uploadedImages.appendChild(container);
                        });
                        
                        // 显示优化成功提示
                        const successToast = document.createElement('div');
                        successToast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in';
                        successToast.innerHTML = '<i class="fas fa-check-circle mr-2"></i>图片优化成功！';
                        document.body.appendChild(successToast);
                        
                        // 3秒后自动移除提示
                        setTimeout(() => {
                            successToast.remove();
                        }, 3000);
                        
            } catch (error) {
                        console.error('图片优化失败:', error);
                        alert(`图片优化失败: ${error.message}`);
                    } finally {
                        // 恢复按钮状态
                        optimizeImagesBtn.innerHTML = originalBtnText;
                        optimizeImagesBtn.disabled = false;
                    }
                });
            }
            
            // 图片锐化滤镜函数
            function enhanceImage(ctx, width, height) {
                // 获取图像数据
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                
                // 创建增强锐化卷积核
                const kernel = [
                    -1, -1, -1,
                    -1, 9, -1,
                    -1, -1, -1
                ];
                
                // 应用卷积操作
                const tempData = new Uint8ClampedArray(data);
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        const offset = (y * width + x) * 4;
                        
                        for (let c = 0; c < 3; c++) {
                            let val = 0;
                            for (let ky = -1; ky <= 1; ky++) {
                                for (let kx = -1; kx <= 1; kx++) {
                                    const idx = ((y + ky) * width + (x + kx)) * 4 + c;
                                    val += tempData[idx] * kernel[(ky + 1) * 3 + (kx + 1)];
                                }
                            }
                            data[offset + c] = Math.max(0, Math.min(255, val));
                        }
                    }
                }
                
                // 增强对比度和饱和度
                const contrast = 1.3; // 增加30%对比度
                const saturation = 1.2; // 增加20%饱和度
                
                for (let i = 0; i < data.length; i += 4) {
                    // 增强对比度
                    for (let c = 0; c < 3; c++) {
                        const val = data[i + c];
                        data[i + c] = Math.max(0, Math.min(255, (val - 128) * contrast + 128));
                    }
                    
                    // 增强饱和度
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    // 计算亮度
                    const gray = 0.2989 * r + 0.5870 * g + 0.1140 * b;
                    
                    // 应用饱和度调整
                    data[i] = Math.max(0, Math.min(255, gray + (r - gray) * saturation));
                    data[i + 1] = Math.max(0, Math.min(255, gray + (g - gray) * saturation));
                    data[i + 2] = Math.max(0, Math.min(255, gray + (b - gray) * saturation));
                }
                
                // 更新图像数据
                ctx.putImageData(imageData, 0, 0);
            }
        }

        // 历史文章管理
        const HISTORY_STORAGE_KEY = 'ai_writer_history';

        // 保存文章到历史记录
        function saveArticleToHistory(title, content, theme) {
            const history = JSON.parse(localStorage.getItem(HISTORY_STORAGE_KEY) || '[]');
            
            // 创建新的历史记录项
            const newItem = {
                id: Date.now().toString(),
                title: title || '无标题文章',
                content: content,
                theme: theme,
                createdAt: new Date().toISOString()
            };
            
            // 添加到历史记录
            history.unshift(newItem);
            
            // 限制历史记录数量，最多保存50篇
            if (history.length > 50) {
                history.pop();
            }
            
            // 保存到localStorage
            localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
            
            // 如果历史标签页已加载，则更新显示
            updateHistoryList();
        }

        // 更新历史文章列表
        function updateHistoryList() {
            const historyList = document.getElementById('historyList');
            const emptyMessage = document.getElementById('emptyHistoryMessage');
            
            if (!historyList) return;
            
            // 获取历史记录
            const history = JSON.parse(localStorage.getItem(HISTORY_STORAGE_KEY) || '[]');
            
            // 清空当前列表
            historyList.innerHTML = '';
            
            if (history.length === 0) {
                // 显示空消息
                historyList.appendChild(emptyMessage);
                return;
            }
            
            // 隐藏空消息
            if (emptyMessage) {
                emptyMessage.style.display = 'none';
            }
            
            // 添加历史记录项
            history.forEach(item => {
                const date = new Date(item.createdAt);
                const formattedDate = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                const historyItem = document.createElement('div');
                historyItem.className = 'bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow';
                historyItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="font-medium text-lg mb-2">${item.title}</h3>
                        <div class="flex space-x-2">
                            <button class="view-article text-apple-blue dark:text-apple-darkblue hover:text-blue-700 dark:hover:text-blue-400" data-id="${item.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="edit-article text-yellow-500 hover:text-yellow-600" data-id="${item.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="export-article text-green-500 hover:text-green-600" data-id="${item.id}">
                                <i class="fas fa-file-export"></i>
                            </button>
                            <button class="delete-article text-red-500 hover:text-red-600" data-id="${item.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-2">创建于: ${formattedDate}</p>
                    <p class="text-gray-600 dark:text-gray-300 line-clamp-2 text-sm">${getTextPreview(item.content, 150)}</p>
                `;
                
                historyList.appendChild(historyItem);
            });
            
            // 添加事件监听器
            document.querySelectorAll('.view-article').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    viewArticle(id);
                });
            });
            
            document.querySelectorAll('.edit-article').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    editArticle(id);
                });
            });
            
            document.querySelectorAll('.export-article').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    exportArticle(id);
                });
            });
            
            document.querySelectorAll('.delete-article').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    deleteArticle(id);
                });
            });
        }

        // 获取文本预览函数
        function getTextPreview(markdown, maxLength) {
            if (!markdown) return '无内容预览';
            
            // 移除Markdown标记
            let text = markdown
                .replace(/#+\s+/g, '') // 移除标题标记
                .replace(/\*\*/g, '') // 移除粗体标记
                .replace(/\*/g, '') // 移除斜体标记
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // 替换链接为纯文本
                .replace(/!\[([^\]]*)\]\([^)]+\)/g, '[图片]') // 替换图片为[图片]
                .replace(/`[^`]+`/g, '') // 移除代码标记
                .replace(/```[\s\S]*?```/g, '') // 移除代码块
                .replace(/>\s+/g, '') // 移除引用标记
                .replace(/\n/g, ' '); // 替换换行为空格
            
            // 截断文本
            if (text.length > maxLength) {
                text = text.substring(0, maxLength) + '...';
            }
            
            return text;
        }
    </script>
<div id="imageModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
    <div class="relative mx-auto my-10 max-w-4xl bg-white rounded-lg p-6 dark:bg-gray-800">
        <h3 class="text-xl font-semibold mb-4">裁剪图片</h3>
        <div class="relative h-[400px] overflow-hidden">
            <img id="cropperImage" class="max-w-full">
        </div>
        <div class="mt-4 flex justify-end space-x-2">
            <button onclick="cancelCrop()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200">取消</button>
            <button onclick="confirmCrop()" class="px-4 py-2 bg-apple-blue text-white rounded hover:bg-apple-darkblue">确认裁剪</button>
        </div>
    </div>
</div>

<!-- 历史文章面板 -->
<div id="history-tab" class="tab-content hidden">
    <section class="bg-white dark:bg-gray-900 rounded-2xl shadow-apple dark:shadow-apple-dark p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fas fa-history mr-2 text-apple-blue dark:text-apple-darkblue"></i>
            历史文章
        </h2>
        
        <div id="historyList" class="space-y-4">
            <!-- 历史文章将在这里显示 -->
            <div class="text-center text-gray-500 dark:text-gray-400 py-8" id="emptyHistoryMessage">
                <i class="fas fa-file-alt text-3xl mb-2"></i>
                <p>暂无历史文章</p>
            </div>
        </div>
    </section>
</div>
</body>
</html>
