<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI文章创作助手</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入SimpleMDE Markdown编辑器 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    <!-- 引入Cropper.js图片裁剪库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <!-- 引入marked.js用于Markdown渲染 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary-color: #ff9d42;
            --primary-color-hover: #ff8a29;
            --secondary-color: #fff8f2;
            --text-color: #4a3b30;
            --border-color: rgba(255, 157, 66, 0.4);
            --error-color: #ff5d52;
            --success-color: #28c76f;
            --card-bg-light: rgba(255, 255, 255, 0.7);
            --card-bg-dark: rgba(44, 44, 48, 0.7);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            --glass-shadow: rgba(0, 0, 0, 0.05);
            --backdrop-blur: 12px;
        }
        
        .dark {
            --primary-color: #ff9d42;
            --primary-color-hover: #ff8a29;
            --secondary-color: #1f1a17;
            --text-color: #f5f5f7;
            --border-color: rgba(255, 157, 66, 0.4);
            --glass-highlight: rgba(255, 255, 255, 0.07);
            --glass-shadow: rgba(0, 0, 0, 0.2);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            transition: background-color 0.3s, color 0.3s;
            background-color: var(--secondary-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background-image: linear-gradient(125deg, rgba(255, 157, 66, 0.1), rgba(255, 255, 255, 0.05));
        }
        
        .dark body {
            background-image: linear-gradient(125deg, rgba(255, 157, 66, 0.15), rgba(25, 25, 25, 0.05));
        }
        
        .glass-card {
            background-color: var(--card-bg-light);
            backdrop-filter: blur(var(--backdrop-blur));
            -webkit-backdrop-filter: blur(var(--backdrop-blur));
            border-radius: 16px;
            box-shadow: 
                0 4px 20px var(--glass-shadow),
                inset 0 1px 0 var(--glass-highlight);
            border: 1px solid var(--border-color);
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            overflow: hidden;
        }
        
        .dark .glass-card {
            background-color: var(--card-bg-dark);
        }
        
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 30px var(--glass-shadow),
                inset 0 1px 0 var(--glass-highlight);
        }
        
        .apple-button {
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.07);
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .apple-button:hover:not(:disabled) {
            background-color: var(--primary-color-hover);
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        
        .apple-button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .apple-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .apple-button-secondary {
            background-color: rgba(255, 157, 66, 0.2);
            color: var(--text-color);
        }
        
        .dark .apple-button-secondary {
            background-color: rgba(255, 157, 66, 0.3);
            color: #fff;
        }
        
        .apple-button-secondary:hover:not(:disabled) {
            background-color: rgba(255, 157, 66, 0.3);
        }
        
        .dark .apple-button-secondary:hover:not(:disabled) {
            background-color: rgba(255, 157, 66, 0.4);
        }
        
        .apple-input {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px 16px;
            transition: all 0.2s ease;
            background-color: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            color: var(--text-color);
            font-size: 16px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            width: 100%;
        }
        
        .dark .apple-input {
            background-color: rgba(44, 44, 46, 0.5);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .apple-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(255, 157, 66, 0.2), inset 0 1px 3px rgba(0,0,0,0.05);
            outline: none;
        }
        
        .dark .apple-input:focus {
            box-shadow: 0 0 0 2px rgba(255, 157, 66, 0.3), inset 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .CodeMirror {
            border-radius: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            font-family: "SF Mono", SFMono-Regular, ui-monospace, Menlo, Monaco, Consolas, monospace;
            line-height: 1.6;
            height: 400px;
        }
        
        .dark .CodeMirror {
            background-color: rgba(44, 44, 46, 0.7);
            color: #f5f5f7;
            border-color: var(--border-color);
            backdrop-filter: blur(var(--backdrop-blur));
            -webkit-backdrop-filter: blur(var(--backdrop-blur));
        }
        
        .dark .CodeMirror-cursor {
            border-left: 1px solid #f5f5f7;
        }
        
        .dark .editor-toolbar a {
            color: #f5f5f7 !important;
        }
        
        .dark .editor-toolbar {
            background-color: rgba(44, 44, 46, 0.7);
            border-color: var(--border-color);
            backdrop-filter: blur(var(--backdrop-blur));
            -webkit-backdrop-filter: blur(var(--backdrop-blur));
        }
        
        .reference-item {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
            background-color: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        
        .dark .reference-item {
            background-color: rgba(44, 44, 46, 0.5);
        }
        
        .reference-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
        }
        
        @media (max-width: 768px) {
            .glass-card {
                padding: 16px !important;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
        }
        
        .copy-button {
            position: absolute;
            right: 12px;
            top: 12px;
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 13px;
            z-index: 10;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        
        .dark .copy-button {
            background-color: rgba(44, 44, 46, 0.8);
            color: #f5f5f7;
        }
        
        .copy-button:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .spinner-border {
            display: inline-block;
            width: 16px;
            height: 16px;
            vertical-align: text-bottom;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
            opacity: 0.75;
        }
        
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .reference-badge {
            background-color: var(--primary-color);
            color: white;
            border-radius: 20px;
            padding: 3px 10px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 8px;
            display: inline-flex;
            align-items: center;
        }
        
        .reference-badge i {
            margin-right: 4px;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background-color: rgba(255, 157, 66, 0.3);
            border-radius: 8px;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background-color: rgba(255, 157, 66, 0.4);
        }
        
        .writing-mode-card {
            display: flex;
            flex-direction: column;
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            background-color: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(var(--backdrop-blur));
            -webkit-backdrop-filter: blur(var(--backdrop-blur));
        }
        
        .dark .writing-mode-card {
            background-color: rgba(44, 44, 46, 0.5);
        }
        
        .writing-mode-card.active {
            border-color: var(--primary-color);
            box-shadow: 0 5px 15px rgba(255, 157, 66, 0.15);
        }
        
        .writing-mode-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .writing-mode-icon {
            font-size: 28px;
            margin-bottom: 12px;
            color: var(--primary-color);
        }
        
        .preview-pane {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            overflow-y: auto;
            background-color: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        
        .dark .preview-pane {
            background-color: rgba(44, 44, 46, 0.5);
        }
        
        .prose {
            max-width: 100%;
            color: var(--text-color);
        }
        
        .prose h1 {
            font-size: 2em;
            margin-top: 0;
            margin-bottom: 0.8em;
            font-weight: 700;
            color: var(--text-color);
        }
        
        .prose h2 {
            font-size: 1.5em;
            margin-top: 1.6em;
            margin-bottom: 0.8em;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .prose h3 {
            font-size: 1.25em;
            margin-top: 1.6em;
            margin-bottom: 0.6em;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .prose p {
            margin-top: 1.25em;
            margin-bottom: 1.25em;
            color: var(--text-color);
        }
        
        .prose img {
            margin-top: 2em;
            margin-bottom: 2em;
            border-radius: 8px;
        }
        
        .prose a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .prose a:hover {
            text-decoration: underline;
        }
        
        .prose blockquote {
            border-left: 4px solid var(--primary-color);
            padding-left: 1em;
            font-style: italic;
            margin-left: 0;
            margin-right: 0;
            background-color: rgba(255, 157, 66, 0.1);
            padding: 0.5em 1em;
            border-radius: 0 8px 8px 0;
        }
        
        .dark .prose blockquote {
            background-color: rgba(255, 157, 66, 0.15);
        }
        
        .prose ul, .prose ol {
            padding-left: 1.5em;
            color: var(--text-color);
        }
        
        .prose li {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        
        .editor-toolbar.fullscreen, .CodeMirror-fullscreen {
            z-index: 50;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            color: var(--text-color);
        }
        
        .section-title i {
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }
        
        .image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
        }
        
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .image-item:hover img {
            transform: scale(1.05);
        }
        
        .image-item .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .image-item:hover .image-overlay {
            opacity: 1;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 300px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transform: translateY(-10px);
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification.success {
            border-left: 4px solid var(--success-color);
        }
        
        .notification.error {
            border-left: 4px solid var(--error-color);
        }
        
        .notification-icon {
            margin-right: 12px;
            font-size: 20px;
        }
        
        .notification.success .notification-icon {
            color: var(--success-color);
        }
        
        .notification.error .notification-icon {
            color: var(--error-color);
        }
        
        .notification-text {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .notification-message {
            font-size: 14px;
            color: rgba(0, 0, 0, 0.7);
        }
        
        .dark .notification {
            background-color: rgba(44, 44, 46, 0.9);
        }
        
        .dark .notification-message {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .loading-container {
            background-color: white;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 320px;
        }
        
        .dark .loading-container {
            background-color: #2c2c2e;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }
        
        .dark .loading-spinner {
            border-color: rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary-color);
        }
        
        .loading-text {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .loading-subtext {
            font-size: 14px;
            color: rgba(0, 0, 0, 0.7);
        }
        
        .dark .loading-subtext {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .image-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: rgba(255, 157, 66, 0.05);
        }
        
        .dark .image-upload-area {
            background-color: rgba(255, 157, 66, 0.1);
        }
        
        .image-upload-area:hover {
            border-color: var(--primary-color);
            background-color: rgba(255, 157, 66, 0.1);
        }
        
        .dark .image-upload-area:hover {
            background-color: rgba(255, 157, 66, 0.15);
        }
        
        .image-preview {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: var(--card-bg-light);
            margin: 5% auto;
            padding: 25px;
            border-radius: 16px;
            width: 80%;
            max-width: 800px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(var(--backdrop-blur));
            -webkit-backdrop-filter: blur(var(--backdrop-blur));
        }
        
        .dark .modal-content {
            background-color: var(--card-bg-dark);
        }
        
        .editor-preview-split {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            height: 100%;
        }
        
        @media (min-width: 768px) {
            .editor-preview-split {
                grid-template-columns: 1fr 1fr;
                height: 600px;
            }
        }
        
        .editor-container, .preview-container {
            height: 100%;
        }
        
        .preview-container {
            height: 600px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        
        .dark .preview-container {
            background-color: rgba(44, 44, 46, 0.5);
        }
        
        /* 图片插入模式选择 */
        .insertion-mode-selector {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .insertion-mode {
            padding: 5px 10px;
            font-size: 13px;
            border-radius: 6px;
            background-color: rgba(255, 157, 66, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .insertion-mode.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* 覆盖编辑器样式，使其与预览对应 */
        .CodeMirror .cm-header-1 {
            font-size: 2em;
            color: var(--text-color);
        }
        
        .CodeMirror .cm-header-2 {
            font-size: 1.5em;
            color: var(--text-color);
        }
        
        .CodeMirror .cm-header-3 {
            font-size: 1.25em;
            color: var(--text-color);
        }
        
        .CodeMirror .cm-comment {
            color: var(--primary-color);
        }
        
        .CodeMirror .cm-link {
            color: var(--primary-color);
        }
        
        .CodeMirror .cm-url {
            color: var(--primary-color);
            opacity: 0.8;
        }
        
        /* API状态标签 */
        .api-status-badge {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin-top: 8px;
        }
        
        .api-status-badge.success {
            background-color: rgba(40, 199, 111, 0.2);
            color: var(--success-color);
        }
        
        .api-status-badge.error {
            background-color: rgba(255, 93, 82, 0.2);
            color: var(--error-color);
        }
        
        .api-status-badge i {
            margin-right: 5px;
        }
        
        /* 修复两侧对齐和自适应布局 */
        .content-container {
            margin: 0 auto;
            max-width: 1400px;
            width: 100%;
            padding: 0 20px;
        }
        
        /* 响应式布局调整 */
        @media (min-width: 768px) {
            .left-column, .right-column {
                height: 100%;
                display: flex;
                flex-direction: column;
            }
            
            .left-column > div:last-child,
            .right-column > div:last-child {
                flex-grow: 1;
            }
        }
        
        @media (min-width: 1200px) {
            .content-container {
                padding: 0 40px;
            }
        }
        
        @media (max-width: 640px) {
            .content-container {
                padding: 0 10px;
            }
            
            .glass-card {
                padding: 15px !important;
            }
            
            .section-title {
                font-size: 16px;
            }
        }
        
        .flex-grow {
            flex-grow: 1;
        }
    </style>
</head>
<body>
    <!-- 通知组件 -->
    <div id="notification" class="notification">
        <div class="notification-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="notification-text">
            <div class="notification-title">成功</div>
            <div class="notification-message">操作已完成</div>
        </div>
    </div>
    
    <!-- 加载中覆盖层 -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">正在创作文章...</div>
            <div class="loading-subtext">AI正在为您生成高质量内容，请稍候</div>
        </div>
    </div>
    
    <div class="content-container py-8">
        <!-- 页面标题 -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-2">AI文章创作助手</h1>
            <p class="text-gray-600 dark:text-gray-400">优质内容创作，从这里开始</p>
        </div>
        
        <!-- 主内容区域 -->
        <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
            <!-- 左侧功能区域 -->
            <div class="md:col-span-4 lg:col-span-3 left-column">
                <!-- API配置卡片 -->
                <div class="glass-card p-6 mb-6">
                    <h2 class="section-title">
                        <i class="fas fa-cog"></i>
                        API配置
                    </h2>
                    <form id="api-config-form" class="space-y-4">
                        <div>
                            <label for="api-key" class="block mb-2 text-sm font-medium">API密钥</label>
                            <input type="password" id="api-key" class="apple-input text-base" placeholder="输入API密钥">
                        </div>
                        <div>
                            <label for="api-url" class="block mb-2 text-sm font-medium">基础URL</label>
                            <input type="url" id="api-url" class="apple-input text-base" placeholder="例如: https://api.openai.com/v1" value="">
                        </div>
                        <div>
                            <label for="api-model" class="block mb-2 text-sm font-medium">模型名称</label>
                            <input type="text" id="api-model" class="apple-input text-base" placeholder="例如: gpt-4-turbo, claude-3-opus" value="" list="model-suggestions">
                            <datalist id="model-suggestions">
                                <option value="gpt-4-turbo">
                                </option><option value="gpt-4">
                                </option><option value="gpt-3.5-turbo">
                                </option><option value="claude-3-opus">
                                </option><option value="claude-3-sonnet">
                            </option></datalist>
                        </div>
                        <div>
                            <button type="submit" id="save-api-config" class="apple-button w-full flex justify-center items-center">
                                <span id="save-api-text">保存并验证</span>
                                <span id="api-spinner" class="ml-2 spinner-border hidden"></span>
                            </button>
                        </div>
                        <div id="api-status" class="text-center mt-2 hidden"></div>
                    </form>
                </div>
                
                <!-- 创作方式选择 -->
                <div class="glass-card p-6 mb-6">
                    <h2 class="section-title">
                        <i class="fas fa-pen-fancy"></i>
                        创作方式
                    </h2>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="writing-mode-card p-5 active" data-mode="reference">
                            <div class="writing-mode-icon">
                                <i class="fas fa-book-open"></i>
                            </div>
                            <h3 class="font-semibold text-lg mb-1">参考资料创作</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">提供参考资料，AI将帮你创作原创文章</p>
                        </div>
                        <div class="writing-mode-card p-5" data-mode="outline">
                            <div class="writing-mode-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <h3 class="font-semibold text-lg mb-1">大纲创作</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">提供文章大纲，AI助你创建高质量原创内容</p>
                        </div>
                    </div>
                </div>
                
                <!-- 参考资料卡片（参考创作模式） -->
                <div id="reference-section" class="glass-card p-6 mb-6">
                    <h2 class="section-title">
                        <i class="fas fa-book"></i>
                        参考资料
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block mb-2 text-sm font-medium">添加参考文章</label>
                            <div class="flex space-x-2 mb-3">
                                <button id="add-link-btn" class="apple-button flex-1 text-sm">
                                    <i class="fas fa-link mr-1"></i> 链接
                                </button>
                                <button id="add-text-btn" class="apple-button flex-1 text-sm">
                                    <i class="fas fa-font mr-1"></i> 文本
                                </button>
                                <button id="add-file-btn" class="apple-button flex-1 text-sm">
                                    <i class="fas fa-file mr-1"></i> 文件
                                </button>
                            </div>
                            <input type="file" id="file-input" accept=".txt,.md,.doc,.docx,.pdf" class="hidden">
                        </div>
                        
                        <!-- 链接输入区域 -->
                        <div id="link-input-area" class="hidden space-y-2">
                            <input type="url" id="reference-link" class="apple-input text-base" placeholder="输入参考文章URL">
                            <button id="add-link" class="apple-button w-full">添加链接</button>
                        </div>
                        
                        <!-- 文本输入区域 -->
                        <div id="text-input-area" class="hidden space-y-2">
                            <textarea id="reference-text" class="apple-input h-24 text-base" placeholder="粘贴参考文章文本..."></textarea>
                            <button id="add-text" class="apple-button w-full">添加文本</button>
                        </div>
                        
                        <!-- 参考文章列表 -->
                        <div>
                            <h3 class="text-sm font-medium mb-2">已添加参考文章</h3>
                            <div id="reference-list" class="space-y-2 max-h-60 overflow-y-auto">
                                <div class="text-gray-500 dark:text-gray-400 text-sm text-center py-3">
                                    暂无参考文章
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 大纲创作卡片 -->
                <div id="outline-section" class="glass-card p-6 mb-6 hidden">
                    <h2 class="section-title">
                        <i class="fas fa-list-ol"></i>
                        文章大纲
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label for="article-title" class="block mb-2 text-sm font-medium">文章标题</label>
                            <input type="text" id="article-title" class="apple-input text-base" placeholder="输入文章标题">
                        </div>
                        <div>
                            <label for="article-keywords" class="block mb-2 text-sm font-medium">关键词</label>
                            <input type="text" id="article-keywords" class="apple-input text-base" placeholder="用逗号分隔，例如：AI,机器学习,深度学习">
                        </div>
                        <div>
                            <label for="article-outline" class="block mb-2 text-sm font-medium">大纲要点</label>
                            <textarea id="article-outline" class="apple-input h-32 text-base" placeholder="输入文章大纲要点，每行一个"></textarea>
                        </div>
                        <div>
                            <label for="article-tone" class="block mb-2 text-sm font-medium">文章风格</label>
                            <select id="article-tone" class="apple-input text-base">
                                <option value="informative">专业信息型</option>
                                <option value="conversational">轻松对话型</option>
                                <option value="persuasive">说服力型</option>
                                <option value="humorous">幽默风趣型</option>
                                <option value="storytelling">故事叙述型</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- 图片管理卡片 -->
                <div class="glass-card p-6 flex-grow">
                    <h2 class="section-title">
                        <i class="fas fa-images"></i>
                        图片管理
                    </h2>
                    <div class="space-y-4">
                        <div class="image-upload-area" id="image-upload-area">
                            <i class="fas fa-cloud-upload-alt text-3xl mb-3 text-gray-400"></i>
                            <p class="font-medium">拖放或点击上传图片</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400 mt-2">支持直接粘贴图片 (Ctrl+V)</p>
                        </div>
                        <input type="file" id="image-input" accept="image/*" class="hidden">
                        
                        <!-- 图片预览区域 -->
                        <div id="image-preview-container" class="hidden">
                            <div class="relative">
                                <img id="image-preview" class="image-preview rounded-lg" src="" alt="图片预览">
                                <div class="flex mt-3 space-x-2">
                                    <button id="crop-image" class="apple-button flex-1 text-sm">
                                        <i class="fas fa-crop-alt mr-1"></i> 裁剪
                                    </button>
                                    <button id="insert-image" class="apple-button flex-1 text-sm">
                                        <i class="fas fa-plus mr-1"></i> 插入
                                    </button>
                                    <button id="remove-image" class="apple-button flex-1 text-sm bg-red-500">
                                        <i class="fas fa-trash mr-1"></i> 删除
                                    </button>
                                </div>
                                
                                <!-- 图片插入模式选择 -->
                                <div class="insertion-mode-selector mt-3">
                                    <div class="insertion-mode active" data-mode="cursor">
                                        <i class="fas fa-i-cursor mr-1"></i> 插入到光标
                                    </div>
                                    <div class="insertion-mode" data-mode="even">
                                        <i class="fas fa-align-center mr-1"></i> 均匀插入
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 已添加图片库 -->
                        <div>
                            <h3 class="text-sm font-medium mb-2">图片库</h3>
                            <div id="images-gallery" class="image-gallery">
                                <div class="text-gray-500 dark:text-gray-400 text-sm text-center py-3 col-span-full">
                                    暂无添加图片
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧主要内容区域 -->
            <div class="md:col-span-8 lg:col-span-9 right-column">
                <div class="glass-card p-6 mb-6">
                    <!-- 文章提示词 -->
                    <h2 class="section-title">
                        <i class="fas fa-magic"></i>
                        文章提示词
                    </h2>
                    <div class="mb-6">
                        <textarea id="article-prompt" class="apple-input h-24 text-base" placeholder="描述你想要创作的文章主题、风格、结构或其他要求..."></textarea>
                    </div>
                    
                    <!-- 创作按钮 -->
                    <div class="mb-2">
                        <button id="generate-article" class="apple-button w-full py-3 text-lg">
                            <i class="fas fa-magic mr-2"></i> 开始创作
                        </button>
                    </div>
                </div>
                
                <div class="glass-card p-6 flex-grow">
                    <!-- 编辑器标题 -->
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="section-title mb-0">
                            <i class="fas fa-edit"></i>
                            编辑与预览
                        </h2>
                        <div>
                            <button id="format-button" class="apple-button">
                                <i class="fas fa-palette mr-1"></i> 发送至排版工具
                            </button>
                        </div>
                    </div>
                    
                    <!-- 编辑器和预览 -->
                    <div class="editor-preview-split">
                        <div class="editor-container">
                            <textarea id="markdown-editor"></textarea>
                        </div>
                        <div id="preview-container" class="preview-container prose dark:prose-invert"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 图片裁剪模态框 -->
    <div id="crop-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">裁剪图片</h3>
                <button id="close-crop-modal" class="text-2xl cursor-pointer">×</button>
            </div>
            <div class="crop-container mb-4">
                <img id="crop-image-preview" src="" alt="裁剪预览">
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-crop" class="apple-button apple-button-secondary">取消</button>
                <button id="confirm-crop" class="apple-button">确认裁剪</button>
            </div>
        </div>
    </div>
    
    <script>
        // 检测暗黑模式
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // 初始化全局变量
        let mdEditor;
        let cropper;
        let uploadedImages = [];
        let currentImage = null;
        let referenceList = [];
        let currentWritingMode = 'reference';
        let apiConfig = null;
        let currentImageInsertionMode = 'cursor'; // 默认为光标插入
        
        // 通知系统
        const notificationSystem = {
            element: document.getElementById('notification'),
            iconElement: document.querySelector('#notification .notification-icon i'),
            titleElement: document.querySelector('#notification .notification-title'),
            messageElement: document.querySelector('#notification .notification-message'),
            timeoutId: null,
            
            show: function(type, title, message, duration = 3000) {
                // 清除之前的定时器
                if (this.timeoutId) {
                    clearTimeout(this.timeoutId);
                }
                
                // 设置通知类型
                this.element.className = 'notification';
                this.element.classList.add(type);
                
                // 设置图标
                if (type === 'success') {
                    this.iconElement.className = 'fas fa-check-circle';
                } else if (type === 'error') {
                    this.iconElement.className = 'fas fa-exclamation-circle';
                }
                
                // 设置内容
                this.titleElement.textContent = title;
                this.messageElement.textContent = message;
                
                // 显示通知
                this.element.classList.add('show');
                
                // 设置自动隐藏
                this.timeoutId = setTimeout(() => {
                    this.hide();
                }, duration);
            },
            
            hide: function() {
                this.element.classList.remove('show');
            },
            
            success: function(message, title = '成功') {
                this.show('success', title, message);
            },
            
            error: function(message, title = '错误') {
                this.show('error', title, message);
            }
        };
        
        // 加载中系统
        const loadingSystem = {
            element: document.getElementById('loading-overlay'),
            textElement: document.querySelector('#loading-overlay .loading-text'),
            subtextElement: document.querySelector('#loading-overlay .loading-subtext'),
            
            show: function(text = '正在创作文章...', subtext = 'AI正在为您生成高质量内容，请稍候') {
                this.textElement.textContent = text;
                this.subtextElement.textContent = subtext;
                this.element.style.display = 'flex';
            },
            
            hide: function() {
                this.element.style.display = 'none';
            }
        };
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化Markdown编辑器
            mdEditor = new SimpleMDE({
                element: document.getElementById('markdown-editor'),
                spellChecker: false,
                autofocus: false,
                placeholder: "在此编辑你的文章内容...",
                toolbar: [
                    "bold", "italic", "heading", "|", 
                    "quote", "unordered-list", "ordered-list", "|", 
                    "link", "image", "table", "|", 
                    "preview", "side-by-side", "fullscreen", "|", 
                    {
                        name: "copy",
                        action: function() {
                            const markdownContent = mdEditor.value();
                            navigator.clipboard.writeText(markdownContent).then(() => {
                                notificationSystem.success('文章内容已复制到剪贴板');
                            });
                        },
                        className: "fa fa-copy",
                        title: "复制全文",
                    },
                    "guide"
                ],
                status: ["lines", "words"]
            });
            
            // 监听编辑器变化更新预览
            mdEditor.codemirror.on("change", function() {
                updatePreview();
            });
            
            // 创作方式选择
            const writingModeCards = document.querySelectorAll('.writing-mode-card');
            writingModeCards.forEach(card => {
                card.addEventListener('click', function() {
                    // 更新选中状态
                    writingModeCards.forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 保存当前创作模式
                    currentWritingMode = this.getAttribute('data-mode');
                    
                    // 显示/隐藏对应的输入区域
                    if (currentWritingMode === 'reference') {
                        document.getElementById('reference-section').classList.remove('hidden');
                        document.getElementById('outline-section').classList.add('hidden');
                    } else {
                        document.getElementById('reference-section').classList.add('hidden');
                        document.getElementById('outline-section').classList.remove('hidden');
                    }
                    
                    notificationSystem.success(`已切换到${currentWritingMode === 'reference' ? '参考资料创作' : '大纲创作'}模式`);
                });
            });
            
            // 图片插入模式选择
            const insertionModes = document.querySelectorAll('.insertion-mode');
            insertionModes.forEach(mode => {
                mode.addEventListener('click', function() {
                    // 更新选中状态
                    insertionModes.forEach(m => m.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 保存当前插入模式
                    currentImageInsertionMode = this.getAttribute('data-mode');
                    
                    notificationSystem.success(`已切换到${currentImageInsertionMode === 'cursor' ? '光标位置' : '均匀插入'}模式`);
                });
            });
            
            // 加载API配置
            loadApiConfig();
            
            // API表单处理
            document.getElementById('api-config-form').addEventListener('submit', function(e) {
                e.preventDefault();
                validateApiKey();
            });
            
            // 参考资料按钮处理
            document.getElementById('add-link-btn').addEventListener('click', function() {
                toggleInputArea('link-input-area');
            });
            
            document.getElementById('add-text-btn').addEventListener('click', function() {
                toggleInputArea('text-input-area');
            });
            
            document.getElementById('add-file-btn').addEventListener('click', function() {
                document.getElementById('file-input').click();
            });
            
            // 添加链接处理
            document.getElementById('add-link').addEventListener('click', function() {
                const linkInput = document.getElementById('reference-link');
                if (linkInput.value.trim()) {
                    addReferenceItem('link', linkInput.value.trim());
                    linkInput.value = '';
                    document.getElementById('link-input-area').classList.add('hidden');
                    notificationSystem.success('链接已添加到参考资料');
                } else {
                    notificationSystem.error('请输入有效的URL');
                }
            });
            
            // 添加文本处理
            document.getElementById('add-text').addEventListener('click', function() {
                const textInput = document.getElementById('reference-text');
                if (textInput.value.trim()) {
                    addReferenceItem('text', textInput.value.trim());
                    textInput.value = '';
                    document.getElementById('text-input-area').classList.add('hidden');
                    notificationSystem.success('文本已添加到参考资料');
                } else {
                    notificationSystem.error('请输入文本内容');
                }
            });
            
            // 文件上传处理
            document.getElementById('file-input').addEventListener('change', function(e) {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        addReferenceItem('file', {
                            name: file.name,
                            content: event.target.result,
                            type: file.type
                        });
                        notificationSystem.success(`文件 ${file.name} 添加成功`);
                    };
                    
                    if (file.type.includes('text') || file.name.endsWith('.md')) {
                        reader.readAsText(file);
                    } else {
                        reader.readAsDataURL(file);
                    }
                }
            });
            
            // 图片上传区域处理
            const imageUploadArea = document.getElementById('image-upload-area');
            const imageInput = document.getElementById('image-input');
            
            imageUploadArea.addEventListener('click', function() {
                imageInput.click();
            });
            
            imageUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('bg-orange-50', 'dark:bg-orange-900/20');
            });
            
            imageUploadArea.addEventListener('dragleave', function() {
                this.classList.remove('bg-orange-50', 'dark:bg-orange-900/20');
            });
            
            imageUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('bg-orange-50', 'dark:bg-orange-900/20');
                
                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    if (file.type.startsWith('image/')) {
                        processImage(file);
                        notificationSystem.success('图片上传成功');
                    } else {
                        notificationSystem.error('请上传图片文件');
                    }
                }
            });
            
            // 支持粘贴图片
            document.addEventListener('paste', function(e) {
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                let hasImage = false;
                
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const file = items[i].getAsFile();
                        processImage(file);
                        hasImage = true;
                        break;
                    }
                }
                
                if (hasImage) {
                    notificationSystem.success('图片已从剪贴板粘贴');
                }
            });
            
            // 图片文件处理
            imageInput.addEventListener('change', function(e) {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    if (file.type.startsWith('image/')) {
                        processImage(file);
                        notificationSystem.success('图片上传成功');
                    } else {
                        notificationSystem.error('请选择图片文件');
                    }
                }
            });
            
            // 图片裁剪按钮处理
            document.getElementById('crop-image').addEventListener('click', function() {
                openCropModal();
            });
            
            // 图片插入按钮处理
            document.getElementById('insert-image').addEventListener('click', function() {
                if (currentImage) {
                    if (currentImageInsertionMode === 'cursor') {
                        // 插入到光标位置
                        insertImageToEditor(currentImage);
                        notificationSystem.success('图片已插入到光标位置');
                    } else {
                        // 均匀插入模式
                        insertImageEvenly(currentImage);
                        notificationSystem.success('图片已均匀插入到文章中');
                    }
                }
            });
            
            // 图片删除按钮处理
            document.getElementById('remove-image').addEventListener('click', function() {
                if (currentImage) {
                    // 从上传的图片列表中删除
                    const index = uploadedImages.findIndex(img => img.src === currentImage.src);
                    if (index !== -1) {
                        uploadedImages.splice(index, 1);
                    }
                    
                    // 重置当前图片
                    currentImage = null;
                    
                    // 隐藏预览
                    document.getElementById('image-preview-container').classList.add('hidden');
                    
                    // 更新图片列表
                    updateImageGallery();
                    
                    notificationSystem.success('图片已删除');
                }
            });
            
            // 裁剪模态框处理
            document.getElementById('close-crop-modal').addEventListener('click', function() {
                closeCropModal();
            });
            
            document.getElementById('cancel-crop').addEventListener('click', function() {
                closeCropModal();
            });
            
            document.getElementById('confirm-crop').addEventListener('click', function() {
                if (cropper) {
                    const canvas = cropper.getCroppedCanvas({
                        minWidth: 256,
                        minHeight: 256,
                        maxWidth: 4096,
                        maxHeight: 4096,
                    });
                    
                    if (canvas) {
                        canvas.toBlob(function(blob) {
                            const url = URL.createObjectURL(blob);
                            currentImage = {
                                src: url,
                                alt: '裁剪后的图片',
                                file: new File([blob], 'cropped-image.jpg', { type: 'image/jpeg' })
                            };
                            
                            // 更新图片预览
                            document.getElementById('image-preview').src = url;
                            
                            // 添加到图片列表
                            if (!uploadedImages.some(img => img.src === url)) {
                                uploadedImages.push(currentImage);
                                updateImageGallery();
                            }
                            
                            closeCropModal();
                            notificationSystem.success('图片裁剪成功');
                        }, 'image/jpeg');
                    }
                }
            });
            
            // 排版工具按钮处理
            document.getElementById('format-button').addEventListener('click', function() {
                const markdownContent = mdEditor.value();
                
                // 复制内容到剪贴板
                navigator.clipboard.writeText(markdownContent).then(() => {
                    notificationSystem.success('文章内容已复制到剪贴板，即将跳转到排版工具');
                    
                    // 延迟一下再跳转，让用户能看到通知
                    setTimeout(() => {
                        window.open('https://md.doocs.org/', '_blank');
                    }, 1000);
                });
            });
            
            // 生成文章按钮处理
            document.getElementById('generate-article').addEventListener('click', function() {
                generateArticle();
            });
            
            // 初始化示例文章内容
            const sampleContent = `# 人工智能与内容创作的未来

## 引言

随着人工智能技术的快速发展，特别是大型语言模型的出现，内容创作领域正在经历前所未有的变革。本文将探讨AI如何重塑内容创作过程，为创作者带来新的可能性，同时也带来哪些挑战和思考。

## AI辅助创作的优势

AI辅助创作工具正在成为内容创作者的得力助手，主要体现在以下几个方面：

- **效率提升**：AI可以在短时间内生成初稿，大幅缩短创作周期
- **灵感激发**：当创作者面临"白纸恐惧症"时，AI可以提供思路和建议
- **资料整合**：AI能够快速分析和整合大量参考资料，提炼关键信息
- **多样化表达**：提供多种表达方式和写作风格的选择

## 人类创作者的不可替代性

尽管AI在内容生成方面表现出色，但人类创作者仍然具有不可替代的价值：

1. **原创性思维**：真正具有颠覆性的创意往往来自人类独特的思维方式
2. **情感共鸣**：人类对情感体验的深刻理解使作品更具感染力
3. **价值判断**：内容创作中的价值观和伦理判断需要人类把控
4. **文化理解**：深层次的文化背景和社会语境理解仍是人类的优势

## 人机协作的最佳实践

![人机协作创作流程](https://picsum.photos/800/400)

未来最理想的创作模式可能是人机协作，充分发挥双方的优势：

### 内容构思阶段
- 人类提供创意方向和核心观点
- AI协助拓展思路和提供相关参考资料

### 内容创作阶段
- AI生成初稿和素材整理
- 人类进行筛选、重组和深化

### 修改完善阶段
- AI提供多种表达方式的建议
- 人类注入个人风格和情感，确保内容的独特性

## 未来展望

随着技术的不断进步，我们可以期待：

- 更个性化的AI辅助工具，能够适应不同创作者的风格和习惯
- 跨媒体内容创作能力，如文字、图像、音频和视频的一体化创作
- 更深入的行业专业知识融入，AI辅助特定领域的专业内容创作

## 结论

AI不是来取代人类创作者，而是为创作提供新的可能性。通过合理利用AI工具，创作者可以将更多精力投入到真正需要人类智慧的创意和深度思考中，提升内容创作的质量和效率。未来的内容创作将是人类创造力与AI能力的完美结合。

> 技术的进步不是为了替代人类，而是为了释放人类更大的创造力。
`;
            mdEditor.value(sampleContent);
            updatePreview();
        });
        
        // 更新预览
        function updatePreview() {
            const markdownContent = mdEditor.value();
            const htmlContent = marked.parse(markdownContent);
            document.getElementById('preview-container').innerHTML = htmlContent;
        }
        
        // 加载API配置
        function loadApiConfig() {
            try {
                const savedConfig = localStorage.getItem('ai_writer_api_config');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    
                    // 填充表单
                    document.getElementById('api-key').value = config.key || '';
                    document.getElementById('api-url').value = config.url || '';
                    document.getElementById('api-model').value = config.model || '';
                    
                    // 保存到全局变量
                    apiConfig = config;
                    
                    // 显示状态
                    const statusElement = document.getElementById('api-status');
                    statusElement.innerHTML = `
                        <div class="api-status-badge success">
                            <i class="fas fa-check-circle"></i>
                            <span>API配置已加载</span>
                        </div>
                    `;
                    statusElement.classList.remove('hidden');
                }
            } catch (error) {
                console.error('加载API配置出错:', error);
            }
        }
        
        // 保存API配置
        function saveApiConfig(config) {
            try {
                // 保存到localStorage
                localStorage.setItem('ai_writer_api_config', JSON.stringify(config));
                
                // 保存到全局变量
                apiConfig = config;
                
                // 显示成功状态
                const statusElement = document.getElementById('api-status');
                statusElement.innerHTML = `
                    <div class="api-status-badge success">
                        <i class="fas fa-check-circle"></i>
                        <span>API配置已保存</span>
                    </div>
                `;
                statusElement.classList.remove('hidden');
                
                notificationSystem.success('API配置已保存');
            } catch (error) {
                console.error('保存API配置出错:', error);
                notificationSystem.error('保存API配置失败: ' + error.message);
            }
        }
        
        // 切换显示参考资料输入区域
        function toggleInputArea(areaId) {
            const areas = ['link-input-area', 'text-input-area'];
            areas.forEach(id => {
                if (id === areaId) {
                    const element = document.getElementById(id);
                    if (element.classList.contains('hidden')) {
                        element.classList.remove('hidden');
                    } else {
                        element.classList.add('hidden');
                    }
                } else {
                    document.getElementById(id).classList.add('hidden');
                }
            });
        }
        
        // 添加参考资料
        function addReferenceItem(type, content) {
            const referenceListElement = document.getElementById('reference-list');
            
            // 移除"暂无参考文章"提示（如果存在）
            const emptyMessage = referenceListElement.querySelector('.text-gray-500');
            if (emptyMessage) {
                referenceListElement.removeChild(emptyMessage);
            }
            
            // 创建参考资料项
            const item = document.createElement('div');
            item.className = 'reference-item fade-in';
            
            let title = '';
            let preview = '';
            
            if (type === 'link') {
                title = content;
                preview = '链接参考';
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="reference-badge"><i class="fas fa-link"></i> 链接</span>
                            <a href="${content}" target="_blank" class="text-blue-500 hover:underline truncate block" title="${content}">${truncateText(content, 30)}</a>
                        </div>
                        <button class="delete-reference text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            } else if (type === 'text') {
                title = '文本内容';
                preview = content;
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="reference-badge"><i class="fas fa-font"></i> 文本</span>
                            <div class="text-sm mt-1 text-gray-700 dark:text-gray-300">${truncateText(content, 100)}</div>
                        </div>
                        <button class="delete-reference text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            } else if (type === 'file') {
                title = content.name;
                preview = content.type.includes('text') || content.name.endsWith('.md') 
                    ? content.content 
                    : '文件内容';
                
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="reference-badge"><i class="fas fa-file-alt"></i> 文件</span>
                            <div class="flex items-center">
                                <i class="fas fa-file-alt mr-2"></i>
                                <span class="truncate" title="${content.name}">${truncateText(content.name, 25)}</span>
                            </div>
                        </div>
                        <button class="delete-reference text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }
            
            // 保存参考资料
            referenceList.push({
                type,
                title,
                content: preview,
                raw: content
            });
            
            // 添加到参考列表
            referenceListElement.appendChild(item);
            
            // 添加删除按钮事件
            item.querySelector('.delete-reference').addEventListener('click', function() {
                referenceListElement.removeChild(item);
                
                // 从参考列表中删除
                const index = referenceList.findIndex(ref => 
                    (ref.type === type && 
                     ((type === 'link' && ref.raw === content) || 
                      (type === 'text' && ref.raw === content) || 
                      (type === 'file' && ref.raw.name === content.name))));
                
                if (index !== -1) {
                    referenceList.splice(index, 1);
                }
                
                // 如果没有参考资料，显示"暂无参考文章"提示
                if (referenceList.length === 0) {
                    referenceListElement.innerHTML = `
                        <div class="text-gray-500 dark:text-gray-400 text-sm text-center py-3">
                            暂无参考文章
                        </div>
                    `;
                }
                
                notificationSystem.success('参考资料已删除');
            });
        }
        
        // 处理上传图片
        function processImage(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // 显示图片预览
                document.getElementById('image-preview').src = e.target.result;
                document.getElementById('image-preview-container').classList.remove('hidden');
                
                // 保存当前图片信息
                currentImage = {
                    src: e.target.result,
                    alt: file.name || '上传的图片',
                    file: file
                };
                
                // 添加到图片列表
                if (!uploadedImages.some(img => img.src === e.target.result)) {
                    uploadedImages.push(currentImage);
                    updateImageGallery();
                }
            };
            
            reader.readAsDataURL(file);
        }
        
        // 更新图片库
        function updateImageGallery() {
            const galleryElement = document.getElementById('images-gallery');
            
            if (uploadedImages.length === 0) {
                galleryElement.innerHTML = `
                    <div class="text-gray-500 dark:text-gray-400 text-sm text-center py-3 col-span-full">
                        暂无添加图片
                    </div>
                `;
                return;
            }
            
            galleryElement.innerHTML = '';
            
            uploadedImages.forEach((image, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                imageItem.innerHTML = `
                    <img src="${image.src}" alt="${image.alt}" class="w-full h-full object-cover">
                    <div class="image-overlay">
                        <button class="text-white bg-orange-500 rounded-full w-8 h-8 flex items-center justify-center select-image" data-index="${index}">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                `;
                
                galleryElement.appendChild(imageItem);
                
                // 添加点击事件
                imageItem.querySelector('.select-image').addEventListener('click', function() {
                    currentImage = uploadedImages[index];
                    document.getElementById('image-preview').src = currentImage.src;
                    document.getElementById('image-preview-container').classList.remove('hidden');
                });
            });
        }
        
        // 打开裁剪模态框
        function openCropModal() {
            if (!currentImage) return;
            
            const modal = document.getElementById('crop-modal');
            const cropImagePreview = document.getElementById('crop-image-preview');
            
            // 设置预览图片
            cropImagePreview.src = currentImage.src;
            
            // 显示模态框
            modal.style.display = 'block';
            
            // 初始化Cropper.js
            cropper = new Cropper(cropImagePreview, {
                aspectRatio: NaN, // 自由比例
                viewMode: 1, // 限制裁剪框不超出图片的范围
                guides: true,
                center: true,
                highlight: false,
                background: false,
                autoCropArea: 0.8,
                responsive: true,
            });
        }
        
        // 关闭裁剪模态框
        function closeCropModal() {
            const modal = document.getElementById('crop-modal');
            modal.style.display = 'none';
            
            // 销毁Cropper实例
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }
        
        // 插入图片到编辑器（光标位置）
        function insertImageToEditor(image) {
            // 获取游标位置
            const position = mdEditor.codemirror.getCursor();
            
            // 插入Markdown图片语法
            const imageMarkdown = `\n\n![${image.alt}](${image.src})\n\n`;
            mdEditor.codemirror.replaceRange(imageMarkdown, position);
            
            // 聚焦编辑器
            mdEditor.codemirror.focus();
        }
        
        // 均匀插入图片到文章中
        function insertImageEvenly(image) {
            const content = mdEditor.value();
            
            // 找到所有段落（通过空行分隔）
            const paragraphs = content.split(/\n\n+/);
            
            if (paragraphs.length <= 1) {
                // 如果没有足够的段落，直接附加到末尾
                mdEditor.value(content + `\n\n![${image.alt}](${image.src})\n\n`);
            } else {
                // 计算一个合适的位置（避开开头和结尾）
                const middleIndex = Math.floor(paragraphs.length / 2);
                
                // 计算插入图片的位置
                const insertPosition = (paragraphs.slice(0, middleIndex).join('\n\n')).length + 2;
                
                // 插入图片
                const newContent = content.slice(0, insertPosition) + 
                                  `\n\n![${image.alt}](${image.src})\n\n` + 
                                  content.slice(insertPosition);
                
                mdEditor.value(newContent);
            }
            
            // 更新预览
            updatePreview();
        }
        
        // 验证API密钥
        async function validateApiKey() {
            const apiKey = document.getElementById('api-key').value.trim();
            const apiUrl = document.getElementById('api-url').value.trim();
            const apiModel = document.getElementById('api-model').value.trim();
            
            if (!apiKey) {
                notificationSystem.error('请填写API密钥');
                return;
            }
            
            // 保存配置
            const config = {
                key: apiKey,
                url: apiUrl || 'https://api.openai.com/v1',
                model: apiModel || 'gpt-3.5-turbo'
            };
            
            // 保存配置（即使验证失败）
            saveApiConfig(config);
            
            // 显示加载状态
            const saveButton = document.getElementById('save-api-config');
            const saveText = document.getElementById('save-api-text');
            const spinner = document.getElementById('api-spinner');
            const originalText = saveText.textContent;
            
            saveText.textContent = '验证中...';
            spinner.classList.remove('hidden');
            saveButton.disabled = true;
            
            try {
                // 简化的API测试 (只发送一个字符的请求)
                const testMessage = 'a'; // 最小化的测试消息
                
                // 确定API类型和处理URL格式
                let baseUrl = config.url;
                if (!baseUrl) baseUrl = 'https://api.openai.com/v1';
                if (baseUrl.endsWith('/')) baseUrl = baseUrl.slice(0, -1);
                
                let testUrl = `${baseUrl}/chat/completions`;
                let headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                };
                
                // 极简请求体
                const requestBody = {
                    model: config.model,
                    messages: [{ role: "user", content: testMessage }],
                    max_tokens: 1 // 只请求一个token以减少API成本
                };
                
                // 设置超时
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒超时
                
                // 发送请求
                const response = await fetch(testUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                }).catch(err => {
                    if (err.name === 'AbortError') {
                        throw new Error('请求超时，请检查网络或API地址');
                    }
                    throw err;
                });
                
                // 清除超时
                clearTimeout(timeoutId);
                
                // 恢复按钮状态
                saveText.textContent = originalText;
                spinner.classList.add('hidden');
                saveButton.disabled = false;
                
                if (response && response.ok) {
                    // 验证成功
                    notificationSystem.success('API验证成功，配置已保存');
                    
                    const statusElement = document.getElementById('api-status');
                    statusElement.innerHTML = `
                        <div class="api-status-badge success">
                            <i class="fas fa-check-circle"></i>
                            <span>API配置有效</span>
                        </div>
                    `;
                    statusElement.classList.remove('hidden');
                } else {
                    // 验证失败但仍保存配置
                    const statusCode = response ? response.status : 'unknown';
                    let errorMsg = '';
                    
                    try {
                        if (response) {
                            const errorData = await response.json();
                            errorMsg = errorData.error?.message || errorData.message || `API返回错误: ${statusCode}`;
                        } else {
                            errorMsg = '请求失败，无响应';
                        }
                    } catch {
                        errorMsg = `API返回错误: ${statusCode}`;
                    }
                    
                    const statusElement = document.getElementById('api-status');
                    statusElement.innerHTML = `
                        <div class="api-status-badge error">
                            <i class="fas fa-exclamation-circle"></i>
                            <span>验证失败，已保存配置</span>
                        </div>
                    `;
                    statusElement.classList.remove('hidden');
                    
                    notificationSystem.error(`API验证失败: ${errorMsg}，但配置已保存`);
                }
            } catch (error) {
                console.error('API验证错误:', error);
                
                // 恢复按钮状态
                saveText.textContent = originalText;
                spinner.classList.add('hidden');
                saveButton.disabled = false;
                
                const statusElement = document.getElementById('api-status');
                statusElement.innerHTML = `
                    <div class="api-status-badge error">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>验证出错，已保存配置</span>
                    </div>
                `;
                statusElement.classList.remove('hidden');
                
                notificationSystem.error(`配置已保存，但验证出错: ${error.message}`);
            }
        }
        
        // 生成文章
        function generateArticle() {
            // 检查API配置
            if (!apiConfig) {
                notificationSystem.error('请先配置API');
                return;
            }
            
            // 获取创作类型
            const creationType = currentWritingMode;
            
            // 获取文章提示词
            const articlePrompt = document.getElementById('article-prompt').value.trim();
            
            // 检查提示词是否为空
            if (!articlePrompt) {
                notificationSystem.error('请输入文章提示词');
                return;
            }
            
            // 根据创作类型检查必要输入
            if (creationType === 'reference' && referenceList.length === 0) {
                notificationSystem.error('参考资料创作模式需要至少添加一个参考资料');
                return;
            } else if (creationType === 'outline') {
                const title = document.getElementById('article-title').value.trim();
                const keywords = document.getElementById('article-keywords').value.trim();
                
                if (!title) {
                    notificationSystem.error('请输入文章标题');
                    return;
                }
                
                if (!keywords) {
                    notificationSystem.error('请输入关键词');
                    return;
                }
            }
            
            // 显示加载中
            loadingSystem.show();
            
            // 准备文章生成的提示词和数据
            let systemPrompt = '';
            let userPrompt = '';
            
            if (creationType === 'reference') {
                // 参考资料创作模式
                systemPrompt = "你是一位专业的内容创作者，你的任务是根据提供的参考资料和要求，创建一篇高质量的原创文章。文章应当结构清晰，语言流畅，观点明确，内容丰富。请避免简单拼接或复制参考资料的内容，而是真正理解资料并进行融合、提炼和扩展，形成独特的新内容。请使用Markdown格式输出文章。";
                
                // 构建参考资料内容
                const referenceContent = referenceList.map(ref => {
                    if (ref.type === 'link') {
                        return `参考链接: ${ref.raw}`;
                    } else if (ref.type === 'text') {
                        return `参考文本:\n${ref.raw}`;
                    } else if (ref.type === 'file') {
                        return `参考文件 (${ref.title}):\n${ref.content}`;
                    }
                }).join('\n\n');
                
                userPrompt = `请根据以下参考资料，创作一篇关于"${articlePrompt}"的原创文章。\n\n参考资料：\n${referenceContent}\n\n要求：\n1. 文章需要有清晰的结构，包括标题、引言、主体和结论\n2. 合理引用参考资料中的内容，但不要直接复制\n3. 文章风格要专业、流畅\n4. 总字数约1500-2000字\n5. 使用Markdown格式，确保标题、小标题等层次清晰\n6. 结构清晰，可以适当使用要点列表、引用等Markdown元素增强表现力`;
            } else {
                // 大纲创作模式
                const title = document.getElementById('article-title').value.trim();
                const keywords = document.getElementById('article-keywords').value.trim();
                const outline = document.getElementById('article-outline').value.trim();
                const tone = document.getElementById('article-tone').value;
                
                let toneDescription = '';
                switch(tone) {
                    case 'informative': toneDescription = '专业信息型，客观、准确、详细'; break;
                    case 'conversational': toneDescription = '轻松对话型，亲切自然，像朋友间交流'; break;
                    case 'persuasive': toneDescription = '说服力型，有强烈的论点和有力的论证'; break;
                    case 'humorous': toneDescription = '幽默风趣型，带有俏皮的语言和有趣的比喻'; break;
                    case 'storytelling': toneDescription = '故事叙述型，具有引人入胜的叙事和情感共鸣'; break;
                    default: toneDescription = '专业信息型，客观、准确、详细';
                }
                
                systemPrompt = "你是一位专业的内容创作者，你的任务是根据提供的标题、关键词、大纲和风格要求，创建一篇高质量的原创文章。文章应当结构清晰，语言流畅，观点明确，内容丰富。请使用Markdown格式输出文章。";
                
                userPrompt = `请根据以下要素，为我创作一篇原创文章：\n\n标题: ${title}\n\n关键词: ${keywords}\n\n大纲要点:\n${outline}\n\n文章风格: ${toneDescription}\n\n文章主题/要求: ${articlePrompt}\n\n要求：\n1. 文章需要有引言、主体内容和结论\n2. 内容丰富、观点明确\n3. 确保覆盖所有提供的大纲要点\n4. 适当使用关键词\n5. 总字数约1500-2000字\n6. 使用Markdown格式，确保标题、小标题等层次清晰\n7. 结构清晰，可以适当使用要点列表、引用等Markdown元素增强表现力`;
            }
            
            // 调用API生成文章
            generateContentWithAI(systemPrompt, userPrompt)
                .then(content => {
                    // 更新编辑器内容
                    mdEditor.value(content);
                    
                    // 更新预览
                    updatePreview();
                    
                    // 隐藏加载中
                    loadingSystem.hide();
                    
                    // 显示成功通知
                    notificationSystem.success('文章生成成功！');
                })
                .catch(error => {
                    loadingSystem.hide();
                    notificationSystem.error(`生成文章失败: ${error.message}`);
                    console.error('生成文章错误:', error);
                });
        }
        
        // 使用API生成内容
        async function generateContentWithAI(systemPrompt, userPrompt) {
            try {
                if (!apiConfig) {
                    throw new Error('API配置无效');
                }
                
                const { key, url, model } = apiConfig;
                
                // 确保URL格式正确
                let baseUrl = url;
                if (!baseUrl) baseUrl = 'https://api.openai.com/v1';
                if (baseUrl.endsWith('/')) baseUrl = baseUrl.slice(0, -1);
                
                // 构建完整URL
                const endpoint = `${baseUrl}/chat/completions`;
                
                // 设置标准请求头
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${key}`
                };
                
                // 构建请求数据
                const requestData = {
                    model: model || 'gpt-3.5-turbo',
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: userPrompt }
                    ],
                    temperature: 0.7,
                    max_tokens: 4000
                };
                
                // 设置请求超时
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60秒超时
                
                // 发送请求
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestData),
                    signal: controller.signal
                }).catch(err => {
                    if (err.name === 'AbortError') {
                        throw new Error('请求超时，可能是API响应时间过长');
                    }
                    throw err;
                });
                
                // 清除超时
                clearTimeout(timeoutId);
                
                // 处理响应
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API错误: ${errorData.error?.message || response.statusText || '未知错误'}`);
                }
                
                const data = await response.json();
                
                // 提取生成的内容
                if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                    return data.choices[0].message.content;
                } else {
                    throw new Error('API返回的数据格式不正确');
                }
            } catch (error) {
                console.error('AI内容生成错误:', error);
                throw error;
            }
        }
        
        // 辅助函数：截断文本
        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }
    </script>


</body></html>
