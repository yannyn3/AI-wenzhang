<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI文章助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.12/dist/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.12/dist/cropper.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600&display=swap');
        
        :root {
            --system-gray-100: #F2F2F7;
            --system-gray-200: #E5E5EA;
            --system-gray-300: #D1D1D6;
            --system-gray-400: #C7C7CC;
            --system-gray-500: #AEAEB2;
            --system-gray-600: #8E8E93;
            --system-gray-700: #636366;
            --system-gray-800: #48484A;
            --system-gray-900: #3A3A3C;
            --system-gray-1000: #2C2C2E;
            --system-blue: #007AFF;
            --system-green: #34C759;
            --system-red: #FF3B30;
            --system-orange: #FF9500;
            --apple-background: #F5F5F7;
        }
        
        .dark {
            --system-gray-100: #1C1C1E;
            --system-gray-200: #2C2C2E;
            --system-gray-300: #3A3A3C;
            --system-gray-400: #48484A;
            --system-gray-500: #636366;
            --system-gray-600: #8E8E93;
            --system-gray-700: #AEAEB2;
            --system-gray-800: #C7C7CC;
            --system-gray-900: #D1D1D6;
            --system-gray-1000: #E5E5EA;
            --system-blue: #0A84FF;
            --system-green: #30D158;
            --system-red: #FF453A;
            --system-orange: #FF9F0A;
            --apple-background: #000000;
        }
        
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--apple-background);
            color: var(--system-gray-900);
            transition: background-color 0.3s ease, color 0.3s ease;
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }
        
        .apple-card {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.04);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .dark .apple-card {
            background-color: rgba(30, 30, 30, 0.8);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(60, 60, 60, 0.1);
        }
        
        .apple-card:hover {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08), 0 2px 6px rgba(0, 0, 0, 0.06);
            transform: translateY(-2px);
        }
        
        .dark .apple-card:hover {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .apple-btn {
            background-color: var(--system-blue);
            color: white;
            border-radius: 12px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.2s ease;
            border: none;
            font-size: 16px;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .apple-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.15);
        }
        
        .apple-btn:active {
            opacity: 0.8;
            transform: translateY(0);
        }
        
        .apple-btn-secondary {
            background-color: rgba(0, 122, 255, 0.1);
            color: var(--system-blue);
        }
        
        .dark .apple-btn-secondary {
            background-color: rgba(10, 132, 255, 0.15);
        }
        
        .apple-btn-danger {
            background-color: var(--system-red);
        }
        
        .apple-btn-success {
            background-color: var(--system-green);
        }
        
        .apple-input {
            background-color: var(--system-gray-100);
            border: 1px solid var(--system-gray-300);
            border-radius: 12px;
            padding: 12px 16px;
            color: var(--system-gray-900);
            font-size: 16px;
            transition: all 0.2s ease;
            width: 100%;
            outline: none;
        }
        
        .apple-input:focus {
            border-color: var(--system-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
        }
        
        .dark .apple-input {
            background-color: var(--system-gray-200);
            color: var(--system-gray-1000);
        }
        
        .image-upload-area {
            border: 2px dashed var(--system-gray-400);
            border-radius: 12px;
            min-height: 120px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer;
            padding: 20px;
        }
        
        .image-upload-area.active {
            border-color: var(--system-blue);
            background-color: rgba(0, 122, 255, 0.05);
        }
        
        .image-upload-area:hover {
            border-color: var(--system-blue);
            background-color: rgba(0, 122, 255, 0.03);
        }
        
        .tab-btn {
            color: var(--system-gray-600);
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            padding: 10px 16px;
            font-weight: 500;
        }
        
        .tab-btn.active {
            color: var(--system-blue);
            border-bottom: 2px solid var(--system-blue);
        }
        
        .preview-markdown {
            line-height: 1.7;
        }
        
        .preview-markdown h1 {
            font-size: 28px;
            font-weight: 600;
            margin-top: 28px;
            margin-bottom: 18px;
            color: var(--system-gray-900);
        }
        
        .preview-markdown h2 {
            font-size: 24px;
            font-weight: 600;
            margin-top: 24px;
            margin-bottom: 16px;
            color: var(--system-gray-900);
        }
        
        .preview-markdown h3 {
            font-size: 20px;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 14px;
            color: var(--system-gray-900);
        }
        
        .preview-markdown p {
            margin-bottom: 16px;
            color: var(--system-gray-800);
        }
        
        .preview-markdown img {
            max-width: 100%;
            border-radius: 8px;
            margin: 24px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .dark .preview-markdown img {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .preview-markdown blockquote {
            border-left: 4px solid var(--system-gray-400);
            padding-left: 16px;
            color: var(--system-gray-600);
            font-style: italic;
            margin: 16px 0;
        }
        
        .preview-markdown code {
            background-color: var(--system-gray-200);
            padding: 3px 6px;
            border-radius: 4px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.9em;
        }
        
        .fade-transition {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .fade-enter {
            opacity: 0;
            transform: translateY(10px);
        }
        
        .fade-enter-active {
            opacity: 1;
            transform: translateY(0);
        }
        
        .image-preview {
            max-width: 150px;
            max-height: 150px;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        
        .dark .image-preview {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        .image-preview:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .drop-shadow-apple {
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.05));
        }
        
        .dark .drop-shadow-apple {
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.2));
        }
        
        #referenceList {
            max-height: 240px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--system-gray-400) transparent;
        }
        
        #referenceList::-webkit-scrollbar {
            width: 6px;
        }
        
        #referenceList::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #referenceList::-webkit-scrollbar-thumb {
            background-color: var(--system-gray-400);
            border-radius: 3px;
        }
        
        .loading-spinner {
            border: 3px solid rgba(0, 122, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--system-blue);
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 图片裁剪部分 */
        .cropper-container {
            max-height: 70vh;
        }
        
        /* 美化滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background-color: var(--system-gray-400);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--system-gray-500);
        }
        
        /* 毛玻璃效果 */
        .glass-effect {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .dark .glass-effect {
            background: rgba(30, 30, 30, 0.7);
            border: 1px solid rgba(60, 60, 60, 0.1);
        }
        
        /* 优雅的过渡动画 */
        .slide-up {
            animation: slideUp 0.5s ease forwards;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* 标题装饰 */
        .section-title {
            display: flex;
            align-items: center;
            font-weight: 600;
            margin-bottom: 1.25rem;
            position: relative;
        }
        
        .section-title svg {
            margin-right: 0.5rem;
        }
        
        /* 通知样式 */
        .notification {
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* 点击涟漪效果 */
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple:after {
            content: "";
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }
        
        .ripple:active:after {
            transform: scale(0, 0);
            opacity: .3;
            transition: 0s;
        }
        
        .dark .ripple:after {
            background-image: radial-gradient(circle, rgba(255, 255, 255, 0.3) 10%, transparent 10.01%);
        }
        
        /* 预览面板样式 */
        .preview-panel-container {
            position: fixed;
            right: 0;
            top: 0;
            width: 40%;
            height: 100vh;
            z-index: 40;
            transition: transform 0.5s ease;
            transform: translateX(100%);
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.1);
        }
        
        .preview-panel-container.show {
            transform: translateX(0);
        }
        
        .dark .preview-panel-container {
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.3);
        }
        
        .preview-handle {
            position: absolute;
            left: -24px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 60px;
            background-color: var(--system-blue);
            border-radius: 8px 0 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .dark .preview-handle {
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
        }
        
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #000000;
                color: #E5E5EA;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <header class="text-center mb-10 slide-up">
            <h1 class="text-4xl font-semibold mb-3 tracking-tight">AI文章助手</h1>
            <p class="text-base text-gray-500 dark:text-gray-400 max-w-2xl mx-auto">基于大型语言模型，快速生成高质量文章，支持参考资料和图片插入</p>
        </header>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- 左侧面板：API设置 + 参考文章 -->
            <div>
                <div class="apple-card p-7 mb-7 slide-up" style="animation-delay: 0.1s;">
                    <h2 class="section-title text-2xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        API 配置
                    </h2>
                    <div class="space-y-5">
                        <div>
                            <label for="apiUrl" class="block text-sm font-medium mb-2">API URL</label>
                            <input type="text" id="apiUrl" class="apple-input" placeholder="https://api.example.com/v1" value="https://api.openai.com/v1/chat/completions">
                        </div>
                        <div>
                            <label for="apiKey" class="block text-sm font-medium mb-2">API 密钥</label>
                            <input type="password" id="apiKey" class="apple-input" placeholder="sk-...">
                        </div>
                        <div>
                            <label for="modelSelect" class="block text-sm font-medium mb-2">选择模型</label>
                            <select id="modelSelect" class="apple-input">
                                <option value="gpt-4o">GPT-4o</option>
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                <option value="claude-3-opus">Claude 3 Opus</option>
                                <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                                <option value="custom">自定义模型</option>
                            </select>
                        </div>
                        <div id="customModelContainer" class="hidden">
                            <label for="customModel" class="block text-sm font-medium mb-2">自定义模型名称</label>
                            <input type="text" id="customModel" class="apple-input" placeholder="model-name">
                        </div>
                        
                        <div class="flex justify-between space-x-4 pt-2">
                            <button id="testApi" class="apple-btn apple-btn-secondary ripple flex-1 py-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                </svg>
                                测试连接
                            </button>
                            <button id="saveApiConfig" class="apple-btn ripple flex-1 py-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                </svg>
                                保存配置
                            </button>
                        </div>
                        
                        <div id="apiConnectionInfo" class="hidden mt-4 p-4 rounded-lg text-sm"></div>
                    </div>
                </div>
                
                <div class="apple-card p-7 slide-up" style="animation-delay: 0.2s;">
                    <h2 class="section-title text-2xl mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        参考资料
                    </h2>
                    
                    <div class="space-y-5">
                        <div class="flex space-x-2 border-b border-gray-200 dark:border-gray-700">
                            <button id="btnAddLink" class="tab-btn active flex-1 text-center py-3">链接</button>
                            <button id="btnAddText" class="tab-btn flex-1 text-center py-3">文本</button>
                            <button id="btnAddFile" class="tab-btn flex-1 text-center py-3">文件</button>
                        </div>
                        
                        <div id="addLinkPanel" class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800">
                            <input type="text" id="referenceLink" class="apple-input mb-3" placeholder="https://example.com/article">
                            <button id="addLinkBtn" class="apple-btn w-full py-3 ripple">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                                </svg>
                                添加链接
                            </button>
                        </div>
                        
                        <div id="addTextPanel" class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800 hidden">
                            <textarea id="referenceText" class="apple-input mb-3 h-28" placeholder="粘贴文章内容..."></textarea>
                            <button id="addTextBtn" class="apple-btn w-full py-3 ripple">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                添加文本
                            </button>
                        </div>
                        
                        <div id="addFilePanel" class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800 hidden">
                            <input type="file" id="referenceFile" class="hidden" accept=".txt,.md,.docx,.pdf">
                            <div id="dropArea" class="image-upload-area cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="text-sm text-center font-medium mb-1">点击或拖放文件到此处</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 text-center">支持 .txt, .md, .docx, .pdf</p>
                            </div>
                            <div id="fileInfo" class="mt-3 text-sm hidden"></div>
                            <button id="addFileBtn" class="apple-btn w-full py-3 mt-3 ripple hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                添加文件
                            </button>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-base font-medium">已添加参考 (<span id="referenceCount">0</span>)</h3>
                                <button id="clearReferences" class="text-sm text-red-500 hover:text-red-600 hidden">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                    清空
                                </button>
                            </div>
                            <div id="referenceList" class="space-y-3 border-t border-gray-200 dark:border-gray-700 pt-3">
                                <div class="text-sm text-gray-500 dark:text-gray-400 italic text-center py-6">尚未添加参考内容</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧面板：文章设置 + 图片 + 生成按钮 -->
            <div>
                <div class="apple-card p-7 mb-7 slide-up" style="animation-delay: 0.3s;">
                    <h2 class="section-title text-2xl mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        文章设置
                    </h2>
                    
                    <div class="space-y-5">
                        <div>
                            <label for="articleTitle" class="block text-sm font-medium mb-2">文章标题 *</label>
                            <input type="text" id="articleTitle" class="apple-input" placeholder="输入文章标题...">
                        </div>
                        
                        <div>
                            <label for="contentLength" class="block text-sm font-medium mb-2">内容长度</label>
                            <select id="contentLength" class="apple-input">
                                <option value="short">短文 (~800字)</option>
                                <option value="medium" selected="">中等 (~1500字)</option>
                                <option value="long">长文 (~3000字)</option>
                                <option value="custom">自定义</option>
                            </select>
                        </div>
                        
                        <div id="customLengthContainer" class="hidden">
                            <label for="customLength" class="block text-sm font-medium mb-2">自定义字数</label>
                            <input type="number" id="customLength" class="apple-input" placeholder="输入字数" min="100">
                        </div>
                        
                        <div>
                            <label for="promptInput" class="block text-sm font-medium mb-2">详细提示词</label>
                            <textarea id="promptInput" class="apple-input h-48" placeholder="在这里输入详细的文章要求，包括关键词、风格、结构等..."></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="apple-card p-7 slide-up" style="animation-delay: 0.4s;">
                    <h2 class="section-title text-2xl mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        图片管理
                    </h2>
                    
                    <div class="space-y-5">
                        <div id="imageDropArea" class="image-upload-area" ondragover="event.preventDefault()" ondragleave="document.getElementById('imageDropArea').classList.remove('active')" ondragenter="document.getElementById('imageDropArea').classList.add('active')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <p class="text-base font-medium mb-1 text-center">拖放图片或粘贴截图到此处</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400 text-center">支持 JPG, PNG, GIF, WEBP</p>
                        </div>
                        
                        <div id="imageInsertionOptions" class="hidden">
                            <label for="imageDistribution" class="block text-sm font-medium mb-2">图片插入分布</label>
                            <select id="imageDistribution" class="apple-input">
                                <option value="balanced" selected="">均衡分布</option>
                                <option value="top-heavy">集中在前部</option>
                                <option value="bottom-heavy">集中在后部</option>
                                <option value="custom">自定义位置</option>
                            </select>
                            <div id="customPositionContainer" class="mt-3 hidden">
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">拖动图片调整插入顺序</p>
                                <div id="customImagePositions" class="flex flex-wrap gap-3"></div>
                            </div>
                        </div>
                        
                        <div id="imageGallery" class="hidden">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-base font-medium">已添加图片 (<span id="imageCount">0</span>)</h3>
                                <button id="clearImages" class="text-sm text-red-500 hover:text-red-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                    清空图片
                                </button>
                            </div>
                            <div id="imageList" class="flex flex-wrap gap-3 border-t border-gray-200 dark:border-gray-700 pt-3"></div>
                        </div>
                        
                        <div class="pt-4">
                            <button id="generateArticleBtn" class="apple-btn w-full py-4 text-lg font-medium ripple">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                生成文章
                            </button>
                            
                            <button id="previewArticleBtn" class="apple-btn apple-btn-secondary w-full py-3 mt-3 text-base font-medium ripple">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                                预览文章
                            </button>
                            
                            <div id="generationStatus" class="hidden mt-4">
                                <div class="flex items-center space-x-3 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                                    <div id="loadingSpinner" class="loading-spinner"></div>
                                    <span id="statusText" class="text-sm font-medium">正在生成文章...</span>
                                </div>
                                <div class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-right">
                                    <span id="tokenCount">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 预览面板 -->
    <div id="previewPanelContainer" class="preview-panel-container glass-effect">
        <div class="preview-handle" id="previewHandle">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
        </div>
        <div class="h-full flex flex-col">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h2 class="text-2xl font-semibold flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    文章预览
                </h2>
                <div class="flex space-x-2">
                    <button id="editArticleBtn" class="text-sm flex items-center px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                        </svg>
                        编辑
                    </button>
                    <button id="copyArticleBtn" class="text-sm flex items-center px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                        复制
                    </button>
                    <button id="openEditorBtn" class="text-sm flex items-center px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                        外部编辑
                    </button>
                    <button id="closePreviewBtn" class="text-sm flex items-center p-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6 flex-1 overflow-hidden flex flex-col">
                <div id="previewTabs" class="flex border-b border-gray-200 dark:border-gray-700 mb-4">
                    <button id="previewTabBtn" class="tab-btn active py-2 px-6 text-base">预览</button>
                    <button id="markdownTabBtn" class="tab-btn py-2 px-6 text-base">Markdown</button>
                </div>
                
                <div id="previewContent" class="preview-panel flex-1 overflow-hidden">
                    <div id="articlePreview" class="preview-markdown p-4 border border-gray-200 dark:border-gray-700 rounded-lg h-full overflow-y-auto bg-white dark:bg-gray-900">
                        <div class="text-center text-gray-500 dark:text-gray-400 py-20">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-300 dark:text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p class="text-xl font-medium mb-2">文章预览区</p>
                            <p class="text-sm max-w-md mx-auto">填写文章标题和提示词，点击"生成文章"按钮开始创作</p>
                        </div>
                    </div>
                </div>
                
                <div id="markdownContent" class="preview-panel hidden flex-1 overflow-hidden">
                    <textarea id="markdownEditor" class="apple-input w-full h-full font-mono text-sm" placeholder="文章生成后将在此处显示 Markdown 源码" readonly=""></textarea>
                </div>
                
                <div id="copyStatus" class="hidden mt-3 py-2 px-4 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 text-sm rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    已复制到剪贴板!
                </div>
            </div>
        </div>
    </div>
    
    <!-- 通知弹窗 -->
    <div id="notification" class="fixed bottom-6 right-6 p-5 rounded-xl shadow-xl max-w-md hidden transform transition-all duration-300 translate-y-10 opacity-0 z-50">
        <div class="flex items-start space-x-4">
            <div id="notificationIcon" class="flex-shrink-0 w-6 h-6"></div>
            <div class="flex-1">
                <p id="notificationTitle" class="font-semibold text-lg"></p>
                <p id="notificationMessage" class="text-sm mt-1 opacity-90"></p>
            </div>
            <button id="closeNotification" class="flex-shrink-0 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- 文章编辑弹窗 -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 rounded-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden shadow-2xl">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-semibold">编辑文章内容</h3>
                <button id="closeEditModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-5 overflow-y-auto max-h-[calc(90vh-10rem)]">
                <textarea id="editArticleContent" class="apple-input w-full h-[60vh] font-mono text-sm"></textarea>
            </div>
            <div class="p-5 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-4">
                <button id="cancelEdit" class="px-6 py-3 rounded-xl border border-gray-300 dark:border-gray-600 text-base transition-colors hover:bg-gray-100 dark:hover:bg-gray-800">取消</button>
                <button id="saveEdit" class="apple-btn px-6 py-3 text-base rounded-xl ripple">保存更改</button>
            </div>
        </div>
    </div>
    
    <!-- 图片裁剪弹窗 -->
    <div id="cropperModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 rounded-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden shadow-2xl">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-semibold">裁剪图片</h3>
                <button id="closeCropperModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-5 bg-gray-100 dark:bg-gray-800 flex justify-center">
                <div id="cropperContainer" class="max-w-full">
                    <img id="cropperImage" src="" alt="待裁剪图片">
                </div>
            </div>
            <div class="p-5 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <div class="flex space-x-3">
                    <button id="rotateCCW" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                    </button>
                    <button id="rotateCW" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                        </svg>
                    </button>
                    <button id="resetCropper" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                </div>
                <div class="space-x-3">
                    <button id="cancelCrop" class="px-5 py-2 rounded-xl border border-gray-300 dark:border-gray-600 text-base hover:bg-gray-100 dark:hover:bg-gray-800">取消</button>
                    <button id="applyCrop" class="apple-btn px-5 py-2 text-base rounded-xl ripple">确认裁剪</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let references = [];
        let images = [];
        let generatedArticle = '';
        let currentCropperImage = null;
        let cropper = null;
        
        // 用于存储图片处理更新函数的引用
        let imageGalleryUpdater = null;
        
        // 工具函数
        function showNotification(type, title, message, duration = 5000) {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationMessage = document.getElementById('notificationMessage');
            const notificationIcon = document.getElementById('notificationIcon');
            
            // 设置图标和样式
            let iconSvg = '';
            if (type === 'success') {
                iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                notification.className = 'fixed bottom-6 right-6 p-5 rounded-xl shadow-xl max-w-md glass-effect border-l-4 border-green-500 hidden transform transition-all duration-300 translate-y-10 opacity-0 z-50';
            } else if (type === 'error') {
                iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                notification.className = 'fixed bottom-6 right-6 p-5 rounded-xl shadow-xl max-w-md glass-effect border-l-4 border-red-500 hidden transform transition-all duration-300 translate-y-10 opacity-0 z-50';
            } else if (type === 'warning') {
                iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>';
                notification.className = 'fixed bottom-6 right-6 p-5 rounded-xl shadow-xl max-w-md glass-effect border-l-4 border-yellow-500 hidden transform transition-all duration-300 translate-y-10 opacity-0 z-50';
            } else if (type === 'info') {
                iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                notification.className = 'fixed bottom-6 right-6 p-5 rounded-xl shadow-xl max-w-md glass-effect border-l-4 border-blue-500 hidden transform transition-all duration-300 translate-y-10 opacity-0 z-50';
            }
            
            notificationIcon.innerHTML = iconSvg;
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            // 显示通知
            notification.classList.remove('hidden');
            setTimeout(() => {
                notification.classList.remove('translate-y-10', 'opacity-0');
            }, 10);
            
            // 设置自动隐藏
            const hideTimeout = setTimeout(() => {
                hideNotification();
            }, duration);
            
            // 点击关闭按钮
            document.getElementById('closeNotification').onclick = () => {
                clearTimeout(hideTimeout);
                hideNotification();
            };
            
            function hideNotification() {
                notification.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 300);
            }
        }
        
        // 设置暗黑模式支持
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查本地存储并加载API配置
            loadApiConfig();
            initApiSettings();
            initReferenceHandling();
            initImageHandling();
            initArticleGeneration();
            initPreviewPanel();
            initCropperFunctionality();
            
            // 检查是否支持剪贴板
            if (!navigator.clipboard) {
                console.log('Clipboard API not available in this browser or context');
            }
        });
        
        // API设置相关
        function initApiSettings() {
            const modelSelect = document.getElementById('modelSelect');
            const customModelContainer = document.getElementById('customModelContainer');
            const testApiBtn = document.getElementById('testApi');
            const saveApiConfigBtn = document.getElementById('saveApiConfig');
            const apiConnectionInfo = document.getElementById('apiConnectionInfo');
            
            // 模型选择
            modelSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customModelContainer.classList.remove('hidden');
                } else {
                    customModelContainer.classList.add('hidden');
                }
            });
            
            // 测试API连接
            testApiBtn.addEventListener('click', async function() {
                const apiUrl = document.getElementById('apiUrl').value.trim();
                const apiKey = document.getElementById('apiKey').value.trim();
                
                if (!apiUrl || !apiKey) {
                    showNotification('warning', '参数缺失', '请填写API URL和密钥');
                    return;
                }
                
                // 禁用按钮并显示加载状态
                testApiBtn.disabled = true;
                const originalBtnText = testApiBtn.innerHTML;
                testApiBtn.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; margin-right: 8px;"></div> 测试中...';
                
                // 显示连接信息区域
                apiConnectionInfo.classList.remove('hidden');
                apiConnectionInfo.innerHTML = '<div class="flex items-center"><div class="loading-spinner mr-2"></div> <span>正在测试API连接...</span></div>';
                apiConnectionInfo.className = 'mt-4 p-4 rounded-lg text-sm bg-blue-50 text-blue-700 dark:bg-blue-900/20 dark:text-blue-300';
                
                try {
                    // 用POST方法替代GET，可能更好地兼容某些API端点
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15秒超时
                    
                    // 创建一个最小化的有效请求，仅检查连接性
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: modelSelect.value !== 'custom' ? modelSelect.value : document.getElementById('customModel').value,
                            messages: [{ role: "user", content: "Hello" }],
                            max_tokens: 5  // 使用最小的token数量
                        }),
                        signal: controller.signal
                    }).catch(error => {
                        clearTimeout(timeoutId);
                        throw error;
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        apiConnectionInfo.innerHTML = `
                            <div class="flex items-start">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500 mt-0.5 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                <div>
                                    <p class="font-medium">连接成功!</p>
                                    <p class="text-sm mt-1">API验证通过，您可以开始使用此配置生成文章。</p>
                                </div>
                            </div>
                        `;
                        apiConnectionInfo.className = 'mt-4 p-4 rounded-lg text-sm bg-green-50 text-green-700 dark:bg-green-900/20 dark:text-green-300';
                        showNotification('success', 'API测试成功', 'API连接和验证成功');
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMessage = errorData?.error?.message || `API返回错误状态码: ${response.status}`;
                        
                        apiConnectionInfo.innerHTML = `
                            <div class="flex items-start">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 mt-0.5 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <div>
                                    <p class="font-medium">API验证失败</p>
                                    <p class="text-sm mt-1">${errorMessage}</p>
                                </div>
                            </div>
                        `;
                        apiConnectionInfo.className = 'mt-4 p-4 rounded-lg text-sm bg-red-50 text-red-700 dark:bg-red-900/20 dark:text-red-300';
                        showNotification('error', 'API测试失败', errorMessage);
                    }
                } catch (error) {
                    // 处理各种类型的错误
                    let errorMessage = error.message;
                    let suggestion = '';
                    
                    if (error.name === 'AbortError') {
                        errorMessage = '连接超时，请检查API URL是否正确';
                        suggestion = '请确认API服务器是否可访问，或者可能存在网络问题';
                    } else if (error.message.includes('Failed to fetch')) {
                        errorMessage = '连接失败 (Failed to fetch)';
                        suggestion = `<p class="mb-2">这可能是浏览器的跨域保护导致的，而非您的API有问题。</p>
                            <p class="font-medium mt-1">解决方案：</p>
                            <ul class="list-disc pl-5 mt-1 space-y-1">
                                <li>如果您正在开发环境测试，可以添加CORS代理</li>
                                <li>使用浏览器扩展暂时禁用CORS (如"Allow CORS")</li>
                                <li>继续使用当前API配置，在实际生成时可能仍然工作</li>
                            </ul>`;
                    } else if (error.message.includes('NetworkError')) {
                        errorMessage = '网络错误';
                        suggestion = '请检查您的网络连接，或者API服务器可能不可用';
                    }
                    
                    apiConnectionInfo.innerHTML = `
                        <div class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 mt-0.5 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div>
                                <p class="font-medium">连接错误: ${errorMessage}</p>
                                ${suggestion ? `<div class="text-sm mt-2">${suggestion}</div>` : ''}
                            </div>
                        </div>
                    `;
                    apiConnectionInfo.className = 'mt-4 p-4 rounded-lg text-sm bg-red-50 text-red-700 dark:bg-red-900/20 dark:text-red-300';
                    
                    if (error.message.includes('Failed to fetch')) {
                        showNotification('warning', '连接错误', '浏览器CORS限制阻止了API请求。API可能是正确的，这只是浏览器安全限制。');
                    } else {
                        showNotification('error', '连接错误', errorMessage);
                    }
                } finally {
                    // 恢复按钮状态
                    testApiBtn.disabled = false;
                    testApiBtn.innerHTML = originalBtnText;
                }
            });
            
            // 保存API配置
            saveApiConfigBtn.addEventListener('click', function() {
                const apiUrl = document.getElementById('apiUrl').value.trim();
                const apiKey = document.getElementById('apiKey').value.trim();
                const modelValue = modelSelect.value;
                const customModel = document.getElementById('customModel').value.trim();
                
                if (!apiUrl || !apiKey) {
                    showNotification('error', '保存失败', '请填写API URL和密钥');
                    return;
                }
                
                const modelName = modelValue === 'custom' ? customModel : modelValue;
                
                if (modelValue === 'custom' && !customModel) {
                    showNotification('error', '保存失败', '请填写自定义模型名称');
                    return;
                }
                
                // 尝试保存配置
                try {
                    saveApiConfig(apiUrl, apiKey, modelName);
                    
                    // 显示保存成功的提示
                    apiConnectionInfo.innerHTML = `
                        <div class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500 mt-0.5 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            <div>
                                <p class="font-medium">配置已保存</p>
                                <p class="text-sm mt-1">API配置已成功保存到浏览器</p>
                            </div>
                        </div>
                    `;
                    apiConnectionInfo.className = 'mt-4 p-4 rounded-lg text-sm bg-green-50 text-green-700 dark:bg-green-900/20 dark:text-green-300';
                    apiConnectionInfo.classList.remove('hidden');
                    
                    // 自动隐藏提示
                    setTimeout(() => {
                        apiConnectionInfo.classList.add('hidden');
                    }, 3000);
                    
                    showNotification('success', '保存成功', 'API配置已保存');
                } catch (error) {
                    showNotification('error', '保存失败', error.message || '无法保存配置');
                }
            });
        }
        
        function saveApiConfig(apiUrl, apiKey, modelName) {
            try {
                localStorage.setItem('articleBot_apiUrl', apiUrl);
                localStorage.setItem('articleBot_apiKey', apiKey);
                localStorage.setItem('articleBot_modelName', modelName);
            } catch (e) {
                console.error('存储API配置失败:', e);
                throw new Error('无法保存到浏览器存储，可能是隐私模式或存储受限');
            }
        }
        
        function loadApiConfig() {
            try {
                const apiUrl = localStorage.getItem('articleBot_apiUrl');
                const apiKey = localStorage.getItem('articleBot_apiKey');
                const modelName = localStorage.getItem('articleBot_modelName');
                
                if (apiUrl) document.getElementById('apiUrl').value = apiUrl;
                if (apiKey) document.getElementById('apiKey').value = apiKey;
                
                if (modelName) {
                    const modelSelect = document.getElementById('modelSelect');
                    const predefinedModels = Array.from(modelSelect.options).map(opt => opt.value);
                    
                    if (predefinedModels.includes(modelName)) {
                        modelSelect.value = modelName;
                    } else {
                        modelSelect.value = 'custom';
                        document.getElementById('customModel').value = modelName;
                        document.getElementById('customModelContainer').classList.remove('hidden');
                    }
                }
            } catch (e) {
                console.error('加载API配置失败:', e);
            }
        }
        
        // 参考文章相关
        function initReferenceHandling() {
            // Tab切换
            const tabButtons = [
                { btn: document.getElementById('btnAddLink'), panel: document.getElementById('addLinkPanel') },
                { btn: document.getElementById('btnAddText'), panel: document.getElementById('addTextPanel') },
                { btn: document.getElementById('btnAddFile'), panel: document.getElementById('addFilePanel') }
            ];
            
            tabButtons.forEach(({btn, panel}, index) => {
                btn.addEventListener('click', () => {
                    // 隐藏所有面板，取消所有按钮激活状态
                    tabButtons.forEach(item => {
                        item.panel.classList.add('hidden');
                        item.btn.classList.remove('active');
                    });
                    // 显示当前面板，激活当前按钮
                    panel.classList.remove('hidden');
                    btn.classList.add('active');
                });
            });
            
            // 处理添加链接
            document.getElementById('addLinkBtn').addEventListener('click', function() {
                const linkInput = document.getElementById('referenceLink');
                const link = linkInput.value.trim();
                
                if (!link) {
                    showNotification('warning', '无效输入', '请输入有效的URL');
                    return;
                }
                
                try {
                    new URL(link); // 验证URL格式
                    
                    addReference({
                        type: 'link',
                        content: link,
                        title: `链接: ${link.substring(0, 30)}...`
                    });
                    
                    linkInput.value = '';
                    showNotification('success', '已添加参考', '链接已添加到参考列表');
                } catch (e) {
                    showNotification('error', '无效URL', '请输入有效的网址，包含http://或https://');
                }
            });
            
            // 处理添加文本
            document.getElementById('addTextBtn').addEventListener('click', function() {
                const textInput = document.getElementById('referenceText');
                const text = textInput.value.trim();
                
                if (!text) {
                    showNotification('warning', '无效输入', '请输入参考文本');
                    return;
                }
                
                addReference({
                    type: 'text',
                    content: text,
                    title: `文本: ${text.substring(0, 30)}${text.length > 30 ? '...' : ''}`
                });
                
                textInput.value = '';
                showNotification('success', '已添加参考', '文本已添加到参考列表');
            });
            
            // 处理文件上传
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('referenceFile');
            const fileInfo = document.getElementById('fileInfo');
            const addFileBtn = document.getElementById('addFileBtn');
            
            dropArea.addEventListener('click', () => fileInput.click());
            
            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.classList.add('active');
            });
            
            dropArea.addEventListener('dragleave', () => {
                dropArea.classList.remove('active');
            });
            
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.classList.remove('active');
                
                if (e.dataTransfer.files.length) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleFile(e.target.files[0]);
                }
            });
            
            function handleFile(file) {
                // 检查文件类型
                const validTypes = ['.txt', '.md', '.docx', '.pdf'];
                const fileExt = '.' + file.name.split('.').pop().toLowerCase();
                
                if (!validTypes.includes(fileExt)) {
                    fileInfo.innerHTML = `
                        <div class="flex items-center text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            不支持的文件类型: ${fileExt}
                        </div>
                    `;
                    fileInfo.classList.remove('hidden');
                    addFileBtn.classList.add('hidden');
                    showNotification('error', '不支持的文件类型', `仅支持 ${validTypes.join(', ')} 格式`);
                    return;
                }
                
                fileInfo.innerHTML = `
                    <div class="flex items-center text-green-600 dark:text-green-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        文件已选择: ${file.name} (${formatBytes(file.size)})
                    </div>
                `;
                fileInfo.classList.remove('hidden');
                addFileBtn.classList.remove('hidden');
                
                // 在添加文件按钮中处理文件
                addFileBtn.onclick = function() {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const content = e.target.result;
                        addReference({
                            type: 'file',
                            content: content,
                            title: `文件: ${file.name}`,
                            fileName: file.name
                        });
                        
                        fileInput.value = '';
                        fileInfo.classList.add('hidden');
                        addFileBtn.classList.add('hidden');
                        showNotification('success', '已添加参考', `文件 ${file.name} 已添加到参考列表`);
                    };
                    
                    reader.onerror = function() {
                        showNotification('error', '文件读取失败', '无法读取文件内容');
                    };
                    
                    if (fileExt === '.txt' || fileExt === '.md') {
                        reader.readAsText(file);
                    } else {
                        // 对于复杂格式，我们提示用户可能无法解析
                        reader.readAsArrayBuffer(file);
                        showNotification('warning', '复杂文件格式', '我们会尝试解析内容，但部分格式可能不完全支持');
                    }
                };
            }
            
            // 清空参考列表
            document.getElementById('clearReferences').addEventListener('click', function() {
                if (confirm('确定要清空所有参考资料吗？')) {
                    references = [];
                    updateReferenceList();
                }
            });
            
            function formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }
        }
        
        // 添加参考内容到列表
        function addReference(reference) {
            references.push(reference);
            updateReferenceList();
        }
        
        // 更新参考列表UI
        function updateReferenceList() {
            const referenceList = document.getElementById('referenceList');
            const referenceCount = document.getElementById('referenceCount');
            const clearReferences = document.getElementById('clearReferences');
            
            referenceCount.textContent = references.length;
            
            if (references.length === 0) {
                referenceList.innerHTML = '<div class="text-sm text-gray-500 dark:text-gray-400 italic text-center py-6">尚未添加参考内容</div>';
                clearReferences.classList.add('hidden');
                return;
            }
            
            clearReferences.classList.remove('hidden');
            referenceList.innerHTML = '';
            
            references.forEach((ref, index) => {
                const refItem = document.createElement('div');
                refItem.className = 'flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-750 transition-colors';
                
                let icon = '';
                if (ref.type === 'link') {
                    icon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>';
                } else if (ref.type === 'text') {
                    icon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>';
                } else if (ref.type === 'file') {
                    icon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-500 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>';
                }
                
                refItem.innerHTML = `
                    <div class="flex items-center text-sm truncate flex-1" style="max-width: 90%;">
                        ${icon}
                        <span class="truncate font-medium">${ref.title}</span>
                    </div>
                    <button class="delete-ref text-gray-400 hover:text-red-500 dark:text-gray-500 dark:hover:text-red-400 transition-colors ml-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                
                const deleteBtn = refItem.querySelector('.delete-ref');
                deleteBtn.addEventListener('click', () => {
                    references.splice(index, 1);
                    updateReferenceList();
                });
                
                referenceList.appendChild(refItem);
            });
        }
        
        // 图片处理相关
        function initImageHandling() {
            const imageDropArea = document.getElementById('imageDropArea');
            const imageGallery = document.getElementById('imageGallery');
            const imageList = document.getElementById('imageList');
            const imageCount = document.getElementById('imageCount');
            const clearImagesBtn = document.getElementById('clearImages');
            const imageInsertionOptions = document.getElementById('imageInsertionOptions');
            
            // 定义并赋值updateImageGallery函数，以便其他地方可以访问
            imageGalleryUpdater = function updateImageGallery() {
                imageCount.textContent = images.length;
                
                if (images.length > 0) {
                    imageGallery.classList.remove('hidden');
                    clearImagesBtn.classList.remove('hidden');
                    imageInsertionOptions.classList.remove('hidden');
                } else {
                    imageGallery.classList.add('hidden');
                    clearImagesBtn.classList.add('hidden');
                    imageInsertionOptions.classList.add('hidden');
                }
                
                // 更新图片列表
                imageList.innerHTML = '';
                
                images.forEach((img, index) => {
                    const imgElement = document.createElement('div');
                    imgElement.className = 'relative group';
                    imgElement.innerHTML = `
                        <img src="${img.src}" alt="图片 ${index + 1}" class="image-preview border border-gray-200 dark:border-gray-700 cursor-pointer" title="点击裁剪">
                        <div class="absolute top-0 right-0 flex space-x-1 p-1.5 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="crop-image p-1 bg-blue-500 hover:bg-blue-600 text-white rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                            </button>
                            <button class="delete-image p-1 bg-red-500 hover:bg-red-600 text-white rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    `;
                    
                    // 删除图片按钮
                    const deleteBtn = imgElement.querySelector('.delete-image');
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        images.splice(index, 1);
                        imageGalleryUpdater(); // 使用函数引用
                    });
                    
                    // 裁剪图片按钮
                    const cropBtn = imgElement.querySelector('.crop-image');
                    cropBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        openImageCropper(img, index);
                    });
                    
                    // 点击图片也打开裁剪
                    const imgPreview = imgElement.querySelector('img');
                    imgPreview.addEventListener('click', function() {
                        openImageCropper(img, index);
                    });
                    
                    imageList.appendChild(imgElement);
                });
                
                // 处理自定义位置
                updateCustomPositions();
            };
            
            // 点击图片区域触发粘贴
            imageDropArea.addEventListener('click', function() {
                // 显示提示文字
                const originalContent = imageDropArea.innerHTML;
                imageDropArea.innerHTML = `
                    <div class="text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-blue-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        <p class="text-lg font-medium mb-1">按Ctrl+V (或Cmd+V) 粘贴图片</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">也可以点击选择图片文件</p>
                    </div>
                `;
                
                // 创建隐藏的文件输入
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.style.display = 'none';
                fileInput.multiple = true;
                document.body.appendChild(fileInput);
                
                fileInput.addEventListener('change', function() {
                    if (this.files.length) {
                        handleImageDrop(this.files);
                    }
                    document.body.removeChild(fileInput);
                    imageDropArea.innerHTML = originalContent;
                });
                
                // 打开文件选择框
                fileInput.click();
                
                // 5秒后恢复原始内容
                setTimeout(() => {
                    if (document.body.contains(fileInput)) {
                        document.body.removeChild(fileInput);
                    }
                    imageDropArea.innerHTML = originalContent;
                }, 5000);
            });
            
            // 拖放处理
            imageDropArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                imageDropArea.classList.add('active');
            });
            
            imageDropArea.addEventListener('dragleave', function() {
                imageDropArea.classList.remove('active');
            });
            
            imageDropArea.addEventListener('drop', function(e) {
                e.preventDefault();
                imageDropArea.classList.remove('active');
                
                // 处理拖放的文件
                if (e.dataTransfer.files.length) {
                    handleImageDrop(e.dataTransfer.files);
                }
            });
            
            // 监听粘贴事件
            document.addEventListener('paste', function(e) {
                const clipboardItems = e.clipboardData.items;
                const images = [];
                
                for (let i = 0; i < clipboardItems.length; i++) {
                    if (clipboardItems[i].type.indexOf('image') !== -1) {
                        const blob = clipboardItems[i].getAsFile();
                        images.push(blob);
                    }
                }
                
                if (images.length > 0) {
                    handleImageDrop(images);
                }
            });
            
            // 处理图片文件
            function handleImageDrop(files) {
                let validImages = 0;
                let processedCount = 0;
                
                // 显示加载指示器
                imageDropArea.innerHTML = `
                    <div class="text-center">
                        <div class="loading-spinner mx-auto mb-3"></div>
                        <p>处理图片中...</p>
                    </div>
                `;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // 检查是否是图片
                    if (!file.type.match('image.*')) {
                        processedCount++;
                        if (processedCount === files.length) {
                            finishProcessing();
                        }
                        continue;
                    }
                    
                    validImages++;
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const imageData = {
                            id: 'img_' + Date.now() + '_' + Math.random().toString(36).substring(2),
                            src: e.target.result,
                            name: file.name || `image_${images.length + 1}.png`,
                            file: file
                        };
                        
                        images.push(imageData);
                        processedCount++;
                        
                        if (processedCount === files.length) {
                            finishProcessing();
                        }
                    };
                    
                    reader.onerror = function() {
                        processedCount++;
                        if (processedCount === files.length) {
                            finishProcessing();
                        }
                    };
                    
                    reader.readAsDataURL(file);
                }
                
                // 如果没有有效图片，立即恢复原始UI
                if (validImages === 0) {
                    finishProcessing();
                }
                
                function finishProcessing() {
                    // 恢复原始UI
                    imageDropArea.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <p class="text-base font-medium mb-1 text-center">拖放图片或粘贴截图到此处</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 text-center">支持 JPG, PNG, GIF, WEBP</p>
                    `;
                    
                    // 更新图片库显示
                    imageGalleryUpdater(); // 使用函数引用更新
                    
                    // 显示通知
                    if (validImages > 0) {
                        showNotification('success', '添加成功', `已添加 ${validImages} 张图片`);
                    }
                }
            }
            
            // 处理图片分布方式
            const imageDistribution = document.getElementById('imageDistribution');
            const customPositionContainer = document.getElementById('customPositionContainer');
            
            imageDistribution.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customPositionContainer.classList.remove('hidden');
                } else {
                    customPositionContainer.classList.add('hidden');
                }
            });
            
            // 更新自定义位置UI
            function updateCustomPositions() {
                const customImagePositions = document.getElementById('customImagePositions');
                
                if (imageDistribution.value === 'custom') {
                    customPositionContainer.classList.remove('hidden');
                    customImagePositions.innerHTML = '';
                    
                    images.forEach((img, index) => {
                        const posElement = document.createElement('div');
                        posElement.className = 'flex flex-col items-center bg-white dark:bg-gray-800 p-2 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700';
                        posElement.setAttribute('draggable', 'true');
                        posElement.setAttribute('data-index', index);
                        
                        posElement.innerHTML = `
                            <img src="${img.src}" alt="图片 ${index + 1}" class="w-16 h-16 object-cover rounded-lg mb-1">
                            <span class="text-xs font-medium">${index + 1}</span>
                        `;
                        
                        // 拖放排序功能
                        posElement.addEventListener('dragstart', function(e) {
                            e.dataTransfer.setData('text/plain', index);
                            this.classList.add('opacity-50');
                        });
                        
                        posElement.addEventListener('dragend', function() {
                            this.classList.remove('opacity-50');
                        });
                        
                        posElement.addEventListener('dragover', function(e) {
                            e.preventDefault();
                            this.classList.add('bg-blue-50', 'dark:bg-blue-900/20');
                        });
                        
                        posElement.addEventListener('dragleave', function() {
                            this.classList.remove('bg-blue-50', 'dark:bg-blue-900/20');
                        });
                        
                        posElement.addEventListener('drop', function(e) {
                            e.preventDefault();
                            this.classList.remove('bg-blue-50', 'dark:bg-blue-900/20');
                            const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                            const toIndex = parseInt(this.getAttribute('data-index'));
                            
                            if (fromIndex !== toIndex) {
                                const temp = images[fromIndex];
                                images[fromIndex] = images[toIndex];
                                images[toIndex] = temp;
                                imageGalleryUpdater(); // 使用函数引用
                            }
                        });
                        
                        customImagePositions.appendChild(posElement);
                    });
                } else {
                    customPositionContainer.classList.add('hidden');
                }
            }
            
            // 清空所有图片
            clearImagesBtn.addEventListener('click', function() {
                if (confirm('确定要清空所有图片吗？')) {
                    images = [];
                    imageGalleryUpdater(); // 使用函数引用
                }
            });
        }
        
        // 图片裁剪功能
        function initCropperFunctionality() {
            const cropperModal = document.getElementById('cropperModal');
            const closeCropperModal = document.getElementById('closeCropperModal');
            const cancelCrop = document.getElementById('cancelCrop');
            const applyCrop = document.getElementById('applyCrop');
            const rotateCW = document.getElementById('rotateCW');
            const rotateCCW = document.getElementById('rotateCCW');
            const resetCropper = document.getElementById('resetCropper');
            
            // 关闭裁剪窗口
            function closeCropperModalHandler() {
                cropperModal.classList.add('hidden');
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            }
            
            closeCropperModal.addEventListener('click', closeCropperModalHandler);
            cancelCrop.addEventListener('click', closeCropperModalHandler);
            
            // 应用裁剪
            applyCrop.addEventListener('click', function() {
                if (!cropper || !currentCropperImage) return;
                
                try {
                    const croppedCanvas = cropper.getCroppedCanvas({
                        imageSmoothingEnabled: true,
                        imageSmoothingQuality: 'high',
                    });
                    
                    if (!croppedCanvas) {
                        showNotification('error', '裁剪失败', '无法获取裁剪后的图像');
                        return;
                    }
                    
                    // 转换为Base64
                    const croppedImageData = croppedCanvas.toDataURL(currentCropperImage.file.type || 'image/png');
                    
                    // 更新图片数据
                    const imageIndex = images.findIndex(img => img.id === currentCropperImage.id);
                    if (imageIndex !== -1) {
                        images[imageIndex].src = croppedImageData;
                        imageGalleryUpdater(); // 使用全局可访问的函数引用
                        showNotification('success', '裁剪成功', '图片已成功裁剪');
                    }
                    
                    closeCropperModalHandler();
                } catch (error) {
                    console.error('裁剪错误:', error);
                    showNotification('error', '裁剪失败', error.message || '处理图像时出错');
                }
            });
            
            // 旋转控制
            rotateCW.addEventListener('click', function() {
                if (cropper) cropper.rotate(90);
            });
            
            rotateCCW.addEventListener('click', function() {
                if (cropper) cropper.rotate(-90);
            });
            
            // 重置裁剪
            resetCropper.addEventListener('click', function() {
                if (cropper) cropper.reset();
            });
        }
        
        // 打开图片裁剪器
        function openImageCropper(imageData, index) {
            const cropperModal = document.getElementById('cropperModal');
            const cropperImage = document.getElementById('cropperImage');
            
            // 保存当前裁剪的图片引用
            currentCropperImage = imageData;
            
            // 设置图片源
            cropperImage.src = imageData.src;
            
            // 显示裁剪模态框
            cropperModal.classList.remove('hidden');
            
            // 销毁旧的裁剪器实例
            if (cropper) {
                cropper.destroy();
            }
            
            // 初始化裁剪器
            cropper = new Cropper(cropperImage, {
                viewMode: 1, // 限制裁剪框不能超出图片的范围
                dragMode: 'move', // 可以移动图片
                aspectRatio: NaN, // 自由比例
                autoCropArea: 0.8, // 初始裁剪区域大小
                restore: false,
                guides: true,
                center: true,
                highlight: false,
                cropBoxMovable: true,
                cropBoxResizable: true,
                toggleDragModeOnDblclick: true,
            });
        }
        
        // 预览面板
        function initPreviewPanel() {
            const previewPanelContainer = document.getElementById('previewPanelContainer');
            const previewHandle = document.getElementById('previewHandle');
            const closePreviewBtn = document.getElementById('closePreviewBtn');
            const previewArticleBtn = document.getElementById('previewArticleBtn');
            const previewTabBtn = document.getElementById('previewTabBtn');
            const markdownTabBtn = document.getElementById('markdownTabBtn');
            const previewContent = document.getElementById('previewContent');
            const markdownContent = document.getElementById('markdownContent');
            const copyArticleBtn = document.getElementById('copyArticleBtn');
            const editArticleBtn = document.getElementById('editArticleBtn');
            const openEditorBtn = document.getElementById('openEditorBtn');
            
            // 预览面板切换
            function togglePreviewPanel() {
                previewPanelContainer.classList.toggle('show');
            }
            
            previewHandle.addEventListener('click', togglePreviewPanel);
            closePreviewBtn.addEventListener('click', togglePreviewPanel);
            
            // 预览按钮点击
            previewArticleBtn.addEventListener('click', function() {
                if (generatedArticle) {
                    previewPanelContainer.classList.add('show');
                } else {
                    showNotification('warning', '无内容', '请先生成文章');
                }
            });
            
            // 标签切换
            previewTabBtn.addEventListener('click', function() {
                previewTabBtn.classList.add('active');
                markdownTabBtn.classList.remove('active');
                previewContent.classList.remove('hidden');
                markdownContent.classList.add('hidden');
            });
            
            markdownTabBtn.addEventListener('click', function() {
                markdownTabBtn.classList.add('active');
                previewTabBtn.classList.remove('active');
                markdownContent.classList.remove('hidden');
                previewContent.classList.add('hidden');
            });
            
            // 复制文章
            copyArticleBtn.addEventListener('click', function() {
                const markdownEditor = document.getElementById('markdownEditor');
                const copyStatus = document.getElementById('copyStatus');
                
                if (markdownEditor.value) {
                    navigator.clipboard.writeText(markdownEditor.value)
                        .then(() => {
                            copyStatus.classList.remove('hidden');
                            setTimeout(() => {
                                copyStatus.classList.add('hidden');
                            }, 2000);
                        })
                        .catch(err => {
                            showNotification('error', '复制失败', '无法访问剪贴板: ' + err.message);
                        });
                } else {
                    showNotification('warning', '无内容', '没有可复制的文章内容');
                }
            });
            
            // 编辑文章
            const editModal = document.getElementById('editModal');
            const editArticleContent = document.getElementById('editArticleContent');
            const closeEditModal = document.getElementById('closeEditModal');
            const cancelEdit = document.getElementById('cancelEdit');
            const saveEdit = document.getElementById('saveEdit');
            
            editArticleBtn.addEventListener('click', function() {
                if (generatedArticle) {
                    editArticleContent.value = generatedArticle;
                    editModal.classList.remove('hidden');
                } else {
                    showNotification('warning', '无内容', '没有可编辑的文章内容');
                }
            });
            
            function closeEditModalHandler() {
                editModal.classList.add('hidden');
            }
            
            closeEditModal.addEventListener('click', closeEditModalHandler);
            cancelEdit.addEventListener('click', closeEditModalHandler);
            
            saveEdit.addEventListener('click', function() {
                generatedArticle = editArticleContent.value;
                updateArticlePreview(generatedArticle);
                closeEditModalHandler();
                showNotification('success', '保存成功', '文章内容已更新');
            });
            
            // 在外部编辑器中打开
            openEditorBtn.addEventListener('click', function() {
                if (generatedArticle) {
                    // 打开markdown.com.cn编辑器，并将内容传递过去
                    const editorUrl = 'https://markdown.com.cn/editor/';
                    const newWindow = window.open(editorUrl, '_blank');
                    
                    if (newWindow) {
                        // 尝试将内容发送到新窗口 (注意：由于跨域限制，这可能不会成功)
                        showNotification('info', '使用方法', '请在新窗口打开后，手动粘贴文章内容');
                        
                        // 自动复制内容到剪贴板
                        navigator.clipboard.writeText(generatedArticle)
                            .then(() => {
                                showNotification('success', '已复制到剪贴板', '文章内容已复制，可直接粘贴到编辑器');
                            })
                            .catch(err => {
                                showNotification('error', '复制失败', '无法访问剪贴板: ' + err.message);
                            });
                    } else {
                        showNotification('error', '打开失败', '无法打开新窗口，请检查浏览器设置');
                    }
                } else {
                    showNotification('warning', '无内容', '没有可编辑的文章内容');
                }
            });
        }
        
        // 文章生成相关
        function initArticleGeneration() {
            const contentLength = document.getElementById('contentLength');
            const customLengthContainer = document.getElementById('customLengthContainer');
            const generateArticleBtn = document.getElementById('generateArticleBtn');
            const generationStatus = document.getElementById('generationStatus');
            
            // 内容长度选择
            contentLength.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customLengthContainer.classList.remove('hidden');
                } else {
                    customLengthContainer.classList.add('hidden');
                }
            });
            
            // 点击生成文章按钮
            generateArticleBtn.addEventListener('click', async function() {
                // 验证必要的输入
                const apiUrl = document.getElementById('apiUrl').value.trim();
                const apiKey = document.getElementById('apiKey').value.trim();
                const articleTitle = document.getElementById('articleTitle').value.trim();
                
                if (!apiUrl || !apiKey) {
                    showNotification('error', '配置缺失', '请先配置API URL和密钥');
                    return;
                }
                
                if (!articleTitle) {
                    showNotification('warning', '标题缺失', '请至少输入文章标题');
                    return;
                }
                
                // 获取其他参数
                const modelSelect = document.getElementById('modelSelect');
                let modelName = modelSelect.value;
                
                if (modelName === 'custom') {
                    const customModel = document.getElementById('customModel').value.trim();
                    if (!customModel) {
                        showNotification('error', '模型名称缺失', '请输入自定义模型名称');
                        return;
                    }
                    modelName = customModel;
                }
                
                let contentLengthValue = contentLength.value;
                let wordCount;
                
                if (contentLengthValue === 'short') {
                    wordCount = 800;
                } else if (contentLengthValue === 'medium') {
                    wordCount = 1500;
                } else if (contentLengthValue === 'long') {
                    wordCount = 3000;
                } else if (contentLengthValue === 'custom') {
                    wordCount = parseInt(document.getElementById('customLength').value);
                    if (isNaN(wordCount) || wordCount <= 0) {
                        showNotification('error', '字数无效', '请输入有效的字数');
                        return;
                    }
                }
                
                const promptInput = document.getElementById('promptInput').value.trim();
                
                // 显示生成状态
                generateArticleBtn.disabled = true;
                generationStatus.classList.remove('hidden');
                document.getElementById('tokenCount').textContent = '计算中...';
                
                // 构建提示词
                let prompt = createPrompt(
                    articleTitle,
                    wordCount,
                    promptInput
                );
                
                try {
                    // 调用API生成文章
                    const article = await generateArticle(
                        apiUrl,
                        apiKey,
                        modelName,
                        prompt
                    );
                    
                    // 文章生成完成，更新预览
                    generatedArticle = article;
                    updateArticlePreview(article);
                    
                    // 自动打开预览面板
                    document.getElementById('previewPanelContainer').classList.add('show');
                    
                    showNotification('success', '生成成功', '文章已生成，可以预览或编辑');
                } catch (error) {
                    showNotification('error', '生成失败', error.message);
                    console.error('文章生成错误:', error);
                } finally {
                    // 恢复按钮状态
                    generateArticleBtn.disabled = false;
                    generationStatus.classList.add('hidden');
                }
            });
            
            // 创建提示词
            function createPrompt(title, wordCount, additionalPrompt) {
                let prompt = `请帮我写一篇标题为《${title}》的文章，字数大约${wordCount}字左右。`;
                
                if (additionalPrompt) {
                    prompt += `\n\n${additionalPrompt}`;
                }
                
                // 添加参考资料
                if (references.length > 0) {
                    prompt += "\n\n参考资料：\n";
                    
                    references.forEach((ref, index) => {
                        prompt += `参考资料${index + 1}（${ref.type}）：\n${ref.content}\n\n`;
                    });
                }
                
                // 添加关于图片插入的说明
                if (images.length > 0) {
                    const distribution = document.getElementById('imageDistribution').value;
                    prompt += `\n文章中需要插入${images.length}张图片，插入方式为"${getDistributionName(distribution)}"。请在文章中标注[插入图片1]、[插入图片2]等位置，用于后续插入图片。`;
                }
                
                // 添加输出格式要求
                prompt += "\n\n请使用Markdown格式输出，确保文章格式美观、结构清晰，适合微信公众号发布。不需要包含Markdown代码块标记。";
                
                return prompt;
            }
            
            function getDistributionName(distribution) {
                const distMap = {
                    'balanced': '均衡分布在整篇文章中',
                    'top-heavy': '集中在文章前部',
                    'bottom-heavy': '集中在文章后部',
                    'custom': '按自定义位置'
                };
                
                return distMap[distribution] || '均衡分布';
            }
            
            // 生成文章API调用
            async function generateArticle(apiUrl, apiKey, modelName, prompt) {
                document.getElementById('statusText').textContent = '正在生成文章...';
                
                try {
                    // 改进的API请求，更好地处理各种错误
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 60000); // 60秒超时
                    
                    // 使用POST方法，这更常见于API调用
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: modelName,
                            messages: [
                                {
                                    role: "user",
                                    content: prompt
                                }
                            ],
                            max_tokens: 4000,
                            temperature: 0.7
                        }),
                        signal: controller.signal
                    }).catch(error => {
                        clearTimeout(timeoutId);
                        throw error;
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        let errorMessage = `API错误: ${response.status} ${response.statusText}`;
                        try {
                            const errorData = await response.json();
                            if (errorData.error && errorData.error.message) {
                                errorMessage = errorData.error.message;
                            }
                        } catch (e) {
                            // 无法解析JSON
                        }
                        throw new Error(errorMessage);
                    }
                    
                    const data = await response.json();
                    
                    // 解析结果 (适配不同API格式)
                    let content = '';
                    if (data.choices && data.choices.length > 0) {
                        // OpenAI格式
                        content = data.choices[0].message.content;
                        
                        // 计算token使用情况
                        if (data.usage) {
                            const { prompt_tokens, completion_tokens, total_tokens } = data.usage;
                            document.getElementById('tokenCount').textContent = 
                                `Tokens: ${prompt_tokens} (提示) + ${completion_tokens} (生成) = ${total_tokens} (总计)`;
                        }
                    } else if (data.content) {
                        // 自定义格式
                        content = data.content;
                    } else {
                        throw new Error('API返回格式不正确，无法解析结果');
                    }
                    
                    document.getElementById('statusText').textContent = '处理生成内容...';
                    
                    // 插入图片
                    if (images.length > 0) {
                        content = insertImages(content);
                    }
                    
                    return content;
                } catch (error) {
                    console.error('API调用错误:', error);
                    
                    // 提供更友好的错误消息
                    if (error.name === 'AbortError') {
                        throw new Error('请求超时，API服务器响应时间过长');
                    } else if (error.message.includes('Failed to fetch')) {
                        throw new Error('网络请求失败，请检查网络连接或API URL。如果您确认API URL正确，这可能是浏览器CORS限制造成的，请参考解决方案。');
                    } else {
                        throw error;
                    }
                }
            }
            
            // 插入图片到文章
            function insertImages(content) {
                const distribution = document.getElementById('imageDistribution').value;
                
                // 如果文章中已有图片插入标记，直接替换
                if (content.includes('[插入图片')) {
                    for (let i = 0; i < images.length; i++) {
                        const placeholder = `[插入图片${i+1}]`;
                        const imageMarkdown = `\n\n![图片${i+1}](${images[i].src})\n\n`;
                        
                        // 替换第一次出现的标记
                        content = content.replace(placeholder, imageMarkdown);
                    }
                    
                    // 如果仍有未替换的标记（图片数量少于标记），删除多余标记
                    for (let i = images.length + 1; i <= 10; i++) {
                        content = content.replace(`[插入图片${i}]`, '');
                    }
                    
                    return content;
                }
                
                // 如果没有标记，根据分布策略插入图片
                const paragraphs = content.split('\n\n');
                
                if (paragraphs.length <= 1) {
                    // 如果无法分段，在文末添加图片
                    for (let i = 0; i < images.length; i++) {
                        content += `\n\n![图片${i+1}](${images[i].src})`;
                    }
                    return content;
                }
                
                const newParagraphs = [...paragraphs];
                
                // 根据不同的分布策略插入图片
                if (distribution === 'balanced') {
                    // 均匀分布图片
                    const step = Math.max(1, Math.floor(paragraphs.length / (images.length + 1)));
                    for (let i = 0; i < images.length; i++) {
                        const position = Math.min((i + 1) * step, paragraphs.length - 1);
                        newParagraphs.splice(position + i, 0, `![图片${i+1}](${images[i].src})`);
                    }
                } else if (distribution === 'top-heavy') {
                    // 前部集中
                    const totalPositions = Math.min(paragraphs.length, images.length * 2);
                    for (let i = 0; i < images.length; i++) {
                        const position = Math.floor((i + 1) * totalPositions / (images.length + 1));
                        newParagraphs.splice(position + i, 0, `![图片${i+1}](${images[i].src})`);
                    }
                } else if (distribution === 'bottom-heavy') {
                    // 后部集中
                    const startPos = Math.floor(paragraphs.length / 2);
                    const availablePositions = paragraphs.length - startPos;
                    for (let i = 0; i < images.length; i++) {
                        const offset = Math.floor((i + 1) * availablePositions / (images.length + 1));
                        const position = startPos + offset;
                        newParagraphs.splice(position + i, 0, `![图片${i+1}](${images[i].src})`);
                    }
                } else if (distribution === 'custom') {
                    // 使用自定义顺序 (这里按照界面上图片的当前顺序)
                    for (let i = 0; i < images.length; i++) {
                        // 根据自定义位置计算插入点
                        // 这里简单地将文章分为等长的段落
                        const position = Math.floor((i + 1) * paragraphs.length / (images.length + 1));
                        newParagraphs.splice(position + i, 0, `![图片${i+1}](${images[i].src})`);
                    }
                }
                
                return newParagraphs.join('\n\n');
            }
        }
        
        // 更新文章预览
        function updateArticlePreview(markdown) {
            const articlePreview = document.getElementById('articlePreview');
            const markdownEditor = document.getElementById('markdownEditor');
            
            // 设置Markdown编辑器内容
            markdownEditor.value = markdown;
            
            // 更新预览
            try {
                // 替换图片链接为实际HTML
                const htmlContent = marked.parse(markdown);
                articlePreview.innerHTML = htmlContent;
            } catch (error) {
                console.error('解析Markdown错误:', error);
                articlePreview.innerHTML = '<div class="text-red-500">Markdown渲染错误: ' + error.message + '</div>';
            }
        }
        
        // 如果Poe API可用，定义handler
        if (window.Poe) {
            // 注册处理生成结果的handler
            window.Poe.registerHandler("article-generation-handler", function(result, context) {
                const msg = result.responses[0];
                
                if (msg.status === "error") {
                    document.getElementById('statusText').textContent = "错误: " + msg.statusText;
                    document.getElementById('generateArticleBtn').disabled = false;
                    showNotification('error', '生成失败', msg.statusText || '大模型返回错误');
                } else if (msg.status === "incomplete") {
                    document.getElementById('statusText').textContent = "正在生成...";
                } else if (msg.status === "complete") {
                    document.getElementById('statusText').textContent = "生成完成!";
                    
                    // 处理响应
                    let content = msg.content;
                    
                    // 插入图片
                    if (images.length > 0) {
                        content = insertImages(content, context.imageDistribution);
                    }
                    
                    // 更新预览
                    generatedArticle = content;
                    updateArticlePreview(content);
                    
                    // 恢复状态
                    document.getElementById('generateArticleBtn').disabled = false;
                    document.getElementById('generationStatus').classList.add('hidden');
                    
                    // 自动打开预览面板
                    document.getElementById('previewPanelContainer').classList.add('show');
                    
                    showNotification('success', '生成成功', '文章已生成，可以预览或编辑');
                }
            });
        }
    </script>


</body></html>
